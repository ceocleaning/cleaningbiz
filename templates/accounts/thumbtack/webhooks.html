{% extends 'common/base.html' %} {% load static %} {% block title %}Thumbtack
Webhooks - {{ block.super }}{% endblock %} {% block extra_css %}
<style>
  .webhook-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .webhook-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .webhook-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
  }

  .webhook-header p {
    margin: 0;
    opacity: 0.9;
  }

  .webhook-card {
    background: white;
    border-radius: 10px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .webhook-card h2 {
    margin-top: 0;
    color: #333;
    font-size: 1.5rem;
    border-bottom: 2px solid #667eea;
    padding-bottom: 0.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #555;
  }

  .form-group input[type="text"],
  .form-group input[type="password"],
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
  }

  .form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #666;
    font-size: 0.875rem;
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .btn-danger:hover {
    background: #c0392b;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-secondary:hover {
    background: #7f8c8d;
  }

  .webhook-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .webhook-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s;
  }

  .webhook-item:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .webhook-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .webhook-id {
    font-weight: 600;
    color: #667eea;
  }

  .webhook-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .status-enabled {
    background: #d4edda;
    color: #155724;
  }

  .status-disabled {
    background: #f8d7da;
    color: #721c24;
  }

  .webhook-details {
    margin-bottom: 1rem;
  }

  .webhook-details p {
    margin: 0.5rem 0;
    color: #555;
  }

  .webhook-actions {
    display: flex;
    gap: 0.5rem;
  }

  .webhook-actions button {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .alert {
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #999;
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
</style>
{% endblock %} {% block content %}
<div class="webhook-container">
  <div class="webhook-header">
    <h1>Thumbtack Webhooks</h1>
    <p>
      Manage webhook notifications for real-time event updates from Thumbtack
    </p>
  </div>

  <!-- Alert Messages -->
  <div id="alertContainer"></div>

  <!-- Create Webhook Form -->
  <div class="webhook-card">
    <h2>Create New Webhook</h2>
    <form id="createWebhookForm">
      {% csrf_token %}
      <div class="form-group">
        <label for="webhookURL">Webhook URL *</label>
        <input
          type="text"
          id="webhookURL"
          name="webhookURL"
          placeholder="https://yourdomain.com/accounts/thumbtack/webhook/receiver/"
          required
        />
        <small>Must be a valid HTTPS URL that is publicly accessible</small>
      </div>

      <div class="form-group">
        <label for="eventTypes">Event Types *</label>
        <select id="eventTypes" name="eventTypes" required>
          <option value="MessageCreatedV4">
            MessageCreatedV4 - New message notifications
          </option>
        </select>
        <small>Select the type of events you want to receive</small>
      </div>

      <div class="form-group checkbox-group">
        <input type="checkbox" id="enabled" name="enabled" checked />
        <label for="enabled" style="margin-bottom: 0"
          >Enable webhook immediately</label
        >
      </div>

      <div class="form-group">
        <label for="authUsername">Authentication Username (Optional)</label>
        <input
          type="text"
          id="authUsername"
          name="authUsername"
          placeholder="webhook_user"
        />
        <small
          >Username for basic authentication (recommended for security)</small
        >
      </div>

      <div class="form-group">
        <label for="authPassword">Authentication Password (Optional)</label>
        <input
          type="password"
          id="authPassword"
          name="authPassword"
          placeholder="Enter a strong password"
        />
        <small>Password for basic authentication</small>
      </div>

      <button type="submit" class="btn btn-primary">Create Webhook</button>
    </form>
  </div>

  <!-- Existing Webhooks List -->
  <div class="webhook-card">
    <h2>Your Webhooks</h2>
    <div id="webhookListContainer">
      <div class="loading">
        <p>Loading webhooks...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie("csrftoken");

  // Show alert message
  function showAlert(message, type = "info") {
    const alertContainer = document.getElementById("alertContainer");
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertContainer.appendChild(alertDiv);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      alertDiv.remove();
    }, 5000);
  }

  // Load webhooks
  async function loadWebhooks() {
    const container = document.getElementById("webhookListContainer");

    try {
      const response = await fetch("/accounts/thumbtack/webhooks/list/", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        const data = await response.json();
        const webhooks = data.webhooks || [];

        if (webhooks.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-webhook"></i>
                        <p>No webhooks configured yet</p>
                        <p>Create your first webhook using the form above</p>
                    </div>
                `;
        } else {
          const webhookList = webhooks
            .map(
              (webhook) => `
                    <div class="webhook-item">
                        <div class="webhook-item-header">
                            <span class="webhook-id">ID: ${
                              webhook.webhookID
                            }</span>
                            <span class="webhook-status ${
                              webhook.enabled
                                ? "status-enabled"
                                : "status-disabled"
                            }">
                                ${webhook.enabled ? "Enabled" : "Disabled"}
                            </span>
                        </div>
                        <div class="webhook-details">
                            <p><strong>URL:</strong> ${webhook.webhookURL}</p>
                            <p><strong>Event Types:</strong> ${webhook.eventTypes.join(
                              ", "
                            )}</p>
                            <p><strong>Auth Type:</strong> ${
                              webhook.authType
                            }</p>
                        </div>
                        <div class="webhook-actions">
                            <button 
                                class="btn btn-secondary" 
                                onclick="toggleWebhook('${
                                  webhook.webhookID
                                }', ${!webhook.enabled})"
                            >
                                ${webhook.enabled ? "Disable" : "Enable"}
                            </button>
                            <button 
                                class="btn btn-danger" 
                                onclick="deleteWebhook('${webhook.webhookID}')"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                `
            )
            .join("");

          container.innerHTML = `<ul class="webhook-list">${webhookList}</ul>`;
        }
      } else {
        const error = await response.json();
        container.innerHTML = `
                <div class="alert alert-error">
                    Failed to load webhooks: ${error.error || "Unknown error"}
                </div>
            `;
      }
    } catch (error) {
      container.innerHTML = `
            <div class="alert alert-error">
                Error loading webhooks: ${error.message}
            </div>
        `;
    }
  }

  // Create webhook
  document
    .getElementById("createWebhookForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = {
        webhookURL: document.getElementById("webhookURL").value,
        eventTypes: [document.getElementById("eventTypes").value],
        enabled: document.getElementById("enabled").checked,
      };

      const username = document.getElementById("authUsername").value;
      const password = document.getElementById("authPassword").value;

      if (username && password) {
        formData.auth = {
          username: username,
          password: password,
        };
      }

      try {
        const response = await fetch("/accounts/thumbtack/webhooks/create/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify(formData),
        });

        if (response.status === 201) {
          const data = await response.json();
          showAlert("Webhook created successfully!", "success");
          document.getElementById("createWebhookForm").reset();
          loadWebhooks();
        } else {
          const error = await response.json();
          showAlert(
            `Failed to create webhook: ${error.error || "Unknown error"}`,
            "error"
          );
        }
      } catch (error) {
        showAlert(`Error: ${error.message}`, "error");
      }
    });

  // Toggle webhook enabled status
  async function toggleWebhook(webhookId, enabled) {
    try {
      const response = await fetch(
        `/accounts/thumbtack/webhooks/${webhookId}/update/`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({ enabled: enabled }),
        }
      );

      if (response.ok) {
        showAlert(
          `Webhook ${enabled ? "enabled" : "disabled"} successfully!`,
          "success"
        );
        loadWebhooks();
      } else {
        const error = await response.json();
        showAlert(
          `Failed to update webhook: ${error.error || "Unknown error"}`,
          "error"
        );
      }
    } catch (error) {
      showAlert(`Error: ${error.message}`, "error");
    }
  }

  // Delete webhook
  async function deleteWebhook(webhookId) {
    if (!confirm("Are you sure you want to delete this webhook?")) {
      return;
    }

    try {
      const response = await fetch(
        `/accounts/thumbtack/webhooks/${webhookId}/delete/`,
        {
          method: "DELETE",
          headers: {
            "X-CSRFToken": csrftoken,
          },
        }
      );

      if (response.status === 204) {
        showAlert("Webhook deleted successfully!", "success");
        loadWebhooks();
      } else {
        const error = await response.json();
        showAlert(
          `Failed to delete webhook: ${error.error || "Unknown error"}`,
          "error"
        );
      }
    } catch (error) {
      showAlert(`Error: ${error.message}`, "error");
    }
  }

  // Load webhooks on page load
  document.addEventListener("DOMContentLoaded", () => {
    loadWebhooks();
  });
</script>
{% endblock %}
