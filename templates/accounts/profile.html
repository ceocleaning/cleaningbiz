{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar Backdrop -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    <div class="dashboard-layout pt-5">
        <!-- Sidebar Navigation -->
        <div class="dashboard-sidebar pt-5 mt-3">
            <div class="sidebar-header">
                <h4 class="mb-1 fw-bold text-dark">{{ business.businessName }}</h4>
                <p class="mb-0 small text-muted">Business Dashboard</p>
            </div>
            
            <div class="sidebar-nav">
                <div class="list-group list-group-flush" id="sidebarNav" role="tablist">
                    <a class="list-group-item list-group-item-action d-flex align-items-center active" 
                       id="business-info-tab" 
                       data-bs-toggle="tab" 
                       href="#business-info"
                       role="tab" 
                       aria-controls="business-info" 
                       aria-selected="true">
                        <div class="icon-circle">
                            <i class="fas fa-building"></i>
                        </div>
                        <span>Business Info</span>
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" 
                       id="settings-tab" 
                       data-bs-toggle="tab" 
                       href="#settings"
                       role="tab" 
                       aria-controls="settings" 
                       aria-selected="false">
                        <div class="icon-circle">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span>Settings</span>
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" 
                       id="pricing-tab" 
                       data-bs-toggle="tab" 
                       href="#pricing"
                       role="tab" 
                       aria-controls="pricing" 
                       aria-selected="false">
                        <div class="icon-circle">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <span>Pricing</span>
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" 
                       id="api-credentials-tab" 
                       data-bs-toggle="tab" 
                       href="#api-credentials"
                       role="tab" 
                       aria-controls="api-credentials" 
                       aria-selected="false">
                        <div class="icon-circle">
                            <i class="fas fa-key"></i>
                        </div>
                        <span>API Credentials</span>
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" 
                       id="custom-addons-tab" 
                       data-bs-toggle="tab" 
                       href="#custom-addons"
                       role="tab" 
                       aria-controls="custom-addons" 
                       aria-selected="false">
                        <div class="icon-circle">
                            <i class="fas fa-puzzle-piece"></i>
                        </div>
                        <span>Custom Addons</span>
                    </a>
                </div>
            </div>
            
            {% if user.is_superuser %}
            <div class="sidebar-footer">
                <a href="{% url 'accounts:admin_business_approval' %}" class="btn btn-light btn-sm w-100">
                    <i class="fas fa-user-shield me-2"></i>Manage Business Approvals
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Main Content Area -->
        <div class="dashboard-content">
            <button id="sidebarToggleBtn" class="btn btn-primary position-fixed rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; left: 1rem; top: 4.5rem; z-index: 1060; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 3px solid white; cursor: pointer; transition: transform 0.3s ease;">
                <i class="fas fa-grip-lines fs-3"></i>
            </button>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabsContent">
                
                <!-- Business Info Tab Content -->
                <div class="tab-pane fade show active" id="business-info" role="tabpanel" aria-labelledby="business-info-tab">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <!-- Business Info Card -->
                                <div class="card">
                                    <!-- Business Banner/Header Area -->
                                    <div class="bg-primary p-4">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <div class="d-flex align-items-center">
                                                    <div class="rounded-circle bg-white p-2 d-flex justify-content-center align-items-center shadow-sm me-4"
                                                    style="width: 50px; height: 50px;">
                                                        <i class="fas fa-building text-primary fs-2"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="fw-bold text-white mb-1">{{ business.businessName }}</h4>
                                                        <p class="text-white mb-0">Member since {{ business.createdAt|date:"F d, Y" }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                                <a href="{% url 'accounts:edit_business' %}" class="btn btn-light d-inline-flex align-items-center rounded-3 shadow-sm px-4 py-2">
                                                    <i class="fas fa-pen-to-square me-2 text-primary"></i> 
                                                    <span>Edit Profile</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Business Details Section -->
                                    <div class="card-body p-4">
                                        <div class="row g-4">
                                            <!-- Business ID -->
                                            <div class="col-md-6">
                                                <div class="p-3 rounded-3 bg-light">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;">
                                                            <i class="fas fa-fingerprint text-white"></i>
                                                        </div>
                                                        <div class="text-muted small">Business ID</div>
                                                    </div>
                                                    <div class="fs-5 fw-semibold text-dark">{{ business.businessId }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Business Name -->
                                            <div class="col-md-6">
                                                <div class="p-3 rounded-3 bg-light">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;">
                                                            <i class="fas fa-store text-white"></i>
                                                        </div>
                                                        <div class="text-muted small">Business Name</div>
                                                    </div>
                                                    <div class="fs-5 fw-semibold text-dark">{{ business.businessName }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Phone Number -->
                                            <div class="col-md-6">
                                                <div class="p-3 rounded-3 bg-light">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;">
                                                            <i class="fas fa-phone-alt text-white"></i>
                                                        </div>
                                                        <div class="text-muted small">Phone Number</div>
                                                    </div>
                                                    <div class="fs-5 fw-semibold text-dark">
                                                        <a href="tel:{{ business.phone }}" class="text-dark text-decoration-none">{{ business.phone }}</a> 
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="p-3 rounded-3 bg-light">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;">
                                                            <i class="fas fa-envelope text-white"></i>
                                                        </div>
                                                        <div class="text-muted small">Email</div>
                                                    </div>
                                                    <div class="fs-5 fw-semibold text-dark">
                                                        <a href="mailto:{{ request.user.email }}" class="text-dark text-decoration-none">{{ request.user.email }}</a> 
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Address -->
                                            <div class="col-md-12">
                                                <div class="p-3 rounded-3 bg-light">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;">
                                                            <i class="fas fa-map-marker-alt text-white"></i>
                                                        </div>
                                                        <div class="text-muted small">Address</div>
                                                    </div>
                                                    <div class="fs-5 fw-semibold text-dark">{{ business.address }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Business Info Tab -->

                <!-- Settings Tab Content -->
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                    <div class="container">
                      <div class="row justify-content-center">
                        <div class="col-lg-12">
                          <!-- Header Section -->
                          <div class="d-flex justify-content-between align-items-center bg-primary p-4 rounded-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-white p-2 me-2 d-flex justify-content-center align-items-center" style="width: 50px; height: 50px;">
                                  <i class="fas fa-cog text-primary fs-4"></i>
                                </div>
                                <h4 class="text-white">Business Settings</h4>
                              </div>
                            <button id="saveSettingsBtn" class="btn btn-light d-flex align-items-center rounded-3 shadow-sm px-4 py-2">
                              <i class="fas fa-save me-2 text-primary"></i> 
                              <span>Save Settings</span>
                            </button>
                          </div>

                          <div class="card border-0 shadow-sm overflow-hidden">
                            <div class="card-body p-4">
                              <form id="businessSettingsForm" method="post">
                                {% csrf_token %}
                                <div class="row g-4">
                                  <!-- AI Call Feature Toggle -->
                                  <div class="col-md-6">
                                    <div class="p-3 rounded-3 bg-light">
                                      <div class="d-flex align-items-center mb-3">
                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                          <i class="fas fa-phone-alt text-white small"></i>
                                        </div>
                                        <h6 class="mb-0">AI Voice Agent</h6>
                                      </div>
                                      <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="useCallToggle" name="useCall" {% if business.useCall %}checked{% endif %}>
                                        <label class="form-check-label" for="useCallToggle">Enable AI Voice Agent (Retell)</label>
                                      </div>
                                      <div class="mt-2 small text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        When enabled, you can use Retell AI for voice calls with customers.
                                      </div>
                                      
                                      <!-- Call Delay Setting (only visible when Retell AI is enabled) -->
                                      <div id="callDelaySettings" class="mt-3" {% if not business.useCall %}style="display: none;"{% endif %}>
                                        <div class="form-group">
                                          <label for="callDelayMinutes" class="form-label fw-medium">Automated Call Delay (minutes)</label>
                                          <div class="input-group">
                                            <input type="number" class="form-control" id="callDelayMinutes" name="callDelayMinutes" 
                                                  value="{{ business.timeToWait|default:10 }}" min="1" max="60">
                                            <span class="input-group-text">minutes</span>
                                          </div>
                                          <div class="form-text text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Automated call will be sent after this many minutes if user doesn't respond to the first message.
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </form>
                            </div>
                          </div>

                          <!-- Settings Loader -->
                          <div id="settingsLoader" class="text-center mt-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-primary">Saving settings...</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <!-- End Settings Tab -->

                <!-- Pricing Tab Content -->
                <div class="tab-pane fade" id="pricing" role="tabpanel" aria-labelledby="pricing-tab">
                    <div class="container">
                      <div class="row justify-content-center">
                        <div class="col-lg-12">
                          <!-- Header Section -->
                          <div class="d-flex justify-content-between align-items-center bg-primary p-4 rounded-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-white p-2 me-2 d-flex justify-content-center align-items-center" style="width: 50px; height: 50px;">
                                  <i class="fas fa-dollar-sign text-primary fs-4"></i>
                                </div>
                                <h4 class="text-white">Business Pricing</h4>
                            </div>
                            <a href="{% url 'accounts:edit_business_settings' %}" class="btn btn-light d-flex align-items-center rounded-3 shadow-sm px-4 py-2">
                              <i class="fas fa-pen-to-square me-2 text-primary"></i> 
                              <span>Edit Pricing</span>
                            </a>
                          </div>
                          
                          <!-- Settings Cards Container -->
                          <div class="row g-4">
                            <!-- Base Pricing Card -->
                            <div class="col-md-6">
                              <div class="card border-0 rounded-4 shadow-sm h-100">
                                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                                  <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-primary p-3 me-3">
                                      <i class="fas fa-dollar-sign text-white"></i>
                                    </div>
                                    <h5 class="card-title fw-bold m-0">Base Pricing</h5>
                                  </div>
                                </div>
                                <div class="card-body p-4 pt-3">
                                  <div class="row g-3">
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Bedroom Price</div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.bedroomPrice }}</div>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Bathroom Price</div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.bathroomPrice }}</div>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Deposit Fee</div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.depositFee }}</div>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Tax Percent</div>
                                        <div class="fs-5 fw-semibold text-primary">{{ settings.taxPercent }}%</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Service Multipliers Card -->
                            <div class="col-md-6">
                              <div class="card border-0 rounded-4 shadow-sm h-100">
                                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                                  <div class="d-flex align-items-center mb-2">
                                    <div class="bg-primary rounded-3 px-3 py-2 me-3">
                                      <i class="fas fa-calculator text-white"></i>
                                    </div>
                                    <h5 class="card-title fw-bold m-0">Service Multipliers</h5>
                                  </div>
                                </div>
                                <div class="card-body p-4 pt-3">
                                  <div class="row g-3">
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Standard</div>
                                        <div class="fs-5 fw-semibold text-primary">{{ settings.sqftMultiplierStandard }}x</div>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Deep Clean</div>
                                        <div class="fs-5 fw-semibold text-primary">{{ settings.sqftMultiplierDeep }}x</div>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Move In/Out</div>
                                        <div class="fs-5 fw-semibold text-primary">{{ settings.sqftMultiplierMoveinout }}x</div>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="text-muted small mb-1">Airbnb</div>
                                        <div class="fs-5 fw-semibold text-primary">{{ settings.sqftMultiplierAirbnb }}x</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Add-on Prices Card -->
                            <div class="col-12">
                              <div class="card border-0 rounded-4 shadow-sm">
                                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                                  <div class="d-flex align-items-center mb-2">
                                    <div class="bg-primary rounded-3 px-3 py-2 me-3">
                                      <i class="fas fa-puzzle-piece text-white"></i>
                                    </div>
                                    <h5 class="card-title fw-bold m-0">Add-on Pricing</h5>
                                  </div>
                                </div>
                                <div class="card-body p-4 pt-3">
                                  <div class="row g-3">
                                    <!-- First row of add-ons -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-utensils text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Dishes</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceDishes }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-tshirt text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Laundry</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceLaundry }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-window-maximize text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Windows</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceWindow }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-paw text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Pets</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPricePets }}</div>
                                      </div>
                                    </div>
                                    
                                    <!-- Second row of add-ons -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-snowflake text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Fridge</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceFridge }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-fire text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Oven</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceOven }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-grip-lines text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Baseboard</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceBaseboard }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-sliders-h text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Blinds</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceBlinds }}</div>
                                      </div>
                                    </div>
                                    
                                    <!-- Third row of add-ons -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-leaf text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Green Cleaning</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceGreen }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-box text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Cabinets</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceCabinets }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-umbrella-beach text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Patio</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPricePatio }}</div>
                                      </div>
                                    </div>
                                    
                                    <div class="col-md-3 col-sm-6">
                                      <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex align-items-center mb-2">
                                          <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-warehouse text-white small"></i>
                                          </div>
                                          <div class="text-dark fw-medium">Garage</div>
                                        </div>
                                        <div class="fs-5 fw-semibold text-primary">${{ settings.addonPriceGarage }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <!-- End Settings Tab -->

                <!-- API Credentials Tab Content -->
                <div class="tab-pane fade" id="api-credentials" role="tabpanel" aria-labelledby="api-credentials-tab">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-lg-12">
                                <!-- Header Section -->
                                <div class="d-flex justify-content-between align-items-center bg-primary p-4 rounded-2">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-white p-2 me-2 d-flex justify-content-center align-items-center" style="width: 50px; height: 50px;">
                                            <i class="fas fa-key text-primary fs-4"></i>
                                        </div>
                                        <h4 class="text-white">Integration Settings</h4>
                                    </div>
                                    <a href="{% url 'accounts:edit_credentials' %}" class="btn btn-light d-flex align-items-center rounded-3 shadow-sm px-4 py-2">
                                        <i class="fas fa-pen-to-square me-2 text-primary"></i>
                                        <span>Edit Settings</span>
                                    </a>
                                </div>

                                <!-- Introduction Card -->
                                <div class="card border-0 shadow-sm mb-4 bg-light">
                                    <div class="card-body p-4">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <i class="fas fa-info-circle text-primary fs-3"></i>
                                            </div>
                                            <div>
                                                <h5 class="mb-2">Managing Your Integration Settings</h5>
                                                <p class="mb-0">These settings are used to connect your application with various services. Keep them secure and never share them publicly. Required settings are marked with <span class="badge bg-danger">Required</span> tag.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Toast for copy notification -->
                                <div class="copy-toast" id="copyToast">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-check-circle me-2 text-white"></i>
                                        <span>Copied to clipboard!</span>
                                    </div>
                                </div>

                                <!-- Main Credentials Cards -->
                                <div class="row g-4 mb-4">
                                    <!-- Secret Key Card -->
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100 credential-card">
                                            <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-lock text-white"></i>
                                                    </div>
                                                    <h5 class="card-title mb-0">Secret Key</h5>
                                                    
                                                </div>
                                            </div>
                                            <div class="card-body p-4 pt-2">
                                                <div class="input-group mb-3">
                                                    <input type="password" 
                                                           class="form-control api-key-input" 
                                                           id="secretKey" 
                                                           value="{{ credentials.secretKey|default:'' }}" 
                                                           placeholder="Secret Key"
                                                           readonly>
                                                    <button class="btn btn-sm btn-outline-secondary key-action-btn" 
                                                            type="button" 
                                                            onclick="toggleKey(this, 'secretKey')"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="top"
                                                            title="Toggle visibility">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary key-action-btn" 
                                                            type="button" 
                                                            onclick="copyToClipboard('secretKey')"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="top"
                                                            title="Copy to clipboard">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger key-action-btn" 
                                                            type="button"
                                                            onclick="regenerateSecretKey()"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="top"
                                                            title="Regenerate key">
                                                        <i class="fas fa-sync-alt"></i>
                                                    </button>
                                                </div>
                                                <div class="alert alert-light border-start border-primary border-3 mb-0">
                                                    <i class="fas fa-lock me-2 text-primary"></i>
                                                    <small>Keep this key secure. Never share it publicly.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                               
                                <div class="card border-0 rounded-4 shadow-sm mb-4 credential-card">
                                    <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="rounded-circle bg-info p-2 me-2 d-flex justify-content-center align-items-center" style="width: 36px; height: 36px;">
                                <i class="fas fa-phone-alt text-white"></i>
                            </div>
                            <h5 class="card-title mb-0">SMS Integration</h5>
                        </div>
                        <p class="text-muted small mt-2">Configure your SMS agent numbers to enable communication with customers.</p>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <div class="row g-4">
                            
                            <!-- SMS Agent Number Card -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light h-100 inner-credential-card">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="rounded-circle bg-primary p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-sms text-white small"></i>
                                        </div>
                                        <h6 class="mb-0">SMS Agent Number</h6>
                                        <span class="badge bg-primary ms-2 rounded-pill">SMS</span>
                                    </div>
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control api-key-input" 
                                               id="smsAgentNumber" 
                                               value="{{ credentials.twilioSmsNumber|default:'' }}" 
                                               placeholder="SMS Agent Number"
                                               readonly>
                                        <button class="btn btn-outline-primary key-action-btn"
                                                type="button"
                                                onclick="copyToClipboard('smsAgentNumber')"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Copy to Clipboard">
                                            <i class="fas fa-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
         
                <!-- Twilio Integration Section -->
                <div class="card border-0 rounded-4 shadow-sm mb-4 credential-card">
                    <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle bg-danger p-2 me-2 d-flex justify-content-center align-items-center" style="width: 36px; height: 36px;">
                                <i class="fas fa-comment-dots text-white"></i>
                            </div>
                            <h5 class="card-title mb-0">Twilio Integration</h5>
                        </div>
                        <p class="text-muted small mt-2">Connect your Twilio account to enable SMS and voice capabilities.</p>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <div class="row g-4">
                            <!-- Twilio SID Card -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light h-100 inner-credential-card">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="rounded-circle bg-danger p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-id-card text-white small"></i>
                                        </div>
                                        <h6 class="mb-0">Twilio Account SID</h6>
                                        <span class="badge bg-secondary ms-2 rounded-pill">Optional</span>
                                    </div>
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control api-key-input" 
                                               id="twilioSid" 
                                               value="{{ credentials.twilioAccountSid|default:'' }}" 
                                               placeholder="Twilio Account SID"
                                               readonly>
                                        <button class="btn btn-outline-primary key-action-btn"
                                                type="button"
                                                onclick="copyToClipboard('twilioSid')"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Copy to Clipboard">
                                            <i class="fas fa-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Twilio Auth Token Card -->
                            <div class="col-md-6">
                                <div class="p-3 rounded-3 bg-light h-100 inner-credential-card">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="rounded-circle bg-danger p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-key text-white small"></i>
                                        </div>
                                        <h6 class="mb-0">Twilio Auth Token</h6>
                                        <span class="badge bg-secondary ms-2 rounded-pill">Optional</span>
                                    </div>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control api-key-input" 
                                               id="twilioAuthToken" 
                                               value="{{ credentials.twilioAuthToken|default:'' }}" 
                                               placeholder="Twilio Auth Token"
                                               readonly>
                                        <button class="btn btn-outline-secondary key-action-btn" 
                                                type="button" 
                                                onclick="toggleKey(this, 'twilioAuthToken')"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Show/Hide Key">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-primary key-action-btn"
                                                type="button"
                                                onclick="copyToClipboard('twilioAuthToken')"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Copy to Clipboard">
                                            <i class="fas fa-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Webhook Integration Section -->
                <div class="card border-0 rounded-4 shadow-sm credential-card">
                    <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle bg-warning p-2 me-2 d-flex justify-content-center align-items-center" style="width: 36px; height: 36px;">
                                <i class="fas fa-link text-white"></i>
                            </div>
                            <h5 class="card-title mb-0">Webhook Integration</h5>
                        </div>
                        <p class="text-muted small mt-2">Use these webhook URLs to connect third-party services to your application.</p>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <div class="row g-4">
                            <!-- Thumbtack Webhook URL Card -->
                            <div class="col-12">
                                <div class="p-3 rounded-3 bg-light inner-credential-card">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="rounded-circle bg-warning p-2 me-2 d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                                            <i class="fas fa-globe text-white small"></i>
                                        </div>
                                        <h6 class="mb-0">Thumbtack Webhook URL</h6>
                                        <span class="badge bg-warning text-dark ms-2 rounded-pill">Integration</span>
                                    </div>
                                    {% if credentials.secretKey %}
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control api-key-input" 
                                               id="ThumbtackWebhookUrl" 
                                               value="{{ credentials.getThumbtackUrl }}" 
                                               placeholder="Thumbtack Webhook URL"
                                               readonly>
                                        <button class="btn btn-outline-primary key-action-btn"
                                                type="button"
                                                onclick="copyToClipboard('ThumbtackWebhookUrl')"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Copy to Clipboard">
                                            <i class="fas fa-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div class="mt-2 small text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        This URL will receive webhook events from Thumbtack.
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Please set up your secret key first to get your webhook URL.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

 <!-- Custom Addons Tab -->
<div class="tab-pane fade" id="custom-addons" role="tabpanel" aria-labelledby="custom-addons-tab">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-12">
          <!-- Header Section -->
          <div class="d-flex justify-content-between align-items-center bg-primary p-4 rounded-2">
            <div class="d-flex align-items-center">
                <div class="rounded-circle bg-white p-2 me-2 d-flex justify-content-center align-items-center" style="width: 50px; height: 50px;">
                  <i class="fas fa-puzzle-piece text-primary fs-4"></i>
                </div>
                <h4 class="text-white">Custom Addons</h4>
            </div>
            <button type="button" class="btn btn-light d-flex align-items-center rounded-3 shadow-sm px-4 py-2" 
                    data-bs-toggle="modal" data-bs-target="#addCustomAddonModal">
              <i class="fas fa-plus-circle me-2 text-primary"></i> 
              <span>Add New Addon</span>
            </button>
          </div>
          
          <!-- Search and Filter Bar -->
          <div class="rounded-4 p-3 mb-4">
            <div class="row g-2 align-items-center">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text border-end-0">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" class="form-control border-start-0 ps-0" 
                         id="addonSearch" 
                         placeholder="Search addons...">
                </div>
              </div>
              
            </div>
          </div>
  
          <!-- Addons Grid -->
          <div class="row g-4" id="addonsGrid">
            {% for addon in business.business_custom_addons.all %}
            <div class="col-lg-4 col-md-6">
              <div class="card h-100 rounded-4 border-0 shadow-sm hover-shadow transition-300">
                <!-- Card Header -->
                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                  <div class="d-flex justify-content-between align-items-start">
                    <span class="badge rounded-pill text-bg-primary px-3 py-2">
                      <i class="fas fa-tag me-1"></i> Add-on Service
                    </span>
                    <div class="dropdown">
                      <button class="btn btn-light btn-sm rounded-circle p-2" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-vertical"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                        <li>
                          <a class="dropdown-item py-2 edit-addon" href="#"
                            data-addon-id="{{ addon.id }}"
                            data-addon-name="{{ addon.addonName }}"
                            data-addon-data-name="{{ addon.addonDataName }}"
                            data-addon-price="{{ addon.addonPrice }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#editCustomAddonModal">
                            <i class="fas fa-pen-to-square me-2 text-primary"></i> Edit
                          </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item py-2 delete-addon text-danger" href="#"
                            data-addon-id="{{ addon.id }}">
                            <i class="fas fa-trash-can me-2"></i> Delete
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
                
                <!-- Card Body -->
                <div class="card-body p-4">
                  <h5 class="card-title fw-bold mb-4 text-dark">{{ addon.addonName }}</h5>
                  
                  <div class="d-flex align-items-center mb-4">
                    <div class="bg-primary rounded-4 p-3 me-3 d-flex justify-content-center align-items-center" style="width: 48px; height: 48px;">
                      <i class="fas fa-dollar-sign text-white"></i>
                    </div>
                    <div>
                      <div class="text-muted small">Price</div>
                      <div class="fs-5 fw-semibold text-primary">${{ addon.addonPrice }}</div>
                    </div>
                  </div>
                  
                  <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-4 p-3 me-3 d-flex justify-content-center align-items-center" style="width: 48px; height: 48px;">
                      <i class="fas fa-code text-white"></i>
                    </div>
                    <div>
                      <div class="text-muted small">Identifier</div>
                      <div class="text-dark">{{ addon.addonDataName }}</div>
                    </div>
                  </div>
                </div>
                
              
              </div>
            </div>
            {% empty %}
            <div class="col-12">
              <div class="card text-center py-5 border-0 rounded-4 shadow-sm">
                <div class="card-body py-5">
                  <div class="bg-primary rounded-circle p-4 d-inline-flex mb-4">
                    <i class="fas fa-puzzle-piece text-primary fs-1"></i>
                  </div>
                  <h4 class="fw-bold text-dark mb-3">No Custom Addons Yet</h4>
                  <p class="text-muted mb-4 mx-auto" style="max-width: 500px;">
                    Create your first custom addon to offer additional services to your customers and increase your revenue potential.
                  </p>
                  <button class="btn btn-primary rounded-3 px-4 py-2 shadow-sm" 
                          data-bs-toggle="modal" data-bs-target="#addCustomAddonModal">
                    <i class="fas fa-plus-circle me-2"></i> Add Your First Addon
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          
        
        </div>
      </div>
    </div>
  </div>
  <!-- End Custom Addons Tab -->


      

    </div> <!-- End Tab Content -->
</div> <!-- End Main Content Area -->
    </div> <!-- End Dashboard Layout -->
</div> <!-- End Dashboard Container -->

<!-- Add Custom Addon Modal -->
<div class="modal fade" id="addCustomAddonModal" tabindex="-1" aria-labelledby="addCustomAddonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomAddonModalLabel">Add Custom Addon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCustomAddonForm" method="post" action="{% url 'accounts:add_custom_addon' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addonName" class="form-label">Addon Name</label>
                        <input type="text" class="form-control" id="addonName" name="addonName" required>
                    </div>

                    <div class="mb-3">
                        <label for="addonDataName" class="form-label">Addon Data Name</label>
                        <input type="text" class="form-control" id="addonDataName" name="addonDataName" readonly>
                        <small class="text-muted">
                            <i class="fa fa-lock me-1"></i>
                            This will be automatically generated from the addon name
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="addonPrice" class="form-label">Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" class="form-control" id="addonPrice" name="addonPrice" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Addon</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Custom Addon Modal -->
<div class="modal fade" id="editCustomAddonModal" tabindex="-1" aria-labelledby="editCustomAddonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCustomAddonModalLabel">Edit Custom Addon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editAddonForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="editAddonId">
                    <div class="mb-3">
                        <label for="editAddonName" class="form-label">Addon Name</label>
                        <input type="text" class="form-control" id="editAddonName" name="addonName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAddonDataName" class="form-label">Addon Data Name</label>
                        <input type="text" class="form-control" id="editAddonDataName" name="addonDataName" readonly>
                        <small class="text-muted">
                            <i class="fa fa-lock me-1"></i>
                            This will be automatically generated from the addon name
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="editAddonPrice" class="form-label">Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" class="form-control" id="editAddonPrice" name="addonPrice" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Dashboard Layout Styles */
    .dashboard-container {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: calc(100vh - 56px); /* Adjust based on navbar height */
    }
    
    .dashboard-layout {
        display: flex;
        min-height: calc(100vh - 56px);
        padding-top: 0;
    }
    
    /* Sidebar Styles */
    .dashboard-sidebar {
        width: 300px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 56px; /* Adjust based on navbar height */
        left: 0;
        bottom: 0;
        overflow-y: auto;
        z-index: 999;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .sidebar-header {
        padding: 0 1.25rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }
    
    .sidebar-nav {
        flex: 1;
        overflow-y: auto;
    }
    
    .sidebar-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid #e9ecef;
    }
    
    .list-group-item {
        border: none;
        border-radius: 0;
        padding: 0.65rem 1.25rem;
        margin-bottom: 0.2rem;
        background-color: transparent;
        color: #303235;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        font-size: 0.9rem;
    }
    
    .list-group-item:hover {
        background-color: rgba(13, 110, 253, 0.05);
        color: #0d6efd;
        border-left: 3px solid rgba(13, 110, 253, 0.4);
    }
    
    .list-group-item.active {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
        border-left: 3px solid #0d6efd;
        font-weight: 500;
    }
    
    .icon-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: rgba(13, 110, 253, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        transition: all 0.3s ease;
        color: #0d6efd;
    }
    
    .list-group-item:hover .icon-circle {
        background-color: rgba(13, 110, 253, 0.15);
        transform: translateY(-1px);
    }
    
    .list-group-item.active .icon-circle {
        background-color: #0d6efd;
        color: white;
    }
    
    /* Content Area Styles */
    .dashboard-content {
        flex: 1;
        margin-left: 300px; /* Match sidebar width */
        background-color: #f8f9fa;
        overflow-y: auto;
        width: calc(100%);
    }
    
    .content-header {
        padding: 0 0 1.25rem;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
    }
    
    .content-header h3 {
        font-size: 1.35rem;
        margin-bottom: 0.35rem;
    }
    
    .content-header p {
        font-size: 0.9rem;
    }
    
    .tab-pane {
        animation: fadeIn 0.3s ease-in-out;
        padding: 0;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Make components more compact */
    .card {
        margin-bottom: 1.5rem;
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .card-header {
        padding: 1.25rem;
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .card-body {
        padding: 1.25rem;
        background-color: #fff;
    }
    
    .form-control, .input-group-text, .btn {
        font-size: 0.9rem;
        padding: 0.375rem 0.75rem;
    }
    
    /* Heading size adjustments */
    h3.fw-bold {
        font-size: 1.35rem;
    }
    
    h4.fw-bold {
        font-size: 1.2rem;
    }
    
    h5.fw-bold, h5.card-title {
        font-size: 1.1rem;
    }
    
    h6.mb-0 {
        font-size: 0.95rem;
    }
    
    /* Component sizing */
    .rounded-circle.bg-primary {
        width: 35px !important;
        height: 35px !important;
    }
    
    /* Dashboard content container */
    .container-fluid {
        padding-left: 0;
        padding-right: 0;
        max-width: 100%;
    }
    
    .row > .col-lg-11 {
        width: 100%;
        max-width: 100%;
        flex: 0 0 100%;
        padding-left: 0;
        padding-right: 0;
    }
    
    /* Responsive Styles */
    @media (max-width: 991px) {
        .dashboard-sidebar {
            width: 220px;
            transform: translateX(-100%);
        }
        
        .dashboard-sidebar.show {
            transform: translateX(0);
        }
        
        .dashboard-content {
            margin-left: 0;
            width: 100%;
        }
        
        .sidebar-toggle-shown .dashboard-content {
            margin-left: 220px;
            width: calc(100% - 220px);
        }
    }
    
    @media (max-width: 767px) {
        .dashboard-sidebar {
            width: 100%;
            z-index: 1050;
        }
        
        .sidebar-toggle-shown .dashboard-content {
            margin-left: 0;
            width: 100%;
        }
    }
    
    /* Existing styles */
    .api-key-card {
        background: #f8f9fa;
    }
    .api-key-input {
        background: white !important;
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
        font-family: inherit;
    }
    .api-key-input:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        border-color: #86b7fe;
    }
    .btn-outline-primary:hover, .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
        transition: all 0.3s ease;
    }
    .btn-outline-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
        transition: all 0.3s ease;
    }
    .credential-card {
        transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        border: 1px solid transparent !important;
        position: relative;
        overflow: hidden;
    }
    .credential-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08) !important;
    }
    .credential-card:after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 4px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        z-index: -1;
    }
    .credential-card:hover:after {
        opacity: 1;
    }
    .inner-credential-card {
        transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        border: 1px solid transparent;
        position: relative;
    }
    .inner-credential-card:hover {
        border-color: #e9ecef;
        box-shadow: 0 3px 10px rgba(0,0,0,0.04);
        transform: translateY(-2px);
    }
    .copy-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        display: none;
        z-index: 1050;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: fadeInUp 0.3s ease-out;
        font-weight: 500;
        border-left: 4px solid #198754;
        min-width: 250px;
        font-size: 0.9rem;
    }
    .copy-toast.error {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        border-left: 4px solid #bd2130;
    }
    .copy-toast.warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        border-left: 4px solid #d39e00;
        color: #212529;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .api-key-wrapper {
        position: relative;
    }
    .api-key-wrapper .badge {
        position: absolute;
        top: -10px;
        right: -10px;
        z-index: 1;
    }
    .key-action-btn {
        transition: all 0.2s ease-in-out;
    }
    .key-action-btn:active {
        transform: translateY(1px);
        box-shadow: none !important;
    }
    .api-key-label {
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 8px;
    }
    .input-group:focus-within {
        transform: translateY(-2px);
        transition: transform 0.3s ease;
    }

    /* Additional style improvements */
    .bg-light {
        background-color: #f9f9f9 !important;
        border: 1px solid #f0f0f0;
        transition: all 0.2s;
    }

    .bg-light:hover {
        background-color: #f5f5f5 !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }

    .dashboard-content {
        background-color: #f5f7fa;
    }

    .tab-pane .container-fluid {
        margin-bottom: 2rem;
    }

    /* Section headers styling */
    .d-flex.justify-content-between.align-items-center.mb-4 {
        margin-bottom: 1.5rem !important;
        background-color: #fff;
        padding: 1.25rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* Improve spacing for sections */
    .tab-pane .container-fluid .row {
        margin-left: 0;
        margin-right: 0;
    }

    /* Buttons styling */
    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.2);
    }

    .btn-outline-primary {
        border-color: #0d6efd;
        color: #0d6efd;
    }

    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }

    .btn-light {
        background-color: white;
        border-color: #e9ecef;
    }

    /* Small card improvement */
    .p-3.rounded-3.bg-light {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .p-3.rounded-3.bg-light .d-flex {
        margin-bottom: 0.5rem;
    }

    .fs-5.fw-semibold.text-dark {
        margin-top: auto;
    }

    /* Responsive Styles */
    @media (max-width: 991px) {
        .dashboard-sidebar {
            width: 260px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            z-index: 1050;
        }
        
        .dashboard-sidebar.show {
            transform: translateX(0);
        }
        
        .dashboard-content {
            margin-left: 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        /* Sidebar backdrop */
        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 1045;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .sidebar-backdrop.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* Add body class to prevent scrolling when sidebar is open */
        body.sidebar-open {
            overflow: hidden;
        }
        
        /* Mobile sidebar toggle button */
        .mobile-sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1030;
            display: block;
        }
        
        .mobile-sidebar-toggle .btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-sidebar-toggle .btn i {
            font-size: 1.2rem;
        }
    }
    
    @media (max-width: 767px) {
        .dashboard-sidebar {
            width: 280px;
        }
    }
    
    /* Hide mobile toggle button on desktop */
    .mobile-sidebar-toggle {
        display: none;
    }

    /* Mobile sidebar toggle button - always visible on mobile */
    .mobile-sidebar-toggle {
        position: fixed;
        top: 1.5rem;
        left: 1.5rem;
        z-index: 1060;
        display: block;
    }
    
    .mobile-sidebar-toggle .btn {
        width: 50px !important;
        height: 50px !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
        border: 2px solid #fff;
    }

    .mobile-sidebar-toggle .btn {
        width: 50px !important;
        height: 50px !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
        border: 2px solid #fff;
    }
    
    @media (min-width: 992px) {
        .mobile-sidebar-toggle {
            display: none;
        }
    }

    /* Hide the sidebar toggle button on desktop */
    @media (min-width: 992px) {
        #sidebarToggleBtn {
            display: none !important;
        }
    }
</style>

{% block scripts %}
<script>
    // Sidebar navigation enhancement
    document.addEventListener('DOMContentLoaded', function() {
        // Get all sidebar items
        const sidebarItems = document.querySelectorAll('#sidebarNav .list-group-item');
        
        // Add click event to each sidebar item
        sidebarItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                sidebarItems.forEach(i => i.classList.remove('active'));
                
                // Add active class to clicked item
                this.classList.add('active');
            });
        });
        
        // Check URL hash on page load to activate correct tab
        if (window.location.hash) {
            const hash = window.location.hash;
            const tabLink = document.querySelector(`a[href="${hash}"]`);
            
            if (tabLink) {
                tabLink.click();
            }
        }
    });

    // Function to generate data name from addon name
    function generateDataName(addonName) {
        return addonName.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
    }

    // Function to toggle key visibility
    function toggleKey(button, inputId) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
            input.classList.remove('masked');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
            input.classList.add('masked');
        }
    }

    // Function to copy webhook URL
    function copyRetellWebhookUrl(button) {
        const webhookUrl = document.getElementById('webhookUrl').value;
        navigator.clipboard.writeText(webhookUrl).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = 'Copy';
            }, 2000);
        });
    }

    function copyThumbtackUrl(button) {
      const thumtackWebhookUrl = document.getElementById('thumtackWebhookUrl').value;
      navigator.clipboard.writeText(thumtackWebhookUrl).then(() => {
        button.textContent = 'Copied!';
        setTimeout(() => {
          button.textContent = 'Copy';
        }, 2000);
      });
    }

    // Wait for DOM to be loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Handle addon name input for new addon
        const addonNameInput = document.getElementById('addonName');
        const addonDataNameInput = document.getElementById('addonDataName');
        
        if (addonNameInput && addonDataNameInput) {
            addonNameInput.addEventListener('input', function() {
                addonDataNameInput.value = generateDataName(this.value);
            });
        }
    });

    // Function to copy to clipboard
    function copyToClipboard(inputId) {
        const input = document.getElementById(inputId);
        const toast = document.getElementById('copyToast');
        const toastMessage = toast.querySelector('span');
        const toastIcon = toast.querySelector('i');
        
        // Select the text
        input.select();
        input.setSelectionRange(0, 99999); // For mobile devices
        
        // Copy the text
        navigator.clipboard.writeText(input.value).then(() => {
            // Highlight the input field briefly
            const originalBg = input.style.backgroundColor;
            input.style.backgroundColor = '#d1e7dd';
            setTimeout(() => {
                input.style.backgroundColor = originalBg;
            }, 300);
            
            // Update toast message based on the input placeholder
            const credentialType = input.getAttribute('placeholder') || 'Credential';
            toastMessage.textContent = `Copied ${credentialType} to clipboard!`;
            toastIcon.className = 'fas fa-check-circle me-2 text-white';
            
            // Show toast
            toast.style.display = 'block';
            toast.style.opacity = '1';
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        });
    }

    // Function to regenerate secret key
    function regenerateSecretKey() {
        // Create a custom confirmation dialog
        const confirmDialog = document.createElement('div');
        confirmDialog.className = 'modal fade';
        confirmDialog.id = 'confirmRegenerateModal';
        confirmDialog.setAttribute('tabindex', '-1');
        confirmDialog.setAttribute('aria-labelledby', 'confirmRegenerateModalLabel');
        confirmDialog.setAttribute('aria-hidden', 'true');
        
        confirmDialog.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="confirmRegenerateModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Regenerate Secret Key
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Are you sure you want to regenerate your secret key?</p>
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Important:</strong> This action cannot be undone and will invalidate your existing key. Any applications using the current key will stop working until updated with the new key.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" id="confirmRegenerateBtn">
                            <i class="fas fa-sync-alt me-2"></i>Regenerate Key
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(confirmDialog);
        
        // Initialize the modal
        const modal = new bootstrap.Modal(confirmDialog);
        modal.show();
        
        // Handle confirm button click
        const confirmBtn = document.getElementById('confirmRegenerateBtn');
        confirmBtn.addEventListener('click', function() {
            // Show loading state
            const button = this;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Make AJAX request to regenerate key
            fetch('{% url "accounts:regenerate_secret_key" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update the secret key input field
                document.getElementById('secretKey').value = data.secret_key;
                
                // Show success message
                const toast = document.getElementById('copyToast');
                const toastMessage = toast.querySelector('span');
                const toastIcon = toast.querySelector('i');
                toastMessage.textContent = 'Secret key regenerated successfully!';
                toastIcon.className = 'fas fa-sync-alt me-2 text-white';
                
                // Show toast
                toast.style.display = 'block';
                toast.style.opacity = '1';
                
                // Hide toast after 3 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        toast.style.display = 'none';
                        toast.className = 'copy-toast'; // Reset class
                        toastIcon.className = 'fas fa-check-circle me-2 text-white'; // Reset icon
                    }, 300);
                }, 3000);
                
                // Reset button state
                button.innerHTML = originalContent;
                button.disabled = false;
                
                // Hide the confirmation dialog
                modal.hide();
            })
            .catch(error => {
                console.error('Error regenerating secret key:', error);
                
                // Show error message
                const toast = document.getElementById('copyToast');
                const toastMessage = toast.querySelector('span');
                const toastIcon = toast.querySelector('i');
                toastMessage.textContent = 'Error regenerating secret key. Please try again.';
                toastIcon.className = 'fas fa-exclamation-circle me-2 text-white';
                toast.className = 'copy-toast error';
                toast.style.display = 'block';
                toast.style.opacity = '1';
                
                // Hide toast after 3 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.classList.remove('error-toast');
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300);
                }, 3000);
                
                // Reset button state
                button.innerHTML = originalContent;
                button.disabled = false;
                
                // Hide the confirmation dialog
                modal.hide();
            });
        });
    }

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Add animation class to credential cards on page load
        setTimeout(() => {
            document.querySelectorAll('.credential-card').forEach((card, index) => {
                // Set initial state
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                card.style.transition = 'all 0.6s cubic-bezier(0.165, 0.84, 0.44, 1)';
                
                // Animate with staggered delay
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 150); // Staggered delay for each card
            });
            
            // Add animation for inner credential cards with a slight delay
            setTimeout(() => {
                document.querySelectorAll('.inner-credential-card').forEach((card, index) => {
                    // Set initial state
                    card.style.opacity = '0.7';
                    card.style.transform = 'translateY(10px)';
                    card.style.transition = 'all 0.4s ease';
                    
                    // Animate with staggered delay
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 100); // Shorter staggered delay for inner cards
                });
            }, 500); // Delay after main cards animation starts
        }, 300);
    });
</script>

<script>
    // Function to copy webhook URL
    function copyWebhookUrl(button) {
        const webhookUrl = document.getElementById('webhookUrl').value;
        navigator.clipboard.writeText(webhookUrl).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = 'Copy';
            }, 2000);
        });
    }

    // Wait for DOM to be loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Handle addon name input for new addon
        const addonNameInput = document.getElementById('addonName');
        const addonDataNameInput = document.getElementById('addonDataName');
        
        if (addonNameInput && addonDataNameInput) {
            addonNameInput.addEventListener('input', function() {
                addonDataNameInput.value = generateDataName(this.value);
            });
        }
    });

    // Handle addon name input for edit addon
    const editAddonNameInput = document.getElementById('editAddonName');
    const editAddonDataNameInput = document.getElementById('editAddonDataName');
    
    if (editAddonNameInput) {
        editAddonNameInput.addEventListener('input', function() {
            const dataName = generateDataName(this.value);
            editAddonDataNameInput.value = dataName;
        });
    }

    // Handle new addon form submission
    const addCustomAddonForm = document.getElementById('addCustomAddonForm');
    if (addCustomAddonForm) {
        addCustomAddonForm.addEventListener('submit', function() {
            const addonName = addonNameInput.value;
            const dataName = generateDataName(addonName);
            addonDataNameInput.value = dataName;
        });
    }

    // Handle edit form submission
    const editAddonForm = document.getElementById('editAddonForm');
    if (editAddonForm) {
        editAddonForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const addonId = document.getElementById('editAddonId').value;
            const addonName = editAddonNameInput.value;
            const dataName = generateDataName(addonName);
            editAddonDataNameInput.value = dataName;

            fetch(`/account/custom-addon/${addonId}/edit/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(new FormData(editAddonForm))
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                }
            })
            .catch(() => {
                alert('Error updating addon');
            });
        });
    }

    // Handle delete buttons
    document.querySelectorAll('.delete-addon').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this addon?')) {
                const addonId = this.dataset.addonId;
                fetch(`/account/custom-addon/${addonId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    }
                })
                .catch(() => {
                    alert('Error deleting addon');
                });
            }
        });
    });

    // Handle edit buttons
    document.querySelectorAll('.edit-addon').forEach(button => {
        button.addEventListener('click', function() {
            const addonId = this.dataset.addonId;
            const addonName = this.dataset.addonName;
            const addonDataName = this.dataset.addonDataName;
            const addonPrice = this.dataset.addonPrice;

            document.getElementById('editAddonId').value = addonId;
            document.getElementById('editAddonName').value = addonName;
            document.getElementById('editAddonDataName').value = addonDataName;
            document.getElementById('editAddonPrice').value = addonPrice;
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('addonSearch');
        const addonsGrid = document.getElementById('addonsGrid');
        
        // Store original addons for reset
        const originalAddons = Array.from(addonsGrid.children);
        
        function searchAddons() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Create a copy of the original addons
            let filteredAddons = [...originalAddons];
            
            // Apply search filter if there's a search term
            if (searchTerm) {
                filteredAddons = filteredAddons.filter(addon => {
                    const addonName = addon.querySelector('.card-title').textContent.toLowerCase();
                    const addonPrice = addon.querySelector('.fs-5.fw-semibold.text-primary').textContent;
                    const addonDataName = addon.querySelector('.text-dark').textContent.toLowerCase();
                    return addonName.includes(searchTerm) || 
                           addonPrice.includes(searchTerm) || 
                           addonDataName.includes(searchTerm);
                });
            }
            
            // Clear and repopulate the grid
            addonsGrid.innerHTML = '';
            if (filteredAddons.length === 0) {
                addonsGrid.innerHTML = `
                    <div class="col-12">
                        <div class="card text-center py-5 border-0 rounded-4 shadow-sm">
                            <div class="card-body py-5">
                                <div class="bg-primary rounded-circle p-3 d-inline-flex mb-4">
                                    <i class="fas fa-search text-primary fs-4"></i>
                                </div>
                                <h4 class="fw-bold text-dark mb-3">No Addons Found</h4>
                                <p class="text-muted">Try adjusting your search criteria</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                filteredAddons.forEach(addon => addonsGrid.appendChild(addon));
            }
        }
        
        // Add event listener for search input
        searchInput.addEventListener('input', searchAddons);
    });
</script>

<script>
    // Wait for DOM to be loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Handle settings save button
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const businessSettingsForm = document.getElementById('businessSettingsForm');
        const settingsLoader = document.getElementById('settingsLoader');
        
        // Toggle call delay settings based on Retell AI toggle
        const useCallToggle = document.getElementById('useCallToggle');
        const callDelaySettings = document.getElementById('callDelaySettings');
        
        if (useCallToggle && callDelaySettings) {
            useCallToggle.addEventListener('change', function() {
                callDelaySettings.style.display = this.checked ? 'block' : 'none';
            });
        }
        
        if (saveSettingsBtn && businessSettingsForm) {
            saveSettingsBtn.addEventListener('click', function() {
                // Show loader
                if (settingsLoader) {
                    settingsLoader.style.display = 'block';
                }
                
                // Disable save button
                saveSettingsBtn.disabled = true;
                saveSettingsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i><span>Saving...</span>';
                
                const formData = new FormData(businessSettingsForm);
                
                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                formData.append('csrfmiddlewaretoken', csrfToken);
                
                // Add useCall value
                formData.append('useCall', useCallToggle.checked);
                
                // Add callDelayMinutes value if Retell AI is enabled
                if (useCallToggle.checked) {
                    const callDelayMinutes = document.getElementById('callDelayMinutes').value;
                    formData.append('callDelayMinutes', callDelayMinutes);
                }
                
                fetch('{% url "accounts:update_business_settings" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loader
                    if (settingsLoader) {
                        settingsLoader.style.display = 'none';
                    }
                    
                    // Reset save button
                    saveSettingsBtn.disabled = false;
                    saveSettingsBtn.innerHTML = '<i class="fas fa-save me-2"></i><span>Save Settings</span>';
                    
                    if (data.success) {
                        // Show success toast
                        const toast = document.getElementById('copyToast');
                        const toastMessage = toast.querySelector('span');
                        const toastIcon = toast.querySelector('i');
                        toastMessage.textContent = 'Settings saved successfully!';
                        toastIcon.className = 'fas fa-check-circle me-2 text-white';
                        
                        toast.style.display = 'block';
                        toast.style.opacity = '1';
                        
                        setTimeout(function() {
                            toast.style.opacity = '0';
                            setTimeout(function() {
                                toast.style.display = 'none';
                            }, 300);
                        }, 3000);
                        
                        // Reload the page to reflect changes
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Show error toast
                        const toast = document.getElementById('copyToast');
                        const toastMessage = toast.querySelector('span');
                        const toastIcon = toast.querySelector('i');
                        toastMessage.textContent = data.message || 'Error saving settings';
                        toastIcon.className = 'fas fa-exclamation-circle me-2 text-white';
                        toast.classList.add('error-toast');
                        
                        toast.style.display = 'block';
                        toast.style.opacity = '1';
                        
                        setTimeout(function() {
                            toast.style.opacity = '0';
                            toast.classList.remove('error-toast');
                            setTimeout(function() {
                                toast.style.display = 'none';
                            }, 300);
                        }, 3000);
                    }
                })
                .catch(error => {
                    // Hide loader
                    if (settingsLoader) {
                        settingsLoader.style.display = 'none';
                    }
                    
                    // Reset save button
                    saveSettingsBtn.disabled = false;
                    saveSettingsBtn.innerHTML = '<i class="fas fa-save me-2"></i><span>Save Settings</span>';
                    
                    console.error('Error:', error);
                    // Show error toast
                    const toast = document.getElementById('copyToast');
                    const toastMessage = toast.querySelector('span');
                    const toastIcon = toast.querySelector('i');
                    toastMessage.textContent = 'Error saving settings';
                    toastIcon.className = 'fas fa-exclamation-circle me-2 text-white';
                    toast.classList.add('error-toast');
                    
                    toast.style.display = 'block';
                    toast.style.opacity = '1';
                    
                    setTimeout(function() {
                        toast.style.opacity = '0';
                        toast.classList.remove('error-toast');
                        setTimeout(function() {
                            toast.style.display = 'none';
                        }, 300);
                    }, 3000);
                });
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded - initializing sidebar...');
        // Sidebar toggle functionality
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebar = document.querySelector('.dashboard-sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        
        console.log('Toggle elements found:', {
            button: sidebarToggleBtn,
            sidebar: sidebar,
            backdrop: backdrop
        });
        
        // Toggle sidebar function
        function toggleSidebar() {
            console.log('Toggle sidebar function called');
            sidebar.classList.toggle('show');
            backdrop.classList.toggle('show');
            document.body.classList.toggle('sidebar-open');
            
            // Change icon when sidebar is open/closed
            if (sidebar.classList.contains('show')) {
                sidebarToggleBtn.innerHTML = '<i class="fas fa-times fs-3"></i>';
                console.log('Sidebar is now OPEN');
            } else {
                sidebarToggleBtn.innerHTML = '<i class="fas fa-grip-lines fs-3"></i>';
                console.log('Sidebar is now CLOSED');
            }
        }
        
        // Add click event to toggle button
        sidebarToggleBtn.addEventListener('click', function(e) {
            console.log('Toggle button clicked');
            e.preventDefault();
            toggleSidebar();
        });
        
        // Close sidebar when backdrop is clicked
        backdrop.addEventListener('click', toggleSidebar);
        
        // Close sidebar when escape key is pressed
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar.classList.contains('show')) {
                toggleSidebar();
            }
        });
        
        // Add hover effect to button
        sidebarToggleBtn.addEventListener('mouseover', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        sidebarToggleBtn.addEventListener('mouseout', function() {
            this.style.transform = 'scale(1)';
        });
        
        // Close sidebar when any link is clicked on mobile
        const sidebarLinks = document.querySelectorAll('.dashboard-sidebar a, .dashboard-sidebar .list-group-item');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth < 992 && sidebar.classList.contains('show')) {
                    toggleSidebar();
                }
            });
        });
        
        // Adjust for screen resize
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 992) {
                sidebar.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.classList.remove('sidebar-open');
                sidebarToggleBtn.innerHTML = '<i class="fas fa-grip-lines fs-3"></i>';
            }
        });
        
        console.log('Sidebar toggle initialized');
    });
</script>

<script>
    // Single consolidated sidebar toggle implementation
    (function() {
        console.log('Initializing sidebar toggle functionality...');
        
        // Get elements
        const sidebar = document.querySelector('.dashboard-sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        const toggleBtn = document.getElementById('sidebarToggleBtn');
        
        if (!sidebar || !backdrop || !toggleBtn) {
            console.error('Sidebar elements not found:', { sidebar, backdrop, toggleBtn });
            return;
        }
        
        // Toggle function
        function toggleSidebar(event) {
            if (event) event.preventDefault();
            console.log('Toggle sidebar called');
            
            // Toggle classes
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.classList.remove('sidebar-open');
                toggleBtn.innerHTML = '<i class="fas fa-grip-lines fs-3"></i>';
                console.log('Sidebar is now CLOSED');
            } else {
                sidebar.classList.add('show');
                backdrop.classList.add('show');
                document.body.classList.add('sidebar-open');
                toggleBtn.innerHTML = '<i class="fas fa-times fs-3"></i>';
                console.log('Sidebar is now OPEN');
            }
        }
        
        // Set up event listeners
        toggleBtn.onclick = toggleSidebar;
        backdrop.onclick = toggleSidebar;
        
        // Close sidebar when escape key is pressed
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar.classList.contains('show')) {
                toggleSidebar(e);
            }
        });
        
        // Add hover effect to button
        toggleBtn.addEventListener('mouseover', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        toggleBtn.addEventListener('mouseout', function() {
            this.style.transform = 'scale(1)';
        });
        
        // Handle sidebar links on mobile
        document.addEventListener('DOMContentLoaded', function() {
            // Close sidebar when any link is clicked on mobile
            const sidebarLinks = document.querySelectorAll('.dashboard-sidebar a, .dashboard-sidebar .list-group-item');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 992 && sidebar.classList.contains('show')) {
                        toggleSidebar();
                    }
                });
            });
        });
        
        // Adjust for screen resize
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 992) {
                sidebar.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.classList.remove('sidebar-open');
                toggleBtn.innerHTML = '<i class="fas fa-grip-lines fs-3"></i>';
            }
        });
        
        console.log('Sidebar toggle fully initialized');
    })();
</script>

<script>
    // Final sidebar toggle fix - Replaces all previous handlers
    window.addEventListener('load', function() {
        // Get fresh references to elements
        const sidebar = document.querySelector('.dashboard-sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        const toggleBtn = document.getElementById('sidebarToggleBtn');
        
        if (!sidebar || !backdrop || !toggleBtn) {
            return;
        }
        
        // Clone and replace the button to remove all event listeners
        const newToggleBtn = toggleBtn.cloneNode(true);
        toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
        
        // Define a clean toggle function
        function finalToggleSidebar(e) {
            if (e) e.preventDefault();
            
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.classList.remove('sidebar-open');
                newToggleBtn.innerHTML = '<i class="fas fa-grip-lines fs-3"></i>';
            } else {
                sidebar.classList.add('show');
                backdrop.classList.add('show');
                document.body.classList.add('sidebar-open');
                newToggleBtn.innerHTML = '<i class="fas fa-times fs-3"></i>';
            }
        }
        
        // Add new event listener with capture phase to ensure it runs first
        newToggleBtn.addEventListener('click', finalToggleSidebar, true);
        
        // Add hover effects
        newToggleBtn.addEventListener('mouseover', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        newToggleBtn.addEventListener('mouseout', function() {
            this.style.transform = 'scale(1)';
        });
    });
</script>

{% endblock %}
{% endblock content %}
