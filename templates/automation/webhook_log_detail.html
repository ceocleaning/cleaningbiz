{% extends 'base.html' %}
{% load static %}

{% block title %}Webhook Log #{{ log.id }}{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        border-radius: 12px;
        overflow: hidden;
    }

    .detail-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 2rem;
    }

    .status-badge-large {
        font-size: 1rem;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-success {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-failed {
        background-color: #fee2e2;
        color: #b91c1c;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .info-row {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-light);
        transition: background-color 0.2s ease;
    }

    .info-row:hover {
        background-color: var(--light-color);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: var(--gray-color);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 1rem;
        color: var(--dark-color);
    }

    .json-viewer {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .json-key {
        color: #7dd3fc;
    }

    .json-string {
        color: #86efac;
    }

    .json-number {
        color: #fbbf24;
    }

    .json-boolean {
        color: #f472b6;
    }

    .json-null {
        color: #94a3b8;
    }

    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .copy-btn:hover {
        opacity: 1;
    }

    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .metadata-item {
        background-color: var(--light-color);
        padding: 1rem;
        border-radius: 8px;
        border-left: 3px solid var(--primary-color);
    }

    .error-box {
        background-color: #fee2e2;
        border-left: 4px solid #dc2626;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .traceback-box {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{% url 'webhook_logs' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Logs
        </a>
    </div>

    <!-- Header Card -->
    <div class="card detail-card mb-4">
        <div class="detail-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2 class="mb-2"><i class="fas fa-file-alt me-2"></i>Webhook Log #{{ log.id }}</h2>
                    <p class="mb-0 opacity-75">
                        <i class="fas fa-clock me-2"></i>
                        <span class="convert-timezone" data-utc-time="{{ log.created_at|date:'c' }}">
                            {{ log.created_at|date:'F d, Y H:i:s' }}
                        </span>
                    </p>
                </div>
                <div>
                    {% if log.status == 'success' %}
                    <span class="status-badge-large status-success">
                        <i class="fas fa-check-circle me-2"></i>Success
                    </span>
                    {% elif log.status == 'failed' %}
                    <span class="status-badge-large status-failed">
                        <i class="fas fa-times-circle me-2"></i>Failed
                    </span>
                    {% else %}
                    <span class="status-badge-large status-pending">
                        <i class="fas fa-clock me-2"></i>Pending
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Error Information (if failed) -->
    {% if log.status == 'failed' %}
    <div class="error-box">
        <h5 class="text-danger mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>Error Details
        </h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <strong>Error Code:</strong>
                <p class="mb-0">{{ log.error_code|default:'N/A' }}</p>
            </div>
            <div class="col-md-6 mb-3">
                <strong>Error Message:</strong>
                <p class="mb-0">{{ log.error_message|default:'N/A' }}</p>
            </div>
        </div>

        {% if log.webhook_data.traceback %}
        <div class="mt-3">
            <strong>Traceback:</strong>
            <div class="traceback-box mt-2">{{ log.webhook_data.traceback }}</div>
        </div>
        {% endif %}

        {% if log.webhook_data.missing_fields %}
        <div class="mt-3">
            <strong>Missing Fields:</strong>
            <p class="mb-0">
                {% for field in log.webhook_data.missing_fields %}
                <span class="badge bg-danger me-1">{{ field }}</span>
                {% endfor %}
            </p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="row">
        <!-- Basic Information -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                </div>
                <div class="card-body p-0">
                    <div class="info-row">
                        <div class="info-label">Log ID</div>
                        <div class="info-value">#{{ log.id }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Source</div>
                        <div class="info-value">
                            {% if log.lead_source == 'thumbtack' %}
                            <i class="fas fa-thumbtack text-primary me-2"></i>Thumbtack
                            {% else %}
                            <i class="fas fa-webhook text-secondary me-2"></i>Manual Webhook
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Status</div>
                        <div class="info-value">
                            {% if log.status == 'success' %}
                            <span class="badge bg-success">Success</span>
                            {% elif log.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% else %}
                            <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Created At</div>
                        <div class="info-value">
                            <span class="convert-timezone" data-utc-time="{{ log.created_at|date:'c' }}">
                                {{ log.created_at|date:'F d, Y H:i:s' }}
                            </span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Updated At</div>
                        <div class="info-value">
                            <span class="convert-timezone" data-utc-time="{{ log.updated_at|date:'c' }}">
                                {{ log.updated_at|date:'F d, Y H:i:s' }}
                            </span>
                        </div>
                    </div>
                    {% if lead %}
                    <div class="info-row">
                        <div class="info-label">Associated Lead</div>
                        <div class="info-value">
                            <a href="{% url 'lead_detail' lead.leadId %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-user me-2"></i>View Lead {{ lead.leadId }}
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Request Metadata -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Request Metadata</h5>
                </div>
                <div class="card-body">
                    {% if log.webhook_data.metadata %}
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <div class="info-label mb-2">IP Address</div>
                            <div class="info-value">
                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                {{ log.webhook_data.metadata.ip_address|default:'N/A' }}
                            </div>
                        </div>
                        <div class="metadata-item">
                            <div class="info-label mb-2">HTTP Method</div>
                            <div class="info-value">
                                <i class="fas fa-exchange-alt text-success me-2"></i>
                                {{ log.webhook_data.metadata.http_method|default:'N/A' }}
                            </div>
                        </div>
                        <div class="metadata-item">
                            <div class="info-label mb-2">Content Type</div>
                            <div class="info-value">
                                <i class="fas fa-file-code text-info me-2"></i>
                                {{ log.webhook_data.metadata.content_type|default:'N/A' }}
                            </div>
                        </div>
                        <div class="metadata-item">
                            <div class="info-label mb-2">User Agent</div>
                            <div class="info-value" style="font-size: 0.8rem; word-break: break-all;">
                                <i class="fas fa-browser text-secondary me-2"></i>
                                {{ log.webhook_data.metadata.user_agent|default:'N/A' }}
                            </div>
                        </div>
                    </div>

                    {% if log.webhook_data.metadata.headers %}
                    <div class="mt-3">
                        <h6 class="section-title">Headers</h6>
                        <div class="metadata-grid">
                            {% for key, value in log.webhook_data.metadata.headers.items %}
                            <div class="metadata-item">
                                <div class="info-label mb-1">{{ key }}</div>
                                <div class="info-value" style="font-size: 0.85rem;">{{ value|default:'N/A' }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted mb-0">No metadata available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Webhook Data -->
    {% if log.webhook_data.raw_data %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-code me-2"></i>Raw Webhook Data</h5>
            <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard('rawData')">
                <i class="fas fa-copy me-2"></i>Copy
            </button>
        </div>
        <div class="card-body p-0">
            <div class="position-relative">
                <pre class="json-viewer mb-0" id="rawData">{{ log.webhook_data.raw_data|safe }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Structured Data (for manual webhook) -->
    {% if log.webhook_data.structured_data %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-sitemap me-2"></i>ChatGPT Structured Data</h5>
            <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard('structuredData')">
                <i class="fas fa-copy me-2"></i>Copy
            </button>
        </div>
        <div class="card-body p-0">
            <div class="position-relative">
                <pre class="json-viewer mb-0" id="structuredData">{{ log.webhook_data.structured_data|safe }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Complete Webhook Data -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-database me-2"></i>Complete Webhook Data</h5>
            <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard('completeData')">
                <i class="fas fa-copy me-2"></i>Copy
            </button>
        </div>
        <div class="card-body p-0">
            <div class="position-relative">
                <pre class="json-viewer mb-0" id="completeData">{{ log.webhook_data|safe }}</pre>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(function () {
            // Show success message
            Toastify({
                text: "Copied to clipboard!",
                duration: 2000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
            }).showToast();
        }, function (err) {
            console.error('Could not copy text: ', err);
            Toastify({
                text: "Failed to copy",
                duration: 2000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
            }).showToast();
        });
    }

    // Format JSON in pre tags
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.json-viewer').forEach(function (element) {
            try {
                const text = element.textContent;
                const json = JSON.parse(text);
                element.innerHTML = syntaxHighlight(JSON.stringify(json, null, 2));
            } catch (e) {
                // If not valid JSON, leave as is
            }
        });
    });

    function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'json-number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'json-key';
                } else {
                    cls = 'json-string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'json-boolean';
            } else if (/null/.test(match)) {
                cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }
</script>
{% endblock %}