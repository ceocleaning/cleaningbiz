{% extends 'base.html' %}

{% block title %}Subscription & Plans{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="subscription-header">
        <div class="header-content">
            <div class="header-title-section">
                <h1 class="page-title">Subscription & Plans</h1>
                <p class="page-subtitle">Manage your subscription and usage limits</p>
            </div>
            <div class="header-actions">
                {% if business.square_card_id %}
                <button type="button" class="action-btn action-btn-outline" data-bs-toggle="modal" data-bs-target="#cardDetailsModal">
                    <i class="fas fa-credit-card"></i>
                    <span>Card Details</span>
                </button>
                {% else %}
                <a href="{% url 'subscription:manage_card' %}" class="action-btn action-btn-outline">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Card</span>
                </a>
                {% endif %}
                <a href="{% url 'subscription:billing_history' %}" class="action-btn action-btn-outline">
                    <i class="fas fa-history"></i>
                    <span>Billing History</span>
                </a>
                <a href="{% url 'subscription:renewal_logs' %}" class="action-btn action-btn-outline">
                    <i class="fas fa-sync-alt"></i>
                    <span>Renewal History</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="subscription-tabs">
        <ul class="nav nav-tabs custom-tabs" id="subscriptionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-home"></i>
                    <span>Overview</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="plans-tab" data-bs-toggle="tab" data-bs-target="#plans" type="button" role="tab">
                    <i class="fas fa-box"></i>
                    <span>Available Plans</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i>
                    <span>Usage & Limits</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq" type="button" role="tab">
                    <i class="fas fa-question-circle"></i>
                    <span>FAQ</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </li>
        </ul>
    </div>

    <!-- Tabs Content -->
    <div class="tab-content custom-tab-content" id="subscriptionTabsContent">
        
        <!-- OVERVIEW TAB -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
    {% if subscription %}
    <!-- Current Plan Card -->
    <div class="card border border-1 mb-4">
        <div class="card-header bg-white">
            <h5 class="m-0 fw-bold">Current Plan</h5>
        </div>
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div>
                    <h5 class="mb-0">{{ subscription.plan.display_name }}</h5>
                    <p class="text-muted mb-0">
                        ${{ subscription.plan.get_display_price }}{{ subscription.plan.get_display_label }}
                    </p>
                    {% if subscription.status == 'cancelled' %}
                    <div class="mt-2">
                        <span class="badge bg-warning">Cancelled</span>
                        <small class="text-muted d-block mt-1">
                            Valid until {{ subscription.end_date|date:"F d, Y" }}
                        </small>
                    </div>
                    {% endif %}
                </div>
                <div class="ms-auto">
                    {% if subscription.status == 'cancelled' %}
                        <span class="badge bg-warning p-2">Cancelled</span>
                    {% else %}
                        <span class="badge bg-success p-2">Active</span>
                    {% endif %}
                </div>
            </div>
            <div class="included-features mb-3">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>{{ subscription.plan.voice_minutes }} Voice Minutes</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>{{ subscription.plan.agents }} AI Agents</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>{{ subscription.plan.sms_messages }} SMS Messages</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>{{ subscription.plan.leads }} Leads</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>{{ subscription.plan.cleaners }} Cleaners</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                {% if subscription.status != 'cancelled' %}
                <div>
                    <p class="text-muted mb-0">
                        <i class="far fa-calendar-alt me-2"></i>
                        Next billing date: {{ subscription.end_date|date:"F j, Y" }}
                    </p>
                </div>
                {% endif %}
                <div class="ms-auto">
                 
                    {% if subscription.status != 'cancelled' %}
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelSubscriptionModal" data-plan-id="{{ subscription.plan.id }}" data-plan-name="{{ subscription.plan.name }}">
                        <i class="fas fa-times-circle me-1"></i> Cancel
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if next_plan and subscription.status != 'cancelled' %}
    <div class="alert alert-info mt-3">
        <div class="d-flex align-items-center">
            <div>
                <h6 class="mb-0">Future Plan Change Scheduled</h6>
                <p class="mb-0">Your subscription will change to <strong>{{ next_plan.name }}</strong> 
                (${{ next_plan.get_display_price }}{{ next_plan.get_display_label }}) 
                on your next billing date: 
                <strong>{{ subscription.end_date|date:"F d, Y" }}</strong>.</p>
            </div>
            <div class="ms-auto">
                <form method="post" class="cancel-plan-change-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times me-1"></i> Cancel Change
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
        </div>
        <!-- END OVERVIEW TAB -->

        <!-- USAGE TAB -->
        <div class="tab-pane fade" id="usage" role="tabpanel">
            <!-- Usage Status -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Current Usage</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Voice Minutes Usage -->
                                <div class="col-md-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Voice Minutes</span>
                                        <span class="fw-bold">{{ usage_summary.total.voice_minutes }} / {{ subscription.plan.voice_minutes }}</span>
                                    </div>
                                    <div class="progress mb-4" style="height: 10px;">
                                        {% if usage_summary.usage_percentage.voice_minutes >= 80 %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ usage_summary.usage_percentage.voice_minutes }}%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif usage_summary.usage_percentage.voice_minutes >= 50 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ usage_summary.usage_percentage.voice_minutes }}%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ usage_summary.usage_percentage.voice_minutes }}%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- SMS Usage -->
                                <div class="col-md-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>SMS</span>
                                        <span class="fw-bold">{{ usage_summary.total.sms_messages }} / {{ subscription.plan.sms_messages }}</span>
                                    </div>
                                    <div class="progress mb-4" style="height: 10px;">
                                        {% if usage_summary.usage_percentage.sms_messages >= 80 %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ usage_summary.usage_percentage.sms_messages }}%;" aria-valuenow="38" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif usage_summary.usage_percentage.sms_messages >= 50 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ usage_summary.usage_percentage.sms_messages }}%;" aria-valuenow="38" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ usage_summary.usage_percentage.sms_messages }}%;" aria-valuenow="38" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- SMS Messages Usage -->
                                <div class="col-md-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Leads</span>
                                        <span class="fw-bold">{{ usage_summary.total.leads_generated }} / {{ subscription.plan.leads }}</span>
                                    </div>
                                    <div class="progress mb-4" style="height: 10px;">
                                        {% if usage_summary.usage_percentage.leads_generated >= 80 %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ usage_summary.usage_percentage.leads_generated }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif usage_summary.usage_percentage.leads_generated >= 50 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ usage_summary.usage_percentage.leads_generated }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ usage_summary.usage_percentage.leads_generated }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Active Agents</span>
                                        <span class="fw-bold">{{usage_summary.total.active_agents}} / {{subscription.plan.agents}}</span>
                                    </div>
                                    <div class="progress mb-4" style="height: 10px;">
                                        {% if usage_summary.usage_percentage.active_agents >= 80 %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ usage_summary.usage_percentage.active_agents }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif usage_summary.usage_percentage.active_agents >= 50 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ usage_summary.usage_percentage.active_agents }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ usage_summary.usage_percentage.active_agents }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Cleaners Usage -->
                                <div class="col-md-3 mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Cleaners</span>
                                        <span class="fw-bold">{{ usage_summary.total.cleaners }} / {{ subscription.plan.cleaners }}</span>
                                    </div>
                                    <div class="progress mb-4" style="height: 10px;">
                                        {% if usage_summary.usage_percentage.cleaners >= 80 %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ usage_summary.usage_percentage.cleaners }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif usage_summary.usage_percentage.cleaners >= 50 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ usage_summary.usage_percentage.cleaners }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ usage_summary.usage_percentage.cleaners }}%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle fa-lg me-3"></i>
                                    <div>
                                        <p class="mb-0">Your current usage is within plan limits. You can view detailed analytics in the <a href="#" class="alert-link">Analytics Dashboard</a>.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- No Active Subscription Alert -->
            <div class="alert alert-warning mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                    <div>
                        <h5 class="alert-heading">No Active Subscription</h5>
                        <p class="mb-0">You don't currently have an active subscription. Select a plan below to access all features of the AI Voice Agent and other premium services.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <!-- END USAGE TAB -->

        <!-- PLANS TAB -->
        <div class="tab-pane fade" id="plans" role="tabpanel">
    <!-- Available Plans -->
    <div class="card border border-1 mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold">Available Plans</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="billingToggle">
                <label class="form-check-label" for="billingToggle">
                    <span id="billingCycle">Monthly</span>
                    <small class="text-muted" id="yearlySavings" style="display: none;">(Save 20%)</small>
                </label>
            </div>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for plan in plans %}
                {% if plan.billing_cycle == 'monthly' %}
                <div class="col plan-card" data-plan-type="monthly">
                    <div class="card h-100 {% if plan.id == subscription.plan.id %}border-primary{% endif %}">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">{{ plan.display_name }}</h5>
                            <div>
                                {% if plan.id == subscription.plan.id and subscription.status != 'cancelled' %}
                                    <span class="badge bg-primary">Current Plan</span>
                                {% endif %}
                                {% if next_plan and plan.id == next_plan.id and subscription.status != 'cancelled' %}
                                    <span class="badge bg-info">Future Plan</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <p class="price-tag text-center mb-3">
                                <span class="currency">$</span>
                                <span class="amount">{{ plan.price }}</span>
                                <span class="period">/month</span>
                            </p>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.voice_minutes }} Voice Minutes</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.sms_messages }} SMS Messages</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.leads }} Leads</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.agents }} Voice Agents</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.cleaners }} Cleaners</span>
                                </li>
                            </ul>
                            <div class="d-grid mt-auto">
                                    {% if subscription.plan.id == plan.id %}
                                        {% if subscription.status != 'cancelled' %}
                                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelSubscriptionModal" data-plan-id="{{ plan.id }}" data-plan-name="{{ plan.name }}">
                                            <i class="fas fa-times-circle me-1"></i> Cancel Plan
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-secondary" disabled>Cancelled</button>
                                        {% endif %}
                                    {% elif next_plan and plan.id == next_plan.id and subscription.status != 'cancelled' %}
                                        <button type="button" class="btn btn-secondary" disabled>Future Plan</button>
                                    {% elif subscription.is_active %}
                                        <form method="post" class="change-plan-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="new_plan_id" value="{{ plan.id }}">
                                            <input type="hidden" name="current_plan_id" value="{{ subscription.plan.id }}">
                                            <button type="submit" 
                                                class="btn change-plan-btn {% if plan.name == 'Professional Plan' %}btn-primary{% else %}btn-outline-primary{% endif %}"
                                                data-plan-name="{{ plan.name }}"
                                            >
                                                Change Plan
                                            </button>
                                            <div class="plan-loader" style="display: none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                            <div class="plan-message" style="display: none;"></div>
                                        </form>
                                        {% else %}
                                    <a href="{% url 'subscription:select_plan' plan.id %}" class="btn {% if plan.name == 'Professional Plan' %}btn-primary{% else %}btn-outline-primary{% endif %}">Select Plan</a>
                                    
                                    {% endif %}
                               
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if plan.billing_cycle == 'yearly' %}
                <div class="col plan-card" data-plan-type="yearly" style="display: none;">
                    <div class="card h-100 {% if plan.id == subscription.plan.id and subscription.status != 'cancelled' %}border-primary{% endif %}">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">{{ plan.display_name }}</h5>
                            <div>
                                {% if plan.id == subscription.plan.id and subscription.status != 'cancelled' %}
                                    <span class="badge bg-primary">Current</span>
                                {% endif %}
                                {% if next_plan and plan.id == next_plan.id and subscription.status != 'cancelled' %}
                                    <span class="badge bg-info">Future</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <p class="price-tag text-center mb-1">
                                <span class="currency">$</span>
                                <span class="amount-monthly">{{ plan.get_monthly_display_price|floatformat:2 }}</span>
                                <span class="period">/month</span>
                            </p>
                            <p class="text-center text-muted small mb-3">
                                <span>billed annually at ${{ plan.get_display_price|floatformat:2 }}</span>
                                <span class="badge bg-success ms-1">Save 20%</span>
                            </p>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.get_monthly_display_limits.voice_minutes }} Voice Minutes/month</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.get_monthly_display_limits.sms_messages }} SMS Messages/month</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.get_monthly_display_limits.leads }} Leads/month</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.agents }} Voice Agents</span>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>{{ plan.cleaners }} Cleaners</span>
                                </li>
                                {% if plan.features.basic_analytics and not plan.features.advanced_analytics %}
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Basic Analytics</span>
                                </li>
                                {% endif %}
                                {% if plan.features.advanced_analytics %}
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Advanced Analytics</span>
                                </li>
                                {% endif %}
                                {% if plan.features.custom_voice %}
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Custom Voice Options</span>
                                </li>
                                {% endif %}
                                {% if plan.features.priority_support %}
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Priority Support</span>
                                </li>
                                {% endif %}
                            </ul>
                            <div class="d-grid mt-auto">
                                {% if subscription %}
                                    {% if subscription.plan.id == plan.id %}
                                        {% if subscription.status != 'cancelled' %}
                                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelSubscriptionModal" data-plan-id="{{ plan.id }}" data-plan-name="{{ plan.name }}">
                                            <i class="fas fa-times-circle me-1"></i> Cancel Plan
                                        </button>
                                        {% endif %}
                                    {% elif next_plan and plan.id == next_plan.id %}
                                        <button type="button" class="btn btn-secondary" disabled>Future Plan</button>
                                    {% else %}
                                        <form method="post" class="change-plan-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="new_plan_id" value="{{ plan.id }}">
                                            <input type="hidden" name="current_plan_id" value="{{ subscription.plan.id }}">
                                            <button type="submit" 
                                                class="btn change-plan-btn {% if plan.name == 'Professional Plan' %}btn-primary{% else %}btn-outline-primary{% endif %}"
                                                data-plan-name="{{ plan.name }}"
                                            >
                                                Change Plan
                                            </button>
                                            <div class="plan-loader" style="display: none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                            <div class="plan-message" style="display: none;"></div>
                                        </form>
                                    {% endif %}
                                {% else %}
                                    <a href="{% url 'subscription:select_plan' plan.id %}" class="btn {% if plan.name == 'Professional Plan' %}btn-primary{% else %}btn-outline-primary{% endif %}">Select Plan</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% empty %}
                <div class="col-md-4 mx-auto">  
                    <h4 class="text-danger">No available plans.</h4>
                </div>
                {% endfor %}
            </div>

            {% if is_eligible_for_trial %}
                <div class="row mt-4">
                    <div class="col-md-4 mx-auto">
                        <div class="card h-100 border-primary">
                            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">{{ trial_plan.display_name }}</h5>
                                <span class="badge bg-primary">Trial</span>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <p class="price-tag text-center mb-3">
                                    <span class="currency">$</span>
                                    <span class="amount">{{ trial_plan.get_display_price }}</span>
                                </p>
                                <ul class="list-group list-group-flush mb-4">
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.voice_minutes }} Voice Minute</span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.sms_messages }} SMS Message</span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.leads }} Lead</span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.agents }} Voice Agent</span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{{ trial_plan.cleaners }} Cleaner</span>
                                    </li>
                                </ul>
                                <div class="d-grid mt-auto">
                                    <a href="{% url 'subscription:select_plan' trial_plan.id %}" class="btn btn-primary">Start Trial</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
        </div>
        <!-- END PLANS TAB -->

        <!-- FAQ TAB -->
        <div class="tab-pane fade" id="faq" role="tabpanel">
    <!-- FAQ Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <h2 class="h3">Frequently Asked Questions</h2>
            <p class="text-muted">Find answers to common questions about subscriptions and billing</p>
        </div>
        <div class="col-12">
            <div class="accordion" id="subscriptionFAQ">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            How do billing cycles work?
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#subscriptionFAQ">
                        <div class="accordion-body">
                            Your billing cycle begins on the day you subscribe to a plan. You'll be charged immediately and then again every month or year, depending on your billing frequency. All usage limits reset at the beginning of each billing cycle.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Can I upgrade or downgrade my plan at any time?
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#subscriptionFAQ">
                        <div class="accordion-body">
                            Yes, you can change your plan at any time. When upgrading, the new plan takes effect immediately and you'll be charged a prorated amount for the remainder of your billing cycle. When downgrading, the new plan will take effect at the start of your next billing cycle.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            How are overage charges calculated?
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#subscriptionFAQ">
                        <div class="accordion-body">
                            Overage charges are calculated based on usage beyond your plan limits. For example, if your plan includes 1000 voice minutes and you use 1100 minutes, you'll be charged for the additional 100 minutes at the overage rate. Overage charges are added to your next invoice.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            What happens if I cancel my subscription?
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#subscriptionFAQ">
                        <div class="accordion-body">
                            If you cancel your subscription, your plan will remain active until the end of your current billing cycle. After that, your account will revert to a limited functionality mode. You'll still be able to access your data, but you won't be able to use voice or SMS services without an active subscription.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFive">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            What features are restricted without a subscription?
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#subscriptionFAQ">
                        <div class="accordion-body">
                            Without an active subscription, you'll have limited access to the platform. You can still view your dashboard and basic account information, but you won't be able to use the AI Voice Agent, make outbound calls, send SMS messages, or access advanced analytics features. A subscription is required to use the core functionality of the platform.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
        <!-- END FAQ TAB -->

        <!-- SETTINGS TAB -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <!-- Auto-Upgrade Settings Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-rocket text-primary me-2"></i>
                                <h5 class="mb-0">Auto-Upgrade Settings</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="settings-item">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="flex-grow-1 me-3">
                                        <h6 class="mb-2">Automatic Plan Upgrade</h6>
                                        <p class="text-muted mb-0">
                                            Automatically upgrade to the next plan when your usage exceeds current limits. 
                                            This ensures uninterrupted service and prevents overage charges.
                                        </p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="auto-upgrade" 
                                               {% if business.auto_upgrade %}checked{% endif %}
                                               style="width: 3.5em; height: 1.75em;">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3 mb-0">
                                <div class="d-flex">
                                    <i class="fas fa-info-circle me-2 mt-1"></i>
                                    <small>
                                        When enabled, your plan will automatically upgrade when you reach 90% of any resource limit. 
                                        You'll be notified via email before the upgrade occurs.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coupon Settings Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-ticket-alt text-primary me-2"></i>
                                <h5 class="mb-0">Apply Coupon</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="couponCode" class="form-label fw-semibold">Coupon Code</label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="couponCode" 
                                           name="coupon_code" 
                                           placeholder="Enter your coupon code">
                                    <button class="btn btn-outline-primary" type="button" id="checkCouponBtn">
                                        <i class="fas fa-search me-2"></i>Check Coupon
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-tag me-1"></i>
                                    Enter a valid coupon code to receive a discount on your subscription
                                </small>
                            </div>

                            <!-- Coupon Validation Result -->
                            <div id="couponValidationResult" style="display: none;">
                                <!-- Success State -->
                                <div id="couponValidSuccess" class="coupon-validation-box success" style="display: none;">
                                    <div class="d-flex align-items-start mb-3">
                                        <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-2">Valid Coupon!</h6>
                                            <p class="mb-2"><strong id="validCouponCode"></strong> - <span id="validCouponDiscount"></span></p>
                                        </div>
                                    </div>
                                    
                                    <div class="pricing-breakdown">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Original Price:</span>
                                            <strong>$<span id="originalPrice">0.00</span></strong>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2 text-success">
                                            <span>Discount:</span>
                                            <strong>-$<span id="discountAmount">0.00</span></strong>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between mb-3">
                                            <span class="fw-bold">New Price:</span>
                                            <strong class="text-primary fs-5">$<span id="discountedPrice">0.00</span></strong>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-success w-100" id="applyCouponBtn">
                                        <i class="fas fa-check me-2"></i>Apply This Coupon
                                    </button>
                                </div>

                                <!-- Error State -->
                                <div id="couponValidError" class="coupon-validation-box error" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-times-circle fa-2x text-danger me-3"></i>
                                        <div>
                                            <h6 class="mb-1 text-danger">Invalid Coupon</h6>
                                            <p class="mb-0" id="couponErrorMessage"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if subscription.new_coupon %}
                            <div class="alert alert-success mt-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle fa-lg me-3"></i>
                                    <div>
                                        <h6 class="mb-1">Coupon Applied!</h6>
                                        <p class="mb-0">
                                            <strong>{{ subscription.new_coupon.code }}</strong> - 
                                            {% if subscription.new_coupon.discount_type == 'percentage' %}
                                                {{ subscription.new_coupon.discount_value }}% off
                                            {% else %}
                                                ${{ subscription.new_coupon.discount_value }} off
                                            {% endif %}
                                        </p>
                                        <small class="text-muted">
                                            Will be applied on your next billing cycle
                                            {% if subscription.new_coupon.valid_until %}
                                                 Valid until {{ subscription.new_coupon.valid_until|date:"F d, Y" }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% elif subscription.coupon_used %}
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle fa-lg me-3"></i>
                                    <div>
                                        <h6 class="mb-1">Active Coupon</h6>
                                        <p class="mb-0">
                                            <strong>{{ subscription.coupon_used.code }}</strong> - 
                                            {{ subscription.coupon_used.discount_percentage }}% off
                                        </p>
                                        <small class="text-muted">
                                            Valid until {{ subscription.coupon_used.valid_until|date:"F d, Y" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="coupon-info-box">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-lightbulb text-warning me-3 mt-1"></i>
                                    <div>
                                        <h6 class="mb-2">No Active Coupon</h6>
                                        <p class="text-muted small mb-0">
                                            You don't have any active coupons. Enter a valid coupon code above to get a discount on your subscription.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Billing Preferences Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-credit-card text-primary me-2"></i>
                                <h5 class="mb-0">Billing Preferences</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="settings-item mb-3">
                                <h6 class="mb-2">Payment Method</h6>
                                {% if business.square_card_id %}
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1">
                                            <i class="fas fa-credit-card text-primary me-2"></i>
                                            Card ending in  {{ card_details.last4|default:"****" }}
                                        </p>
                                        <small class="text-muted">Primary payment method</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#cardDetailsModal">
                                        <i class="fas fa-eye me-1"></i>View
                                    </button>
                                </div>
                                {% else %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No payment method on file. 
                                    <a href="{% url 'subscription:manage_card' %}" class="alert-link">Add a card</a>
                                </div>
                                {% endif %}
                            </div>

                            <hr>

                            <div class="settings-item">
                                <h6 class="mb-2">Billing History</h6>
                                <p class="text-muted mb-2">View your past invoices and payment history</p>
                                <a href="{% url 'subscription:billing_history' %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-history me-2"></i>View Billing History
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END SETTINGS TAB -->
        
    </div>
    <!-- END TAB CONTENT -->
</div>
<!-- END CONTAINER -->

<!-- Card Details Modal -->
<div class="modal fade" id="cardDetailsModal" tabindex="-1" aria-labelledby="cardDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="cardDetailsModalLabel">Payment Method Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Card Information -->
                <h6 class="mb-3">Card Information</h6>
                <div class=" bg-light p-4 mb-4">
                    <div class="d-flex align-items-center">
                        <div class="card-brand-icon text-primary me-4">
                            {% if card_details.card_brand == 'VISA' %}
                            <i class="fab fa-cc-visa fa-3x"></i>
                            {% elif card_details.card_brand == 'MASTERCARD' %}
                            <i class="fab fa-cc-mastercard fa-3x"></i>
                            {% elif card_details.card_brand == 'AMEX' %}
                            <i class="fab fa-cc-amex fa-3x"></i>
                            {% elif card_details.card_brand == 'DISCOVER' %}
                            <i class="fab fa-cc-discover fa-3x"></i>
                            {% else %}
                            <i class="far fa-credit-card fa-3x"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h5 class="mb-2">Card ending in {{ card_details.last4 }}</h5>
                            <p class="mb-0 text-muted">Expires {{ card_details.exp_month }}/{{ card_details.exp_year }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Information -->
                {% if customer_details %}
                <h6 class="mb-3">Billing Information</h6>
                <div class=" bg-light p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user text-primary me-2"></i>
                                <div>
                                    <small class="text-muted d-block">Name</small>
                                    <span>{{ customer_details.given_name }} {{ customer_details.family_name }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-envelope text-primary me-2"></i>
                                <div>
                                    <small class="text-muted d-block">Email</small>
                                    <span>{{ customer_details.email }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-phone text-primary me-2"></i>
                                <div>
                                    <small class="text-muted d-block">Phone</small>
                                    <span>{{ customer_details.phone }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <div>
                                    <small class="text-muted d-block">Added On</small>
                                    <span>{{ customer_details.created_at|date:"F j, Y" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <a href="{% url 'subscription:manage_card' %}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-2"></i> Update Card
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Subscription Modal -->
<div class="modal fade" id="cancelSubscriptionModal" tabindex="-1" aria-labelledby="cancelSubscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelSubscriptionModalLabel">Cancel Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelSubscriptionForm">
                {% csrf_token %}
                <input type="hidden" id="plan-id" name="plan_id">
                <div class="modal-body">
                    <p>Are you sure you want to cancel your subscription to <strong id="plan-name"></strong>?</p>
                    <p>Your subscription will be cancelled immediately and you will lose access to premium features.</p>
                    
                    <div class="loader" style="display: none; text-align: center; margin: 15px 0;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="message" style="display: none; margin-top: 15px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Confirm Cancellation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* ========== SUBSCRIPTION PAGE STYLES ========== */

/* Header Section */
.subscription-header {
    background: linear-gradient(135deg, #1aad8c 0%, #138a70 100%);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    color: white;
    box-shadow: 0 4px 16px rgba(26, 173, 140, 0.2);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 24px;
}

.header-title-section {
    flex: 1;
    min-width: 250px;
}

.page-title {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    color: white;
}

.page-subtitle {
    font-size: 16px;
    margin: 0;
    opacity: 0.9;
    color: white;
}

.header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.action-btn-outline {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.action-btn-outline:hover {
    background: white;
    color: #1aad8c;
    border-color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Tabs Styling */
.subscription-tabs {
    margin-bottom: 32px;
}

.custom-tabs {
    border: none;
    background: white;
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    display: flex;
    gap: 4px;
}

.custom-tabs .nav-item {
    flex: 1;
}

.custom-tabs .nav-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    border: none;
    border-radius: 8px;
    color: #6e6e6e;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.3s ease;
    background: transparent;
}

.custom-tabs .nav-link i {
    font-size: 18px;
}

.custom-tabs .nav-link:hover {
    background: #f3f4f6;
    color: #1aad8c;
}

.custom-tabs .nav-link.active {
    background: linear-gradient(135deg, #1aad8c 0%, #138a70 100%);
    color: white !important;
    border: none !important;
}

/* Tab Content */
.custom-tab-content {
    min-height: 400px;
}

.tab-pane {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Card Enhancements */
.card {
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.card-header {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-bottom: 1px solid #e5e7eb;
    border-radius: 12px 12px 0 0 !important;
    padding: 20px 24px;
}

.card-body {
    padding: 24px;
}

/* Plan Cards */
.plan-card .card {
    transition: all 0.3s ease;
    height: 100%;
}

.plan-card .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.plan-card .card.border-primary {
    border-color: #1aad8c;
    border-width: 2px;
}

.price-tag {
    font-size: 2.5rem;
    font-weight: 700;
    color: #202224;
    margin: 20px 0;
}

.price-tag .currency {
    font-size: 1.5rem;
    vertical-align: super;
    font-weight: 600;
}

.price-tag .period {
    font-size: 1.2rem;
    color: #6e6e6e;
    font-weight: 400;
}

/* List Group */
.list-group-item {
    border: none;
    padding: 12px 0;
    background: transparent;
}

.list-group-item i {
    font-size: 16px;
}

/* Progress Bars */
.progress {
    border-radius: 10px;
    background: #f3f4f6;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.6s ease;
}

/* Badges */
.badge {
    padding: 6px 12px;
    font-weight: 600;
    border-radius: 6px;
}

/* Alerts */
.alert {
    border-radius: 12px;
    border: none;
    padding: 20px;
}

.alert-info {
    background: #eff6ff;
    color: #1e40af;
}

.alert-warning {
    background: #fef3c7;
    color: #92400e;
}

/* Accordion */
.accordion-item {
    border: 1px solid #e5e7eb;
    border-radius: 12px !important;
    margin-bottom: 12px;
    overflow: hidden;
}

.accordion-button {
    font-weight: 600;
    color: #202224;
    background: white;
    padding: 18px 24px;
}

.accordion-button:not(.collapsed) {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    color: #1aad8c;
    box-shadow: none;
}

.accordion-button:focus {
    box-shadow: none;
    border-color: #e5e7eb;
}

.accordion-body {
    padding: 20px 24px;
    color: #6e6e6e;
    line-height: 1.6;
}

/* Buttons */
.btn {
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #1aad8c 0%, #138a70 100%);
    border: none;
    box-shadow: 0 2px 8px rgba(26, 173, 140, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(26, 173, 140, 0.4);
}

.btn-outline-primary {
    border: 2px solid #1aad8c;
    color: #1aad8c;
}

.btn-outline-primary:hover {
    background: #1aad8c;
    color: white;
    transform: translateY(-2px);
}

/* Form Controls */
.form-check-input:checked {
    background-color: #1aad8c;
    border-color: #1aad8c;
}

.form-switch .form-check-input {
    width: 3em;
    height: 1.5em;
}

/* Settings Tab Styles */
.settings-item {
    padding: 16px 0;
}

.settings-item h6 {
    font-weight: 600;
    color: #202224;
    margin-bottom: 8px;
}

.coupon-info-box {
    background: #fef3c7;
    border: 1px solid #fde68a;
    border-radius: 10px;
    padding: 16px;
}

.coupon-info-box h6 {
    color: #92400e;
    font-weight: 600;
}

.input-group .form-control-lg {
    border-radius: 10px 0 0 10px;
    border: 2px solid #e5e7eb;
    padding: 12px 16px;
}

.input-group .form-control-lg:focus {
    border-color: #1aad8c;
    box-shadow: 0 0 0 3px rgba(26, 173, 140, 0.1);
}

.input-group .btn {
    border-radius: 0 10px 10px 0;
}

.alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.alert-success h6 {
    color: #065f46;
}

/* Coupon Validation Boxes */
.coupon-validation-box {
    border-radius: 12px;
    padding: 20px;
    margin-top: 16px;
    animation: slideDown 0.3s ease-out;
}

.coupon-validation-box.success {
    background: #d1fae5;
    border: 2px solid #6ee7b7;
}

.coupon-validation-box.error {
    background: #fee2e2;
    border: 2px solid #fca5a5;
}

.pricing-breakdown {
    background: white;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
}

.pricing-breakdown hr {
    margin: 12px 0;
    border-color: #e5e7eb;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 991.98px) {
    .subscription-header {
        padding: 24px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .page-title {
        font-size: 28px;
    }
    
    .header-actions {
        width: 100%;
    }
    
    .action-btn {
        flex: 1;
        justify-content: center;
    }
    
    .custom-tabs {
        flex-wrap: wrap;
    }
    
    .custom-tabs .nav-link span {
        display: none;
    }
    
    .custom-tabs .nav-link {
        padding: 12px;
    }
}

@media (max-width: 767.98px) {
    .subscription-header {
        padding: 20px;
    }
    
    .page-title {
        font-size: 24px;
    }
    
    .page-subtitle {
        font-size: 14px;
    }
    
    .header-actions {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
    
    .custom-tabs .nav-item {
        flex: 0 0 50%;
    }
}
</style>

{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add enhanced styling for plan cards
        const style = document.createElement('style');
        style.textContent = `
            .price-tag {
                font-size: 1.8rem;
                font-weight: 600;
                color: #333;
            }
            .price-tag .currency {
                font-size: 1.2rem;
                vertical-align: super;
                font-weight: 500;
            }
            .price-tag .period {
                font-size: 1rem;
                color: #6c757d;
                font-weight: 400;
            }
            .card-header {
                padding: 1rem;
                border-bottom: 1px solid rgba(0,0,0,.125);
            }
            .list-group-item {
                padding: 0.75rem 1rem;
            }
            .list-group-item i {
                min-width: 20px;
            }
            .plan-card .card {
                transition: all 0.3s ease;
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            }
            .plan-card .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            }
            .border-primary {
                border-width: 2px !important;
            }
            .badge {
                padding: 0.5em 0.65em;
            }
        `;
        document.head.appendChild(style);
        
        // Toggle between monthly and yearly plans
        const billingToggle = document.getElementById('billingToggle');
        const billingCycleText = document.getElementById('billingCycle');
        const yearlySavings = document.getElementById('yearlySavings');
        const monthlyCards = document.querySelectorAll('.plan-card[data-plan-type="monthly"]');
        const yearlyCards = document.querySelectorAll('.plan-card[data-plan-type="yearly"]');
        
        billingToggle.addEventListener('change', function() {
            if (this.checked) {
                // Show yearly plans
                monthlyCards.forEach(card => card.style.display = 'none');
                yearlyCards.forEach(card => card.style.display = 'block');
                billingCycleText.textContent = 'Yearly';
                yearlySavings.style.display = 'inline';
            } else {
                // Show monthly plans
                monthlyCards.forEach(card => card.style.display = 'block');
                yearlyCards.forEach(card => card.style.display = 'none');
                billingCycleText.textContent = 'Monthly';
                yearlySavings.style.display = 'none';
            }
        });
        
        // Function to equalize card heights
        function equalizeCardHeights() {
            const cards = document.querySelectorAll('.plan-card .card');
            let maxHeight = 0;
            
            // Reset heights
            cards.forEach(card => {
                card.style.height = 'auto';
                maxHeight = Math.max(maxHeight, card.offsetHeight);
            });
            
            // Set all cards to max height
            cards.forEach(card => {
                card.style.height = maxHeight + 'px';
            });
        }
        
        // Initial equalization
        window.addEventListener('load', equalizeCardHeights);
        window.addEventListener('resize', equalizeCardHeights);

        // Add CSS for the loader
        const loaderStyle = document.createElement('style');
        loaderStyle.textContent = `
            .plan-loader {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 10px;
            }
            .plan-message {
                margin-top: 10px;
                padding: 8px;
                border-radius: 4px;
            }
            .btn:disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }
        `;
        document.head.appendChild(loaderStyle);

        // Handle cancel plan change
        const cancelPlanChangeForm = document.querySelector('.cancel-plan-change-form');
        if (cancelPlanChangeForm) {
            cancelPlanChangeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const button = this.querySelector('button[type="submit"]');
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                fetch('{% url "subscription:cancel_plan_change" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        const alertContainer = document.createElement('div');
                        alertContainer.className = 'alert alert-success mt-3';
                        alertContainer.textContent = data.message;
                        
                        // Insert the alert before the form's parent (the alert-info div)
                        const alertInfo = this.closest('.alert-info');
                        alertInfo.parentNode.insertBefore(alertContainer, alertInfo);
                        
                        // Remove the plan change info after a delay
                        setTimeout(() => {
                            alertInfo.remove();
                            // Reload the page after another delay
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        }, 1500);
                    } else {
                        // Show error message
                        const alertContainer = document.createElement('div');
                        alertContainer.className = 'alert alert-danger mt-3';
                        alertContainer.textContent = data.error;
                        this.closest('.alert-info').appendChild(alertContainer);
                        
                        // Reset button
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-times me-1"></i> Cancel Change';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Show error message
                    const alertContainer = document.createElement('div');
                    alertContainer.className = 'alert alert-danger mt-3';
                    alertContainer.textContent = 'An error occurred. Please try again.';
                    this.closest('.alert-info').appendChild(alertContainer);
                    
                    // Reset button
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-times me-1"></i> Cancel Change';
                });
            });
        }

        // Change plan functionality
        document.querySelectorAll('.change-plan-form').forEach(form => {
            form.addEventListener('submit', function(event) {
                const button = this.querySelector('button[type="submit"]');
                const planName = button.getAttribute('data-plan-name');
                const loader = this.querySelector('.plan-loader');
                const messageEl = this.querySelector('.plan-message');
                
                // Disable the button and show loading state
                button.disabled = true;
                loader.style.display = 'block';
                
                // Remove any existing messages
                messageEl.style.display = 'none';
                messageEl.textContent = '';
                
                // Send AJAX request
                fetch('{% url "subscription:change_plan" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        new_plan_id: this.querySelector('input[name="new_plan_id"]').value,
                        current_plan_id: this.querySelector('input[name="current_plan_id"]').value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Create message element
                    messageEl.className = `plan-message alert ${data.success ? 'alert-success' : 'alert-danger'}`;
                    messageEl.textContent = data.success ? data.message : data.error;
                    messageEl.style.display = 'block';
                    
                    // Reset button state
                    button.disabled = false;
                    loader.style.display = 'none';
                    
                    // If successful, reload page after 2 seconds to show updated state
                    if (data.success) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                    
                    // If redirect needed
                    if (!data.success && data.redirect_url) {
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 1500);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Create error message
                    messageEl.className = 'plan-message alert alert-danger';
                    messageEl.textContent = 'An error occurred. Please try again.';
                    messageEl.style.display = 'block';
                    
                    // Reset button state
                    button.disabled = false;
                    loader.style.display = 'none';
                });
                
                // Prevent default form submission
                event.preventDefault();
            });
        });

        // Cancel subscription functionality
        const cancelSubscriptionModal = document.getElementById('cancelSubscriptionModal');
        if (cancelSubscriptionModal) {
            const cancelSubscriptionForm = document.getElementById('cancelSubscriptionForm');
            const cancelButton = cancelSubscriptionForm.querySelector('button[type="submit"]');
            const loader = cancelSubscriptionForm.querySelector('.loader');
            const messageEl = cancelSubscriptionForm.querySelector('.message');
            const planIdInput = cancelSubscriptionForm.querySelector('input[name="plan_id"]');
            const planNameEl = cancelSubscriptionForm.querySelector('strong#plan-name');
            
            cancelSubscriptionModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const planId = button.getAttribute('data-plan-id');
                const planName = button.getAttribute('data-plan-name');
                
                planIdInput.value = planId;
                planNameEl.textContent = planName;
            });
            
            cancelSubscriptionForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Disable the button and show loading state
                cancelButton.disabled = true;
                loader.style.display = 'block';
                
                // Remove any existing messages
                messageEl.style.display = 'none';
                messageEl.textContent = '';
                
                // Send AJAX request
                fetch('{% url "subscription:cancel_subscription" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        plan_id: planIdInput.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Create message element
                    messageEl.className = `alert ${data.success ? 'alert-success' : 'alert-danger'}`;
                    messageEl.textContent = data.success ? data.message : data.error;
                    messageEl.style.display = 'block';
                    
                    // If successful, reload page after 2 seconds
                    if (data.success) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        // Reset button state
                        cancelButton.disabled = false;
                        loader.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Create error message
                    messageEl.className = 'alert alert-danger';
                    messageEl.textContent = 'An error occurred. Please try again.';
                    messageEl.style.display = 'block';
                    
                    // Reset button state
                    cancelButton.disabled = false;
                    loader.style.display = 'none';
                });
            });
        }

        // Auto-upgrade checkbox functionality
        const autoUpgradeCheckbox = document.getElementById('auto-upgrade');
        if (autoUpgradeCheckbox) {
            autoUpgradeCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                
                // Create a loading indicator
                let loadingIndicator = document.createElement('span');
                loadingIndicator.className = 'ms-2 spinner-border spinner-border-sm';
                loadingIndicator.setAttribute('role', 'status');
                loadingIndicator.innerHTML = '<span class="visually-hidden">Loading...</span>';
                
                // Add the loading indicator next to the checkbox
                this.parentNode.appendChild(loadingIndicator);
                
                // Disable the checkbox during the request
                this.disabled = true;
                
                // Send AJAX request to update auto-upgrade setting
                fetch('{% url "subscription:update_auto_upgrade" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        auto_upgrade: isChecked
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Remove the loading indicator
                    loadingIndicator.remove();
                    
                    // Re-enable the checkbox
                    this.disabled = false;
                    
                    if (data.success) {
                        // Show a success message
                        const successMessage = document.createElement('div');
                        successMessage.className = 'alert alert-success mt-2';
                        successMessage.textContent = data.message;
                        this.parentNode.appendChild(successMessage);
                        
                        // Remove the success message after 3 seconds
                        setTimeout(() => {
                            successMessage.remove();
                        }, 3000);
                    } else {
                        // Show an error message
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger mt-2';
                        errorMessage.textContent = data.message;
                        this.parentNode.appendChild(errorMessage);
                        
                        // Reset the checkbox to its previous state
                        this.checked = !isChecked;
                        
                        // Remove the error message after 3 seconds
                        setTimeout(() => {
                            errorMessage.remove();
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Remove the loading indicator
                    loadingIndicator.remove();
                    
                    // Re-enable the checkbox
                    this.disabled = false;
                    
                    // Reset the checkbox to its previous state
                    this.checked = !isChecked;
                    
                    // Show an error message
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger mt-2';
                    errorMessage.textContent = 'An error occurred. Please try again.';
                    this.parentNode.appendChild(errorMessage);
                    
                    // Remove the error message after 3 seconds
                    setTimeout(() => {
                        errorMessage.remove();
                    }, 3000);
                });
            });
        }

        // Coupon Validation and Application Flow
        const checkCouponBtn = document.getElementById('checkCouponBtn');
        const applyCouponBtn = document.getElementById('applyCouponBtn');
        const couponCodeInput = document.getElementById('couponCode');
        const couponValidationResult = document.getElementById('couponValidationResult');
        const couponValidSuccess = document.getElementById('couponValidSuccess');
        const couponValidError = document.getElementById('couponValidError');

        if (checkCouponBtn) {
            checkCouponBtn.addEventListener('click', function() {
                const couponCode = couponCodeInput.value.trim();
                
                if (!couponCode) {
                    alert('Please enter a coupon code');
                    return;
                }

                // Show loading state
                checkCouponBtn.disabled = true;
                checkCouponBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking...';

                // Hide previous results
                couponValidationResult.style.display = 'none';
                couponValidSuccess.style.display = 'none';
                couponValidError.style.display = 'none';

                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                // Validate coupon
                fetch('{% url "subscription:validate_coupon" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        coupon_code: couponCode,
                        plan_id: {{subscription.plan.id}}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    checkCouponBtn.disabled = false;
                    checkCouponBtn.innerHTML = '<i class="fas fa-search me-2"></i>Check Coupon';
                    
                    couponValidationResult.style.display = 'block';
                    
                    if (data.valid) {
                        // Show success state
                        couponValidSuccess.style.display = 'block';
                        document.getElementById('validCouponCode').textContent = data.coupon_code;
                        document.getElementById('validCouponDiscount').textContent = data.discount_description;
                        document.getElementById('originalPrice').textContent = data.original_price.toFixed(2);
                        document.getElementById('discountAmount').textContent = data.discount_amount.toFixed(2);
                        document.getElementById('discountedPrice').textContent = data.discounted_price.toFixed(2);
                    } else {
                        // Show error state
                        couponValidError.style.display = 'block';
                        document.getElementById('couponErrorMessage').textContent = data.message;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    checkCouponBtn.disabled = false;
                    checkCouponBtn.innerHTML = '<i class="fas fa-search me-2"></i>Check Coupon';
                    
                    couponValidationResult.style.display = 'block';
                    couponValidError.style.display = 'block';
                    document.getElementById('couponErrorMessage').textContent = 'An error occurred. Please try again.';
                });
            });
        }

        if (applyCouponBtn) {
            applyCouponBtn.addEventListener('click', function() {
                const couponCode = couponCodeInput.value.trim();
                
                if (!couponCode) {
                    alert('Please enter a coupon code');
                    return;
                }

                // Show loading state
                applyCouponBtn.disabled = true;
                applyCouponBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Applying...';

                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                // Apply coupon
                fetch('{% url "subscription:apply_coupon" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: `coupon_code=${encodeURIComponent(couponCode)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message and reload page
                        alert(data.message);
                        window.location.reload();
                    } else {
                        // Show error message
                        applyCouponBtn.disabled = false;
                        applyCouponBtn.innerHTML = '<i class="fas fa-check me-2"></i>Apply This Coupon';
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    applyCouponBtn.disabled = false;
                    applyCouponBtn.innerHTML = '<i class="fas fa-check me-2"></i>Apply This Coupon';
                    alert('An error occurred. Please try again.');
                });
            });
        }

        // Allow Enter key to trigger check coupon
        if (couponCodeInput) {
            couponCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    checkCouponBtn.click();
                }
            });
        }
    });
</script>
{% endblock %}