{% extends 'base.html' %}
{% load timezone_tags %}

{% block title %}Book a Cleaning Service{% endblock %}


{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'bookings:all_bookings' %}">Bookings</a></li>
                <li class="breadcrumb-item active">Create Booking</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Left Column - Booking Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="px-3 py-3"><i class="fas fa-calendar-plus me-2"></i>Book a Cleaning Service</h2>
                
                <!-- Progress Bar -->
                <div class="px-3">
                    <div class="progress">
                        <div id="form-progress" class="progress-bar" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">20%</div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="step-indicator active" id="step1-indicator">Customer</span>
                        <span class="step-indicator" id="step2-indicator">Address</span>
                        <span class="step-indicator" id="step3-indicator">Service</span>
                        <span class="step-indicator" id="step4-indicator">Property</span>
                        <span class="step-indicator" id="step5-indicator">Add-ons</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body px-4 py-4">
                <form id="booking-form" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" id="subtotal" name="subtotal" value="0" />
                <input type="hidden" id="tax" name="tax" value="0" />
                <input type="hidden" id="totalAmount" name="totalAmount" value="0" />
                   
                  
                <!-- Step 1: Customer Information -->
                <div class="form-step" id="step1">
                    <h5 class="mb-4"><i class="fas fa-user me-2"></i>Customer Information</h5>
                    
                    <!-- Customer Type Toggle -->
                    <div class="mb-4">
                        <label class="form-label">Customer Type</label>
                        <div class="btn-group w-100" role="group" aria-label="Customer Type">
                            <input type="radio" class="btn-check" name="customerType" id="newCustomer" value="new" checked>
                            <label class="btn btn-outline-primary" for="newCustomer">New Customer</label>
                            
                            <input type="radio" class="btn-check" name="customerType" id="regularCustomer" value="regular">
                            <label class="btn btn-outline-primary" for="regularCustomer">Regular Customer</label>
                        </div>
                    </div>
                    
                    <!-- Regular Customer Selection (initially hidden) -->
                    <div id="regularCustomerSection" class="mb-4" style="display: none;">
                        <label for="customerId" class="form-label">Select Customer</label>
                        <select class="form-select" id="customerId" name="customerId">
                            <option value="" selected disabled>Select a customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.first_name }} {{ customer.last_name }} ({{ customer.email }})</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" id="selectedCustomerId" name="selectedCustomerId" value="">

                        
                    </div>
                    
                    <!-- New Customer Fields -->
                    <div id="newCustomerFields">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="john.doe@example.com" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phoneNumber" class="form-label">Phone Number</label>
                                <div class="d-flex">
                                    <div class="input-group me-2" style="width: 150px;">
                                        <span class="input-group-text">+</span>
                                        <select class="form-select" id="countryCode" name="countryCode">
                                            <option value="1" selected>1</option>
                                            <option value="44">44</option>
                                            <option value="49">49</option>
                                            <option value="61">61</option>
                                            <option value="86">86</option>
                                            <option value="91">91</option>
                                            <option value="92">92</option>
                                        </select>
                                    </div>
                                    <input type="tel" 
                                        class="form-control" 
                                        id="phoneNumber" 
                                        name="phoneNumber" 
                                        placeholder="555 123 4567"
                                        pattern="^\d{3}[\s-]?\d{3}[\s-]?\d{4}$"
                                        title="Format: Area code and phone number (e.g., 555 123 4567)"
                                        required>
                                </div>
                            </div>
                            <small class="form-text text-muted">Select country code and enter your phone number</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 2: Address Information -->
                <div class="form-step" id="step2" style="display: none;">
                    <h5 class="mb-4"><i class="fas fa-map-marker-alt me-2"></i>Address Information</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="address1" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address1" name="address1" placeholder="123 Main Street" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city" placeholder="New York" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="stateOrProvince" class="form-label">State/Province</label>
                            <input type="text" class="form-control" id="stateOrProvince" name="stateOrProvince" placeholder="NY" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="zipCode" class="form-label">ZIP Code</label>
                            <input type="text" class="form-control" id="zipCode" name="zipCode" placeholder="10001" required>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 3: Service Details -->
                <div class="form-step" id="step3" style="display: none;">
                    <h5 class="mb-4"><i class="fas fa-broom me-2"></i>Service Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cleaningDate" class="form-label">Cleaning Date <small class="text-muted">({{ request.user.customer.timezone }})</small></label>
                            <input type="date" class="form-control" id="cleaningDate" name="cleaningDate" required min="{{ today|date:'Y-m-d' }}">
                            <input type="hidden" id="businessTimezone" value="{{ request.user.customer.timezone }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Start Time <small class="text-muted">({{ request.user.customer.timezone }})</small></label>
                            <select class="form-control form-select" id="startTime" name="startTime" required>
                                <option value="">Select Time</option>
                                <option value="06:00">6:00 AM</option>
                                <option value="07:00">7:00 AM</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                            </select>
                        </div>
                        
                        <!-- Availability Checking UI -->
                        <div class="col-12">
                            <div id="availability-alert" style="display: none;" class="alert mt-2">
                                <div id="availability-message"></div>
                            </div>
                            
                            <!-- Alternative slots suggestion -->
                            <div id="alternative-slots" style="display: none;" class="mt-3">
                                <h6 class="mb-2">Alternative Available Slots:</h6>
                                <div id="alt-slots-list" class="d-flex flex-wrap gap-2 mb-3"></div>
                            </div>
            
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="serviceType" class="form-label">Service Type</label>
                            <select class="form-control form-select" name="serviceType" id="serviceType" required>
                                <option value="" disabled>Select a service type</option>
                                <option value="standard" selected>Standard Cleaning</option>
                                <option value="deep">Deep Cleaning</option>
                                <option value="moveinmoveout">Move In/Move Out</option>
                                <option value="airbnb">Airbnb Cleaning</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="recurring" class="form-label">Recurring Service</label>
                            <select class="form-control form-select" name="recurring" id="recurring">
                                <option value="" disabled>Select frequency</option>
                                <option value="one-time" selected>One Time</option>
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 4: Property Details -->
                <div class="form-step" id="step4" style="display: none;">
                    <h5 class="mb-4"><i class="fas fa-home me-2"></i>Property Details</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="bedrooms" class="form-label">Number of Bedrooms</label>
                            <input type="number" class="form-control property-input" id="bedrooms" name="bedrooms" min="0" placeholder="2" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="bathrooms" class="form-label">Number of Bathrooms</label>
                            <input type="number" class="form-control property-input" id="bathrooms" name="bathrooms" min="0" placeholder="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="squareFeet" class="form-label">Square Footage</label>
                            <input type="number" class="form-control property-input" id="squareFeet" name="squareFeet" min="100" placeholder="1000" required>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 5: Add-on Services -->
                <div class="form-step" id="step5" style="display: none;">
                    <h5 class="mb-4"><i class="fas fa-plus me-2"></i>Add-on Services</h5>
                    
                    <!-- Standard Add-ons -->
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="addonDishes" class="form-label">Dishes</label>
                            <input type="number" class="form-control addon-input" id="addonDishes" name="addonDishes" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addonLaundryLoads" class="form-label">Laundry Loads</label>
                            <input type="number" class="form-control addon-input" id="addonLaundryLoads" name="addonLaundryLoads" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addonWindowCleaning" class="form-label">Window Cleaning</label>
                            <input type="number" class="form-control addon-input" id="addonWindowCleaning" name="addonWindowCleaning" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addonPetsCleaning" class="form-label">Pet Cleaning</label>
                            <input type="number" class="form-control addon-input" id="addonPetsCleaning" name="addonPetsCleaning" min="0" value="0">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="addonFridgeCleaning" class="form-label">Fridge Cleaning</label>
                            <input type="number" class="form-control addon-input" id="addonFridgeCleaning" name="addonFridgeCleaning" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addonOvenCleaning" class="form-label">Oven Cleaning</label>
                            <input type="number" class="form-control addon-input" id="addonOvenCleaning" name="addonOvenCleaning" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addonBaseboard" class="form-label">Baseboard</label>
                            <input type="number" class="form-control addon-input" id="addonBaseboard" name="addonBaseboard" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addonBlinds" class="form-label">Blinds</label>
                            <input type="number" class="form-control addon-input" id="addonBlinds" name="addonBlinds" min="0" value="0">
                        </div>
                    </div>

                    <!-- Custom Add-ons -->
                    {% if customAddons %}
                    <h6 class="mb-3 mt-4"><i class="fas fa-star me-2"></i>Custom Add-ons</h6>
                    <div class="row">
                        {% for addon in customAddons %}
                        <div class="col-md-3 mb-3">
                            <label for="custom_addon_{{ addon.id }}" class="form-label">{{ addon.addonName }}</label>
                            <input type="number" class="form-control custom-addon-input" 
                                id="custom_addon_{{ addon.id }}" 
                                name="custom_addon_qty_{{ addon.id }}" 
                                min="0" value="0"
                                data-price="{{ addon.addonPrice }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Additional Information -->
                    <h6 class="mb-3 mt-4"><i class="fas fa-info-circle me-2"></i>Special Requests</h6>
                    <div class="mb-3">
                        <textarea class="form-control" id="otherRequests" name="otherRequests" rows="3" placeholder="Any special requests or notes?"></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                        <button type="submit" class="btn btn-primary" id="submitBookingBtn">
                            <i class="fas fa-check me-2"></i>Submit Booking
                        </button>
                    </div>
                </div>

<!-- Right Column - Booking Summary -->
</form>
</div>
</div>
</div>

<!-- Right Column - Booking Summary -->
<div class="col-lg-4">
    <div class="card sticky-top" style="top: 20px;">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Service Overview</h5>
        </div>
        <div class="card-body">


            <!-- Service Details -->
            <div class="mb-4">
                <h6 class="text-muted mb-3">Service Details</h6>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Service Type:</span>
                        <span class="fw-medium" id="overview-service">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Date & Time:</span>
                        <span class="fw-medium" id="overview-datetime">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Bedrooms:</span>
                        <span class="fw-medium" id="overview-bedrooms">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Bathrooms:</span>
                        <span class="fw-medium" id="overview-bathrooms">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Square Feet:</span>
                        <span class="fw-medium" id="overview-squarefeet">-</span>
                    </div>
                </div>
            </div>

            <!-- Add-ons Summary -->
            <div class="mb-4">
                <h6 class="text-muted mb-3">Add-ons</h6>
                <div id="overview-addons-list">
                    <p class="text-muted small">No add-ons selected</p>
                </div>
            </div>

            <!-- Pricing Summary -->
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="mb-3">Price Summary</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Base Price:</span>
                        <span class="fw-medium">$<span id="overview-base-price">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Add-ons:</span>
                        <span class="fw-medium">$<span id="overview-addons-price">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-medium">$<span id="overview-subtotal">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax ({{ business.settings.taxPercent }}%):</span>
                        <span class="fw-medium">$<span id="overview-tax">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between pt-2 border-top mt-2">
                        <span class="fw-bold">Total:</span>
                        <span class="fw-bold text-primary">$<span id="overview-total">0.00</span></span>
                    </div>
                </div>
                
                <!-- Submit Button for Booking -->                
                <div class="mt-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rightColumnTermsCheck" required checked>
                        <label class="form-check-label small" for="rightColumnTermsCheck">
                            I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="rightColumnSubmitBtn" form="booking-form">
                        <i class="fas fa-check me-2"></i>Confirm Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Customer type toggle functionality
        const newCustomerRadio = document.getElementById('newCustomer');
        const regularCustomerRadio = document.getElementById('regularCustomer');
        const regularCustomerSection = document.getElementById('regularCustomerSection');
        const newCustomerFields = document.getElementById('newCustomerFields');
        const customerIdSelect = document.getElementById('customerId');
        const selectedCustomerIdInput = document.getElementById('selectedCustomerId');
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const emailInput = document.getElementById('email');
        const phoneNumberInput = document.getElementById('phoneNumber');
        
        // Function to toggle between customer types
        function toggleCustomerType() {
            if (newCustomerRadio.checked) {
                // Show new customer fields, hide regular customer dropdown
                newCustomerFields.style.display = 'block';
                regularCustomerSection.style.display = 'none';
                
                // Make new customer fields required
                firstNameInput.required = true;
                lastNameInput.required = true;
                emailInput.required = true;
                phoneNumberInput.required = true;
                
                // Clear selected customer ID
                selectedCustomerIdInput.value = '';
            } else {
                // Show regular customer dropdown, hide new customer fields
                newCustomerFields.style.display = 'none';
                regularCustomerSection.style.display = 'block';
                
                // Make new customer fields not required
                firstNameInput.required = false;
                lastNameInput.required = false;
                emailInput.required = false;
                phoneNumberInput.required = false;
            }
        }
        
        // Handle customer selection change
        customerIdSelect.addEventListener('change', function() {
            selectedCustomerIdInput.value = this.value;
        });
        
        // Add event listeners to radio buttons
        newCustomerRadio.addEventListener('change', toggleCustomerType);
        regularCustomerRadio.addEventListener('change', toggleCustomerType);
        
        // Initialize the form based on default selection
        toggleCustomerType();
        
        // Get pricing data from server
        const pricingData = JSON.parse('{{ prices|safe }}');
        
        // Base price from business settings
        const BASE_PRICE = pricingData.base_price || 0;

        // Pricing constants from business settings
        const BEDROOM_PRICE = pricingData.bedrooms || 0;
        const BATHROOM_PRICE = pricingData.bathrooms || 0;
        const SQUARE_FOOT_MULTIPLIERS = {
            'standard': pricingData.sqftMultiplierStandard || 0,
            'deep': pricingData.sqftMultiplierDeep || 0,
            'moveinout': pricingData.sqftMultiplierMoveinout || 0,
            'airbnb': pricingData.sqftMultiplierAirbnb || 0
        };
        
        const ADDON_PRICES = {
            'addonDishes': pricingData.addonPriceDishes || 0,
            'addonLaundryLoads': pricingData.addonPriceLaundry || 0,
            'addonWindowCleaning': pricingData.addonPriceWindow || 0,
            'addonPetsCleaning': pricingData.addonPricePets || 0,
            'addonFridgeCleaning': pricingData.addonPriceFridge || 0,
            'addonOvenCleaning': pricingData.addonPriceOven || 0,
            'addonBaseboard': pricingData.addonPriceBaseboard || 0,
            'addonBlinds': pricingData.addonPriceBlinds || 0
        };
        
        const TAX_RATE = pricingData.tax ? (pricingData.tax / 100) : 0.08;
        
        // Form steps navigation
        const formSteps = document.querySelectorAll('.form-step');
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');
        const progressBar = document.getElementById('form-progress');
        const stepIndicators = document.querySelectorAll('.step-indicator');
        
        let currentStep = 0;
        
        // Initialize the form
        updateProgressBar();
        

        // Next button click handler
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    formSteps[currentStep].style.display = 'none';
                    
                    // Skip Step 2 (Address Information) if Regular Customer is selected and we're on Step 1
                    if (currentStep === 0 && regularCustomerRadio.checked) {
                        currentStep += 2; // Skip to Step 3
                    } else {
                        currentStep++;
                    }
                    
                    formSteps[currentStep].style.display = 'block';
                    updateProgressBar();
                    
                    // Scroll to top of the form
                    document.querySelector('.card-body').scrollTop = 0;
                }
            });
        });
        
        // Previous button click handler
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                formSteps[currentStep].style.display = 'none';
                
                // If Regular Customer is selected, handle special navigation
                if (regularCustomerRadio.checked) {
                    // If we're on Step 3 or Step 4, go back to Step 1 or Step 3 respectively
                    if (currentStep === 2) {
                        currentStep = 0; // Skip Step 2, go back to Step 1
                    } 
                    else {
                        currentStep--; // Normal behavior for other steps
                    }
                } else {
                    // Normal behavior for new customers
                    currentStep--;
                }
                
                formSteps[currentStep].style.display = 'block';
                updateProgressBar();
            });
        });
        
        // Update progress bar and step indicators
        function updateProgressBar() {
            // Calculate total steps (4 if regular customer, 5 if new customer)
            const totalSteps = regularCustomerRadio.checked ? 4 : 5;
            
            // Calculate current step number (adjust for display)
            let displayStep = currentStep + 1;
            
            // If regular customer and past step 1, adjust the display step
            if (regularCustomerRadio.checked && currentStep > 0) {
                // Step 3 becomes step 2, step 4 becomes step 3, etc.
                displayStep = currentStep;
            }
            
            // Calculate progress percentage
            const progress = (displayStep / totalSteps) * 100;
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = Math.round(progress) + '%';
            
            // Update step indicators
            stepIndicators.forEach((indicator, index) => {
                // Skip step 2 indicator if regular customer
                if (regularCustomerRadio.checked && index === 1) {
                    indicator.classList.remove('active', 'completed');
                    return;
                }
                
                if (index === currentStep) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else if (index < currentStep) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            });
        }
        
        // Validate current step
        function validateStep(step) {
            const currentStepEl = formSteps[step];
            let isValid = true;
            
            // Special validation for step 1 (customer information)
            if (step === 0) {
                // Check if regular customer is selected
                if (regularCustomerRadio.checked) {
                    // Validate customer selection
                    if (!customerIdSelect.value) {
                        isValid = false;
                        customerIdSelect.classList.add('is-invalid');
                    } else {
                        customerIdSelect.classList.remove('is-invalid');
                    }
                } else {
                    // Validate new customer fields
                    const newCustomerRequiredFields = newCustomerFields.querySelectorAll('[required]');
                    newCustomerRequiredFields.forEach(field => {
                        if (!field.value) {
                            isValid = false;
                            field.classList.add('is-invalid');
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });
                }
            } else {
                // Normal validation for other steps
                const requiredFields = currentStepEl.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value) {
                        isValid = false;
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
            }
            
            return isValid;
        }
        
        // Real-time price calculation
        function calculatePrices() {
            // Get service type
            const serviceType = document.getElementById('serviceType').value;
            
            // Calculate base price with service type multiplier
            let basePrice = BASE_PRICE
            
            // Get property details
            const bedrooms = parseInt(document.getElementById('bedrooms').value) || 0;
            const bathrooms = parseInt(document.getElementById('bathrooms').value) || 0;
            const squareFeet = parseInt(document.getElementById('squareFeet').value) || 0;
            
            // Calculate property price
            const bedroomCost = bedrooms * BEDROOM_PRICE;
            const bathroomCost = bathrooms * BATHROOM_PRICE;
            const squareFeetCost = squareFeet * (SQUARE_FOOT_MULTIPLIERS[serviceType] || 0);
            const propertyPrice = bedroomCost + bathroomCost + squareFeetCost;
            
            // Calculate add-ons price
            let addonsPrice = 0;
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput) {
                    const quantity = parseInt(addonInput.value) || 0;
                    addonsPrice += quantity * ADDON_PRICES[addon];
                }
            });
            
            // Calculate custom add-ons price
            const customAddonInputs = document.querySelectorAll('.custom-addon-input');
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                addonsPrice += quantity * price;
            });
            
            // Calculate subtotal, tax and total
            const subtotal = basePrice + propertyPrice + addonsPrice;
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;
            
            // Update hidden inputs
            document.getElementById('subtotal').value = subtotal.toFixed(2);
            document.getElementById('tax').value = tax.toFixed(2);
            document.getElementById('totalAmount').value = total.toFixed(2);
            
            // Update overview section
            document.getElementById('overview-service').textContent = document.getElementById('serviceType').options[document.getElementById('serviceType').selectedIndex].text;
            
            const cleaningDate = document.getElementById('cleaningDate').value;
            const startTime = document.getElementById('startTime').value;
            if (cleaningDate && startTime) {
                const dateObj = new Date(cleaningDate + 'T' + startTime);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };
                document.getElementById('overview-datetime').textContent = dateObj.toLocaleDateString('en-US', options);
            }
            
            document.getElementById('overview-bedrooms').textContent = bedrooms;
            document.getElementById('overview-bathrooms').textContent = bathrooms;
            document.getElementById('overview-squarefeet').textContent = squareFeet + ' sq ft';
            
            // Update add-ons list
            const addonsList = document.getElementById('overview-addons-list');
            addonsList.innerHTML = '';
            
            let hasAddons = false;
            
            // Standard add-ons
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput && parseInt(addonInput.value) > 0) {
                    hasAddons = true;
                    const quantity = parseInt(addonInput.value);
                    const price = ADDON_PRICES[addon] * quantity;
                    const addonName = addonInput.previousElementSibling.textContent;
                    
                    const addonItem = document.createElement('div');
                    addonItem.className = 'd-flex justify-content-between mb-1';
                    addonItem.innerHTML = `
                        <span class="small">${addonName} (${quantity})</span>
                        <span class="small">$${price.toFixed(2)}</span>
                    `;
                    addonsList.appendChild(addonItem);
                }
            });
            
            // Custom add-ons
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    hasAddons = true;
                    const price = parseFloat(input.dataset.price) * quantity;
                    const addonName = input.previousElementSibling.textContent;
                    
                    const addonItem = document.createElement('div');
                    addonItem.className = 'd-flex justify-content-between mb-1';
                    addonItem.innerHTML = `
                        <span class="small">${addonName} (${quantity})</span>
                        <span class="small">$${price.toFixed(2)}</span>
                    `;
                    addonsList.appendChild(addonItem);
                }
            });
            
            if (!hasAddons) {
                addonsList.innerHTML = '<p class="text-muted small">No add-ons selected</p>';
            }
            
            // Update price overview
            document.getElementById('overview-base-price').textContent = (basePrice + propertyPrice).toFixed(2);
            document.getElementById('overview-addons-price').textContent = addonsPrice.toFixed(2);
            document.getElementById('overview-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('overview-tax').textContent = tax.toFixed(2);
            document.getElementById('overview-total').textContent = total.toFixed(2);
            
            // Hidden inputs still needed for form submission
            // No need to update summary section elements as they've been removed
        }
        
        // Handle the submit button
        const rightColumnSubmitBtn = document.getElementById('rightColumnSubmitBtn');
        
        // Make sure the form is validated before submission
        document.getElementById('booking-form').addEventListener('submit', function(event) {
            // Validate all steps before submission
            let isValid = true;
            
            for (let i = 0; i < formSteps.length; i++) {
                // Skip Step 2 validation for regular customers
                if (regularCustomerRadio.checked && i === 1) {
                    continue;
                }
                
                if (!validateStep(i)) {
                    isValid = false;
                    // Show the step with errors
                    formSteps[currentStep].style.display = 'none';
                    currentStep = i;
                    formSteps[currentStep].style.display = 'block';
                    updateProgressBar();
                    break;
                }
            }
            
            // Check if terms checkbox is checked
            const rightColumnTermsCheck = document.getElementById('rightColumnTermsCheck');
            if (!rightColumnTermsCheck.checked) {
                rightColumnTermsCheck.classList.add('is-invalid');
                isValid = false;
            } else {
                rightColumnTermsCheck.classList.remove('is-invalid');
            }
            
            // Special handling for customer type
            if (regularCustomerRadio.checked && !customerIdSelect.value) {
                isValid = false;
                // Show the first step with customer selection
                formSteps[currentStep].style.display = 'none';
                currentStep = 0;
                formSteps[currentStep].style.display = 'block';
                updateProgressBar();
                // Mark the customer selection as invalid
                customerIdSelect.classList.add('is-invalid');
            }
            
            if (!isValid) {
                event.preventDefault();
            }
        });
        
        // Attach event listeners for real-time calculation
        document.getElementById('serviceType').addEventListener('change', calculatePrices);
        document.getElementById('bedrooms').addEventListener('input', calculatePrices);
        document.getElementById('bathrooms').addEventListener('input', calculatePrices);
        document.getElementById('squareFeet').addEventListener('input', calculatePrices);
        
        // Add-on inputs
        const addonInputs = document.querySelectorAll('.addon-input');
        addonInputs.forEach(input => {
            input.addEventListener('input', calculatePrices);
        });
        
        // Custom add-on inputs
        const customAddonInputs = document.querySelectorAll('.custom-addon-input');
        customAddonInputs.forEach(input => {
            input.addEventListener('input', calculatePrices);
        });
        
        // Date and time inputs
        document.getElementById('cleaningDate').addEventListener('change', function() {
            calculatePrices();
            checkAvailability();
        });
        document.getElementById('startTime').addEventListener('change', function() {
            calculatePrices();
            checkAvailability();
        });
        
        // Initialize calculation
        calculatePrices();
        
        // Function to get user's timezone
        function getUserTimezone() {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                console.error('Error getting timezone:', e);
                return 'UTC';
            }
        }
        
        // Check availability function
        function checkAvailability() {
            const date = document.getElementById('cleaningDate').value;
            const time = document.getElementById('startTime').value;
            
            // Get timezone from input field or detect from browser
            let businessTimezone = document.getElementById('businessTimezone').value;
            if (!businessTimezone || businessTimezone.trim() === '') {
                businessTimezone = getUserTimezone();
                console.log('Using detected timezone:', businessTimezone);
            } else {
                console.log('Using provided timezone:', businessTimezone);
            }
            
            const businessId = "{{ business.businessId }}";
            
            // Only check if both date and time are selected
            if (!date || !time) {
                return;
            }
            
            // Show loading state
            const availabilityAlert = document.getElementById('availability-alert');
            const availabilityMessage = document.getElementById('availability-message');
            const alternativeSlots = document.getElementById('alternative-slots');
            const altSlotsList = document.getElementById('alt-slots-list');
  
            const selectedCleaner = document.getElementById('selectedCleaner');
            
            availabilityAlert.style.display = 'block';
            availabilityAlert.className = 'alert alert-info mt-2';
            availabilityMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Checking availability...';
            
            // Make API request with timezone information
            const url = `/api/check-availability/?date=${date}&time=${time}&timezone=${encodeURIComponent(businessTimezone)}&businessId=${businessId}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        // Show success message
                        availabilityAlert.className = 'alert alert-success mt-2';
                        availabilityMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> This timeslot is available!';
                        setTimeout(() => {
                            availabilityAlert.style.display = 'none';
                        }, 3000);
                        alternativeSlots.style.display = 'none';
                       
                    } else {
                        // Show error message
                        availabilityAlert.className = 'alert alert-danger mt-2';
                        availabilityMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> This timeslot is not available.';
                        
                        // Show alternative slots if any
                        if (data.alternative_slots && data.alternative_slots.length > 0) {
                            alternativeSlots.style.display = 'block';
                            altSlotsList.innerHTML = '';
                            
                            data.alternative_slots.forEach(slot => {
                                // Parse the slot string to get date and time
                                const slotParts = slot.split(' ');
                                const slotDate = slotParts[0];
                                const slotTime = slotParts[1] + ' ' + slotParts[2]; // e.g., "09:00 AM"
                                
                                // Create a button for each alternative slot
                                const slotButton = document.createElement('button');
                                slotButton.className = 'btn btn-outline-primary btn-sm';
                                slotButton.innerHTML = `<i class="fas fa-calendar-check me-1"></i> ${slotTime} on ${formatDate(slotDate)}`;
                                slotButton.type = 'button';
                                slotButton.addEventListener('click', () => {
                                    // Set the form fields to this slot
                                    document.getElementById('cleaningDate').value = slotDate;
                                    
                                    // Convert 12-hour format to 24-hour format for the select
                                    const timeValue = convert12to24(slotTime);
                                    document.getElementById('startTime').value = timeValue;
                                    
                                    // Trigger availability check
                                    checkAvailability();
                                });
                                
                                altSlotsList.appendChild(slotButton);
                            });
                        } else {
                            alternativeSlots.style.display = 'none';
                        }
                      
                    }
                })
                .catch(error => {
                    console.error('Error checking availability:', error);
                    availabilityAlert.className = 'alert alert-warning mt-2';
                    availabilityMessage.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> Could not check availability. Please try again.';
                });
        }
        
        // Helper function to format date nicely
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        // Helper function to convert 12-hour time format to 24-hour format
        function convert12to24(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            
            if (hours === '12') {
                hours = '00';
            }
            
            if (modifier === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }
            
            // Convert hours to string before using padStart
            hours = String(hours).padStart(2, '0');
            
            return `${hours}:${minutes}`;
        }
        
        // Phone number formatting
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                // Remove all non-digit characters
                let value = this.value.replace(/\D/g, '');
                
                // Format with spaces (North American format: XXX XXX XXXX)
                if (value.length > 0) {
                    // Area code (first 3 digits)
                    let formattedNumber = value.substring(0, 3);
                    
                    // First part of local number (next 3 digits)
                    if (value.length > 3) {
                        formattedNumber += ' ' + value.substring(3, 6);
                    }
                    
                    // Second part of local number (next 4 digits)
                    if (value.length > 6) {
                        formattedNumber += ' ' + value.substring(6, 10);
                    }
                    
                    this.value = formattedNumber;
                }
            });
        }
    });
</script>
{% endblock %}

