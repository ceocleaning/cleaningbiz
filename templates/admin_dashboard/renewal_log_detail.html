{% extends 'admin_dashboard/base.html' %}

{% block title %}Renewal Log #{{ log.id }} - Details{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'admin_dashboard:renewal_logs' %}" class="btn btn-sm btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left me-1"></i> Back to Logs
        </a>
        <h1 class="h3 mb-0">Renewal Log #{{ log.id }}</h1>
    </div>
    <div>
        {% if log.status == 'success' or log.status == 'free_plan' %}
        <span class="badge bg-success fs-6 px-3 py-2">
            <i class="fas fa-check-circle me-1"></i>{{ log.get_status_display }}
        </span>
        {% elif log.status == 'failed' %}
        <span class="badge bg-danger fs-6 px-3 py-2">
            <i class="fas fa-times-circle me-1"></i>{{ log.get_status_display }}
        </span>
        {% elif log.status == 'no_card' %}
        <span class="badge bg-info fs-6 px-3 py-2">
            <i class="fas fa-credit-card me-1"></i>{{ log.get_status_display }}
        </span>
        {% else %}
        <span class="badge bg-warning fs-6 px-3 py-2">{{ log.get_status_display }}</span>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Main Information -->
    <div class="col-lg-8">
        <!-- Basic Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Business</label>
                        <div>
                            <a href="{% url 'admin_dashboard:business_detail' log.business.id %}" class="h6">
                                {{ log.business.businessName }}
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Subscription</label>
                        <div>
                            {% if log.subscription %}
                            <a href="{% url 'admin_dashboard:subscription_detail' log.subscription.id %}" class="h6">
                                Subscription #{{ log.subscription.id }}
                            </a>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Renewal Type</label>
                        <div>
                            {% if log.renewal_type == 'automatic' %}
                            <span class="badge bg-primary-subtle text-primary">
                                <i class="fas fa-sync me-1"></i>Automatic Renewal
                            </span>
                            {% elif log.renewal_type == 'upgrade' %}
                            <span class="badge bg-success-subtle text-success">
                                <i class="fas fa-arrow-up me-1"></i>Upgrade
                            </span>
                            {% elif log.renewal_type == 'downgrade' %}
                            <span class="badge bg-warning-subtle text-warning">
                                <i class="fas fa-arrow-down me-1"></i>Downgrade
                            </span>
                            {% else %}
                            <span class="badge bg-info-subtle text-info">{{ log.get_renewal_type_display }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Attempted At</label>
                        <div class="h6">{{ log.attempted_at|date:"F j, Y, g:i A" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plan Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Plan Information</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <div class="p-3 border rounded bg-light">
                            <label class="text-muted small">Old Plan</label>
                            {% if log.old_plan %}
                            <div class="h5 mb-1">{{ log.old_plan.name }}</div>
                            <div class="text-muted">${{ log.old_plan.price|floatformat:2 }}/{{ log.old_plan.get_billing_cycle_display }}</div>
                            <div class="mt-2">
                                <span class="badge bg-secondary-subtle text-secondary">{{ log.old_plan.get_plan_tier_display }}</span>
                            </div>
                            {% else %}
                            <div class="text-muted">N/A</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        {% if log.old_plan and log.new_plan and log.old_plan.id != log.new_plan.id %}
                        <i class="fas fa-arrow-right fa-2x text-primary"></i>
                        {% else %}
                        <i class="fas fa-sync fa-2x text-muted"></i>
                        {% endif %}
                    </div>
                    <div class="col-md-5">
                        <div class="p-3 border rounded {% if log.status == 'success' or log.status == 'free_plan' %}bg-success-subtle{% else %}bg-light{% endif %}">
                            <label class="text-muted small">New Plan</label>
                            {% if log.new_plan %}
                            <div class="h5 mb-1">{{ log.new_plan.name }}</div>
                            <div class="text-muted">${{ log.new_plan.price|floatformat:2 }}/{{ log.new_plan.get_billing_cycle_display }}</div>
                            <div class="mt-2">
                                <span class="badge bg-secondary-subtle text-secondary">{{ log.new_plan.get_plan_tier_display }}</span>
                            </div>
                            {% else %}
                            <div class="text-muted">N/A</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Amount Charged</label>
                        <div class="h4 mb-0">
                            {% if log.amount_charged %}
                            ${{ log.amount_charged|floatformat:2 }}
                            {% else %}
                            <span class="text-muted">$0.00</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Card Used</label>
                        <div class="h6">
                            {% if log.card_last_4 %}
                            <i class="fas fa-credit-card me-1"></i>•••• {{ log.card_last_4 }}
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Square Payment ID</label>
                        <div>
                            {% if log.square_payment_id %}
                            <code class="text-primary">{{ log.square_payment_id }}</code>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Billing Record</label>
                        <div>
                            {% if log.billing_record %}
                            <a href="{% url 'admin_dashboard:billing_history_detail' log.billing_record.id %}">
                                Invoice #{{ log.billing_record.id }}
                            </a>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Information Card (Only show if failed) -->
        {% if log.status == 'failed' or log.status == 'no_card' %}
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger-subtle">
                <h5 class="mb-0 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error Information</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted small">Error Code</label>
                    <div>
                        {% if log.error_code %}
                        <span class="badge bg-danger">{{ log.error_code }}</span>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-0">
                    <label class="text-muted small">Error Message</label>
                    <div class="alert alert-danger mb-0">
                        {% if log.error_message %}
                        {{ log.error_message }}
                        {% else %}
                        <span class="text-muted">No error message available</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Additional Details Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list-ul me-2"></i>Additional Details</h5>
            </div>
            <div class="card-body">
                {% if log.details %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            {% for key, value in log.details.items %}
                            <tr>
                                <td class="bg-light" style="width: 40%;"><strong>{{ key|title }}</strong></td>
                                <td>
                                    {% if value == True %}
                                    <span class="badge bg-success">Yes</span>
                                    {% elif value == False %}
                                    <span class="badge bg-secondary">No</span>
                                    {% else %}
                                    {{ value }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No additional details available</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Stats Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quick Stats</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                    <span class="text-muted">Log ID</span>
                    <strong>#{{ log.id }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                    <span class="text-muted">Created At</span>
                    <span>{{ log.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                    <span class="text-muted">Updated At</span>
                    <span>{{ log.updated_at|date:"M d, Y" }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Time Since</span>
                    <span>{{ log.attempted_at|timesince }} ago</span>
                </div>
            </div>
        </div>

        <!-- Related Logs Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Related Logs</h5>
            </div>
            <div class="card-body p-0">
                {% if related_logs %}
                <div class="list-group list-group-flush">
                    {% for related_log in related_logs %}
                    <a href="{% url 'admin_dashboard:renewal_log_detail' related_log.id %}" 
                       class="list-group-item list-group-item-action {% if related_log.id == log.id %}active{% endif %}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">#{{ related_log.id }}</div>
                                <small class="text-muted">{{ related_log.attempted_at|date:"M d, Y g:i A" }}</small>
                            </div>
                            <div>
                                {% if related_log.status == 'success' %}
                                <span class="badge bg-success">Success</span>
                                {% elif related_log.status == 'failed' %}
                                <span class="badge bg-danger">Failed</span>
                                {% elif related_log.status == 'no_card' %}
                                <span class="badge bg-info">No Card</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ related_log.get_status_display }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No related logs found</p>
                </div>
                {% endif %}
            </div>
            {% if related_logs %}
            <div class="card-footer">
                <a href="{% url 'admin_dashboard:renewal_logs' %}?business={{ log.business.id }}" class="btn btn-sm btn-outline-primary w-100">
                    <i class="fas fa-list me-1"></i> View All Logs for This Business
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Actions Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Actions</h5>
            </div>
            <div class="card-body">
                <a href="{% url 'admin_dashboard:business_detail' log.business.id %}" class="btn btn-outline-primary w-100 mb-2">
                    <i class="fas fa-building me-1"></i> View Business
                </a>
                {% if log.subscription %}
                <a href="{% url 'admin_dashboard:subscription_detail' log.subscription.id %}" class="btn btn-outline-info w-100 mb-2">
                    <i class="fas fa-file-invoice-dollar me-1"></i> View Subscription
                </a>
                {% endif %}
                {% if log.billing_record %}
                <a href="{% url 'admin_dashboard:billing_history_detail' log.billing_record.id %}" class="btn btn-outline-success w-100 mb-2">
                    <i class="fas fa-receipt me-1"></i> View Invoice
                </a>
                {% endif %}
                <a href="{% url 'admin_dashboard:renewal_logs' %}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-arrow-left me-1"></i> Back to All Logs
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
