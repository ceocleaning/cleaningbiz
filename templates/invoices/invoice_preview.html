{% extends 'base.html' %}
{% load static %}
{% load automation_filters %}

{% block title %}Invoice Preview{% endblock %}

{% block styles %}
<style>
    .invoice-container {
        max-width: 1200px;
        width: 95%;
        margin: 0 auto;
        padding: 15px;
        background-color: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .table th {
        background-color: #f8f9fa;
    }
    .payment-status-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        min-height: 30px;
    }
    #card-container {
        min-height: 90px;
    }
    .payment-badge {
        position: absolute;
        top: 20px;
        right: 50%;
        transform: translateX(50%);
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 600;
        z-index: 1;
    }

    /* Invoice details styling */
    .invoice-detail-label {
        font-weight: 500;
        color: #6c757d;
    }

    .detail-row {
        margin-bottom: 8px;
    }

    /* Service item styling */
    .service-details li {
        margin-bottom: 4px;
    }

    /* Pay button styling */
    #payButtonContainer.fixed-bottom {
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding-top: 15px;
    }

    #payButtonContainer .btn-success {
        transition: all 0.3s ease;
    }

    #payButtonContainer .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    /* Mobile floating button */
    .mobile-float-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        width: auto !important;
        border-radius: 50px;
        padding: 12px 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        display: none;
    }

    @media (max-width: 767px) {
        .invoice-container {
            width: 100%;
            padding: 10px;
        }
        .payment-badge {
            position: static;
            display: inline-block;
            margin: 0 auto 15px;
            transform: none;
        }
        .header-section {
            flex-direction: column;
            text-align: center;
        }
        .header-section > div {
            width: 100%;
            text-align: center !important;
            margin-bottom: 15px;
        }
        .mobile-stack {
            margin-bottom: 15px;
        }
        .mobile-mb-3 {
            margin-bottom: 1rem;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .table {
            font-size: 0.9rem;
            width: 100%;
        }
        .card-body {
            padding: 0.75rem;
        }

        /* Mobile floating button enhancements */
        .mobile-float-btn {
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        /* Remove conflicting fixed-bottom rule */
        #payButtonContainer.fixed-bottom {
            display: none;
        }

        /* Mobile table improvements */
        .mobile-table-view {
            display: block;
        }
        .mobile-table-view thead {
            display: none;
        }
        .mobile-table-view tbody,
        .mobile-table-view tr,
        .mobile-table-view td {
            display: block;
            width: 100%;
        }
        .mobile-table-view td {
            padding: 8px;
            text-align: left !important;
            border-bottom: 1px solid #dee2e6;
        }
        .mobile-table-view td:before {
            content: attr(data-label);
            float: left;
            font-weight: bold;
            margin-right: 10px;
        }
        .mobile-table-view td:last-child {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 16px;
        }
        .mobile-label {
            display: inline-block;
            font-weight: bold;
            margin-right: 5px;
        }
        .bill-to-container {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        .invoice-summary-row td {
            padding-top: 12px;
        }
        /* Service item improvements for mobile */
        .service-row td {
            position: relative;
            padding-left: 10px;
        }
        .service-item-value {
            display: inline-block;
        }
    }

    /* Fix for very small screens */
    @media (max-width: 480px) {
        .table th, .table td {
            padding: 0.5rem;
        }
        .header-section img {
            max-width: 120px;
        }
        .invoice-id, .invoice-status {
            font-size: 1.2rem;
        }
    }

    /* Stripe Form */
    #stripe-card-element {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        min-height: 40px;
    }

    .stripe-form {
        margin-bottom: 20px;
    }

    .payment-method-tabs .nav-link {
        padding: 8px 16px;
        border-radius: 4px;
        margin-right: 10px;
    }

    .payment-method-tabs .nav-link.active {
        background-color: var(--primary-color);
        color: white;
    }

    /* Payment form loading state */
    .form-loading {
        position: relative;
    }

    .form-loading:after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .form-loading:before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 30px;
        border: 3px solid #cccccc;
        border-top-color: var(--primary-color);
        border-radius: 50%;
        z-index: 1;
        animation: spinner 0.8s linear infinite;
    }

    @keyframes spinner {
        to {transform: translate(-50%, -50%) rotate(360deg);}
    }
    
    /* Payment History Sliding Panel */
    .payment-history-panel {
        position: fixed;
        top: 0;
        right: -400px; /* Start off-screen */
        width: 400px;
        height: 100%;
        background-color: #fff;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1050;
        transition: right 0.3s ease-in-out;
        overflow-y: auto;
        padding: 20px;
    }
    
    .payment-history-panel.show {
        right: 0;
    }
    
    .payment-history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .payment-item {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #eee;
        transition: all 0.2s;
    }
    
    .payment-item:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-container position-relative">
    {% if invoice.payments.exists %}
    <!-- Payment History Button -->
    <div class="position-fixed" style="top: 50%; right: 0; transform: translateY(-50%); z-index: 1000;">
        <button id="showPaymentHistoryBtn" class="btn btn-info rounded-start rounded-0 px-2 py-3" style="writing-mode: vertical-lr; transform: rotate(180deg); z-index: 1001;">
            <i class="fas fa-history mb-2"></i> Payment History
        </button>
    </div>
    
    <!-- Payment History Panel -->
    <div id="paymentHistoryPanel" class="payment-history-panel">
        <div class="payment-history-header">
            <h5 class="mb-0">Payment History</h5>
            <button id="closePaymentHistoryBtn" class="btn-close" aria-label="Close"></button>
        </div>
        
        <div class="payment-history-content">
            {% for payment in invoice.payments.all %}
            <div class="payment-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge {% if payment.status == 'COMPLETED' or payment.status == 'APPROVED' %}bg-success{% elif payment.status == 'AUTHORIZED' %}bg-info{% elif payment.status == 'FAILED' or payment.status == 'REJECTED' %}bg-danger{% else %}bg-warning{% endif %} px-2 py-1">
                        {{ payment.status|title }}
                    </span>
                    <small class="text-muted">{{ payment.createdAt|date:"M d, Y H:i" }}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Amount:</span>
                    <span class="text-success">${{ payment.amount }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Method:</span>
                    <span>{{ payment.get_paymentMethod_display }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">ID:</span>
                    <span class="text-muted">{{ payment.paymentId }}</span>
                </div>
                {% if payment.paymentMethod == 'bank_transfer' and payment.screenshot %}
                <div class="mt-2">
                    <a href="{{ payment.screenshot.url }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-image me-2"></i>View Receipt
                    </a>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>
    {% endif %}

    
    <div class="text-center mb-3">
        {% if invoice.isPaid %}
        <div class="payment-badge bg-success text-white">
            <i class="fas fa-check-circle me-1"></i>Paid
        </div>
        {% elif invoice.is_partially_paid %}
        <div class="payment-badge bg-warning text-dark">
            <i class="fas fa-exclamation-circle me-1"></i>Partially Paid
        </div>
        {% elif invoice.payments.exists and invoice.payments.first.status == 'AUTHORIZED' %}
        <div class="payment-badge bg-info text-white">
            <i class="fas fa-clock me-1"></i>Payment Authorized
        </div>
        {% endif %}
    </div>

    <!-- Header Section -->
    <div class="row mb-4 header-section">
        <div class="col-md-6 text-start mobile-stack">
            <img src="https://img.freepik.com/free-vector/gradient-squeegee-logo-template_23-2150208857.jpg?uid=R23824890&ga=GA1.1.1921205845.1737568792&semt=ais_hybrid" alt="Logo" style="width: 150px;">
        </div>
        <div class="col-md-6 text-md-end">
            <h4 class="mb-0">{{ business.name }}</h4>
            <p class="mb-0">{{ business.address }}</p>
            <p class="mb-0">{{ business.phone }}</p>
            <p class="mb-0">{{ business.user.email }}</p>
        </div>
    </div>


    <!-- Invoice Details -->
    <div class="row mb-4">
        <div class="col-md-6 mobile-mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title fs-6">Invoice Information</h5>
                    <div class="detail-row">
                        <span class="invoice-detail-label">Invoice Date:</span>
                        <span class="fw-normal">{{ invoice.createdAt|format_date }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="invoice-detail-label">Due Date:</span>
                        <span class="fw-normal">{{ invoice.dueDate|format_date|default:invoice.createdAt|format_date }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 bill-to-container">
                <div class="card-body">
                    <h5 class="card-title fs-6">Client Information</h5>
                    <div class="detail-row">
                        <span class="invoice-detail-label">Name:</span>
                        <span class="fw-normal">{{ invoice.booking.customer.get_full_name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="invoice-detail-label">Email:</span>
                        <span class="fw-normal">{{ invoice.booking.customer.email }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="invoice-detail-label">Phone:</span>
                        <span class="fw-normal">{{ invoice.booking.customer.phone_number }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Header -->
    <div class="row mb-4">
        <div class="col-6">
            <h2 class="mb-0 h3 invoice-id">INVOICE #{{ invoice.invoiceId }}</h2>
        </div>
        <div class="col-6 text-end">
            {% if invoice.isPaid %}
            <h2 class="mb-0 h3 text-success invoice-status">PAID</h2>
            {% elif invoice.is_partially_paid %}
            <h2 class="mb-0 h3 text-warning invoice-status">PARTIALLY PAID</h2>
            {% elif invoice.payments.exists and invoice.payments.first.status == 'AUTHORIZED' %}
            <h2 class="mb-0 h3 text-info invoice-status">AUTHORIZED</h2>
            {% else %}
            <h2 class="mb-0 h3 text-danger invoice-status">UNPAID</h2>
            {% endif %}
        </div>
    </div>

    <!-- Service Details - Mobile Optimized -->
    <div class="table-responsive mb-4">
        <table class="table mobile-table-view">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Details</th>
                    <th>Addons</th>
                    <th class="text-end">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr class="service-row">
                    <td data-label="Service:">
                        <strong>{{ invoice.booking.get_serviceType_display|default:"Cleaning Services" }}</strong>
                    </td>
                    <td data-label="Details:">
                        <div class="service-details">
                            <div class="detail-row">
                                <span class="mobile-label">Date:</span>
                                <span class="service-item-value">{{ invoice.booking.cleaningDate|format_date }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="mobile-label">Time:</span>
                                <span class="service-item-value">{{ invoice.booking.startTime|format_time }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="mobile-label">Bedrooms:</span>
                                <span class="service-item-value">{{ invoice.booking.bedrooms }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="mobile-label">Bathrooms:</span>
                                <span class="service-item-value">{{ invoice.booking.bathrooms }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="mobile-label">Area (sq ft):</span>
                                <span class="service-item-value">{{ invoice.booking.squareFeet }} sq ft</span>
                            </div>
                        </div>
                    </td>
                    <td data-label="Addons:">
                        {% if addons %}
                            <div class="mb-2">
                                <strong>Add-ons:</strong>
                                {% for addon_name, addon_value in addons %}
                                    <div class="detail-row">
                                        <span class="mobile-label">- {{ addon_name }}:</span>
                                        <span class="service-item-value">{{ addon_value }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if invoice.booking.customAddons.exists %}
                            <div class="mb-2">
                                <strong>Custom Add-ons:</strong>
                                {% for addon in invoice.booking.customAddons.all %}
                                    <div class="detail-row">
                                        <span class="mobile-label">- {{ addon.addon.addonName }}:</span>
                                        <span class="service-item-value">{{ addon.qty }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if not addons and not invoice.booking.customAddons.exists %}
                            No addons
                        {% endif %}
                    </td>
                    <td data-label="Amount:" class="text-end">
                        <strong id="amount_display">{{ invoice.amount|format_currency }}</strong>
                    </td>
                </tr>

                <tr class="invoice-summary-row">
                    <td colspan="3" data-label="Subtotal:" class="text-end"><strong>Subtotal:</strong></td>
                    <td data-label="" class="text-end"><strong id="sub_total_display">{{ invoice.booking.totalPrice|format_currency }}</strong></td>
                </tr>
                <tr class="invoice-summary-row">
                    <td colspan="3" data-label="Tax:" class="text-end"><strong>Tax ({{ invoice.booking.business.settings.taxPercent }}%):</strong></td>
                    <td data-label="" class="text-end"><strong id="tax_display">{{ invoice.booking.tax|format_currency }}</strong></td>
                </tr>
                {% if invoice.booking.tip and invoice.booking.tip > 0 %}
                <tr class="invoice-summary-row">
                    <td colspan="3" data-label="Tip:" class="text-end"><strong>Tip:</strong></td>
                    <td data-label="" class="text-end"><strong id="tip_display">{{ invoice.booking.tip|format_currency }}</strong></td>
                </tr>
                {% endif %}
                <tr class="invoice-summary-row">
                    <td colspan="3" data-label="Total:" class="text-end border-bottom"><strong>Total:</strong></td>
                    <td data-label="" class="text-end border-bottom"><strong id="total_display">{{ invoice.amount|format_currency }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Payment Instructions -->
    <div class="row mb-4">
        <div class="col-md-6 mobile-mb-3">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <strong>Payment Instructions</strong>
                </div>
                <div class="card-body">
                    <strong>Bank Transfer:</strong><br>
                    Bank: {{ bank_account.bank_name }}<br>
                    Account Name: {{ bank_account.account_name }}<br>
                    Account Number: {{ bank_account.account_number }}<br>
                    IFSC Code: {{ bank_account.ifsc_code }}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <strong>Note</strong>
                </div>
                <div class="card-body">
                    For pre-authorized payment options, the payment will be deducted on the day of service.<br><br>
                    Please note: Your cleaning appointment will not be fully confirmed until payment is completed.
                </div>
            </div>
        </div>
    </div>

    <!-- Thank You Note -->
    <div class="text-center mt-4">
        <h3 class="h4">Thank You for Your Business!</h3>
        <p class="text-muted small">If you have any questions about this invoice, please contact us at {{ business.phone }} or {{ business.user.email }}</p>
    </div>

    {% if booking.business.user == request.user %}
    <div class="text-center mt-4">
        <div class="row">
            <div class="col-sm-6 mb-2 mb-sm-0">
                <a href="{% url 'invoice:generate_pdf' invoice.invoiceId %}" class="btn btn-primary w-100">
                    <i class="fas fa-download me-2"></i>Save as PDF
                </a>
            </div>
            <div class="col-sm-6">
                <a href="{% url 'invoice:all_invoices' %}" class="btn btn-secondary w-100">
                    <i class="fas fa-arrow-left me-2"></i>Back to Invoices
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not invoice.isPaid and not request.user == booking.business.user %}
    <div class="fixed-bottom mb-3 px-3" id="payButtonContainer">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <a href="#" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#paymentModal">
                        <i class="fas fa-credit-card me-2"></i>Pay {% if invoice.is_partially_paid %}${{ invoice.get_remaining_amount }}{% else %}{{ invoice.amount|format_currency }}{% endif %}
                    </a>
                </div>
                <div class="col-md-6 col-lg-4">
                    <a href="#" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#manualPaymentModal">
                        <i class="fas fa-credit-card me-2"></i>Pay by Bank Transfer
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating button for mobile -->
    <a href="#" class="btn btn-success mobile-float-btn" data-bs-toggle="modal" data-bs-target="#paymentModal" id="mobilePayBtn">
        <i class="fas fa-credit-card me-2"></i>Pay {% if invoice.is_partially_paid %}${{ invoice.get_remaining_amount }}{% else %}{{ invoice.amount|format_currency }}{% endif %}
    </a>
    {% endif %}

    <!-- Payment Modal -->
    <!-- Manual Bank Transfer Modal -->
    <div class="modal fade" id="manualPaymentModal" tabindex="-1" aria-labelledby="manualPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manualPaymentModalLabel">Bank Transfer Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="manualPaymentForm" method="post" enctype="multipart/form-data" action="{% url 'invoice:manual_payment' invoice.invoiceId %}">
                    {% csrf_token %}
                    <!-- Hidden tip amount field that will be populated by JavaScript -->
                    <input type="hidden" id="manual-hidden-tip-amount" name="tip_amount" value="0">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Payment Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_type" id="manualFullPayment" value="full" checked>
                                <label class="form-check-label" for="manualFullPayment">
                                    {% if invoice.is_partially_paid %}
                                    Full Payment (Remaining: <span id="manual-payment-amount-display">${{ invoice.get_remaining_amount }}</span>)
                                    {% else %}
                                    Full Payment (<span id="manual-payment-amount-display">{{ invoice.amount|format_currency }}</span>)
                                    {% endif %}
                                </label>
                            </div>
                            {% if not invoice.payments.exists %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_type" id="manualPartialPayment" value="partial">
                                <label class="form-check-label" for="manualPartialPayment">
                                    Partial Payment
                                </label>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if invoice.is_partially_paid %}
                        <div class="alert alert-info mb-3">
                            <p class="mb-1"><strong>Partially Paid:</strong> {{ invoice.total_paid_amount|format_currency }}</p>
                            <p class="mb-0"><strong>Remaining Amount:</strong> {{ invoice.get_remaining_amount|format_currency }}</p>
                        </div>
                        <input type="hidden" name="amount" value="{{ invoice.get_remaining_amount }}">
                        {% endif %}
                        
                        <div id="manualPartialAmountContainer" class="mb-3" {% if not invoice.payments.exists %}style="display: none;"{% else %}style="display: none;"{% endif %}>
                            <label for="manual_partial_amount" class="form-label">Amount Paid:</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="manual_partial_amount" name="amount" min="1" 
                                       {% if invoice.is_partially_paid %}
                                       max="{{ invoice.get_remaining_amount }}" value="{{ invoice.get_remaining_amount }}"
                                       {% else %}
                                       max="{{ invoice.amount }}" value="{{ invoice.amount }}"
                                       {% endif %}
                                       step="0.01">
                            </div>
                            <div class="form-text">Enter the amount you've paid via bank transfer.</div>
                        </div>
                        
                        <script>
                            // Update manual partial payment amount when tip changes
                            document.addEventListener('DOMContentLoaded', function() {
                                const manualPartialAmountInput = document.getElementById('manual_partial_amount');
                                if (manualPartialAmountInput) {
                                    // Store original max and value
                                    const originalMax = manualPartialAmountInput.getAttribute('max');
                                    const originalValue = manualPartialAmountInput.value;
                                    
                                    // Function to update manual partial payment input
                                    window.updateManualPartialPaymentAmount = function(newAmount) {
                                        if (manualPartialAmountInput) {
                                            manualPartialAmountInput.setAttribute('max', newAmount);
                                            manualPartialAmountInput.value = newAmount;
                                        }
                                    };
                                }
                            });
                        </script>
                        
                        <div class="mb-3">
                            <label for="transaction_id" class="form-label">Transaction ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="transaction_id" name="transaction_id" required>
                            <div class="form-text">Please enter the transaction/reference ID from your bank transfer.</div>
                        </div>
                        <div class="mb-3">
                            <label for="from_account_number" class="form-label">Your Account Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="from_account_number" name="from_account_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="from_bank_name" class="form-label">Your Bank Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="from_bank_name" name="from_bank_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="screen_shot" class="form-label">Payment Proof (Screenshot/Receipt) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="screen_shot" name="screen_shot" accept="image/*" required>
                            <div class="form-text">Upload a clear screenshot or photo of your payment confirmation.</div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Please ensure all details match your bank transfer. Your payment will be verified manually.
                        </div>
                    </div>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const manualFullPaymentRadio = document.getElementById('manualFullPayment');
                            const manualPartialPaymentRadio = document.getElementById('manualPartialPayment');
                            const manualPartialAmountContainer = document.getElementById('manualPartialAmountContainer');
                            const manualPartialAmountInput = document.getElementById('manual_partial_amount');
                            
                            if (manualFullPaymentRadio && manualPartialPaymentRadio) {
                                // Toggle partial amount input visibility
                                manualFullPaymentRadio.addEventListener('change', function() {
                                    if (this.checked) {
                                        manualPartialAmountContainer.style.display = 'none';
                                        if (manualPartialAmountInput) {
                                            manualPartialAmountInput.value = {{ invoice.amount }};
                                        }
                                    }
                                });
                                
                                manualPartialPaymentRadio.addEventListener('change', function() {
                                    if (this.checked) {
                                        manualPartialAmountContainer.style.display = 'block';
                                    }
                                });
                            }
                        });
                    </script>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane me-2"></i>Submit Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Options Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Payment Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="mb-3">Total Invoice Amount: <strong id="base-invoice-amount">{{ invoice.amount|format_currency }}</strong></h6>
                        
                        {% if invoice.is_partially_paid %}
                        <div class="alert alert-info">
                            <p class="mb-1"><strong>Partially Paid:</strong> {{ invoice.total_paid_amount|format_currency }}</p>
                            <p class="mb-0"><strong>Remaining Amount:</strong> {{ invoice.get_remaining_amount|format_currency }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- Tipping Section -->
                        <div class="card mb-3 border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Add a Tip</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableTipToggle">
                                        <label class="form-check-label" for="enableTipToggle">Include Tip</label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body" id="tipOptionsContainer" style="display: none;">
                                <!-- Percentage-based tip options -->
                                <div class="mb-3">
                                    <label class="form-label">Suggested Tip:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-outline-success tip-percent-btn" data-percent="10">10%</button>
                                        <button type="button" class="btn btn-outline-success tip-percent-btn" data-percent="15">15%</button>
                                        <button type="button" class="btn btn-outline-success tip-percent-btn" data-percent="20">20%</button>
                                        <button type="button" class="btn btn-outline-success tip-amount-btn" data-amount="5">$5</button>
                                        <button type="button" class="btn btn-outline-success tip-amount-btn" data-amount="10">$10</button>
                                        <button type="button" class="btn btn-outline-success tip-amount-btn" data-amount="20">$20</button>
                                    </div>
                                </div>
                                
                                <!-- Custom tip amount -->
                                <div class="mb-3">
                                    <label for="customTipAmount" class="form-label">Custom Tip Amount:</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="customTipAmount" min="0" step="0.01" value="0.00">
                                    </div>
                                </div>
                                
                                <!-- Tip summary -->
                                <div class="d-flex justify-content-between align-items-center mt-3 fw-bold">
                                    <span>Tip Amount:</span>
                                    <span id="tipAmountDisplay">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Updated Total with Tip -->
                        <div class="alert alert-success" id="totalWithTipContainer" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>New Total (with tip):</strong>
                                <strong id="totalWithTipDisplay">{{ invoice.amount|format_currency }}</strong>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Payment Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_type" id="fullPayment" value="full" checked>
                                <label class="form-check-label" for="fullPayment">
                                    {% if invoice.is_partially_paid %}
                                    Full Payment (Remaining: <span id="payment-amount-display">${{ invoice.get_remaining_amount }}</span>)
                                    {% else %}
                                    Full Payment (<span id="payment-amount-display">{{ invoice.amount|format_currency }}</span>)
                                    {% endif %}
                                </label>
                            </div>
                            {% if not invoice.payments.exists %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_type" id="partialPayment" value="partial">
                                <label class="form-check-label" for="partialPayment">
                                    Partial Payment
                                </label>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div id="partialAmountContainer" class="mb-3" style="display: none;">
                            <label for="partialAmount" class="form-label">Amount to Pay:</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="partialAmount" name="amount" min="1" 
                                       {% if invoice.is_partially_paid %}
                                       max="{{ invoice.get_remaining_amount }}" value="{{ invoice.get_remaining_amount }}"
                                       {% else %}
                                       max="{{ invoice.amount }}" value="{{ invoice.amount }}"
                                       {% endif %}
                                       step="0.01" placeholder="Enter amount">
                            </div>
                            <div class="form-text">Enter an amount less than the total invoice amount.</div>
                        </div>
                        
                        <script>
                            // Update partial payment amount when tip changes
                            document.addEventListener('DOMContentLoaded', function() {
                                const partialAmountInput = document.getElementById('partialAmount');
                                if (partialAmountInput) {
                                    // Store original max and value
                                    const originalMax = partialAmountInput.getAttribute('max');
                                    const originalValue = partialAmountInput.value;
                                    
                                    // Function to update partial payment input
                                    window.updatePartialPaymentAmount = function(newAmount) {
                                        if (partialAmountInput) {
                                            partialAmountInput.setAttribute('max', newAmount);
                                            partialAmountInput.value = newAmount;
                                        }
                                    };
                                }
                            });
                        </script>
                        
                        {% if invoice.is_partially_paid %}
                        <div class="alert alert-info">
                            <p class="mb-0">You will be charged the remaining amount: <strong>{{ invoice.get_remaining_amount|format_currency }}</strong></p>
                        </div>
                        {% endif %}

                        {% if booking.business.defaultPaymentMethod == 'square' %}
                        <!-- Square Payment Form -->
                        <div id="card-container"></div>
                        <div id="payment-status-container" class="payment-status-container"></div>
                        
                        {% if not invoice.payments.exists %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Partial Payments:</strong> You can make a partial payment now and pay the remaining amount later. For authorized payments, the full amount will be charged after service completion.
                        </div>
                        {% endif %}

                        <div class="d-grid gap-3 mt-4">
                            <button id="pay-now-button" class="btn btn-success">
                                <i class="fas fa-credit-card me-2"></i>Pay Now with Square
                            </button>
                            <button id="authorize-button" class="btn btn-primary">
                                <i class="fas fa-clock me-2"></i>Authorize Now, Pay After Work
                            </button>
                        </div>
                        {% elif booking.business.defaultPaymentMethod == 'stripe' %}
                        <!-- Stripe Payment Form -->
                        <div class="stripe-form">
                            <div id="stripe-card-element"></div>
                            <div id="stripe-payment-status" class="payment-status-container mt-3"></div>
                        </div>
                        
                        {% if not invoice.payments.exists %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Partial Payments:</strong> You can make a partial payment now and pay the remaining amount later. For authorized payments, the full amount will be charged after service completion.
                        </div>
                        {% endif %}

                        <div class="d-grid gap-3 mt-4">
                            <button id="stripe-pay-button" class="btn btn-success">
                                <i class="fas fa-credit-card me-2"></i>Pay Now with Stripe
                            </button>
                            <button id="stripe-authorize-button" class="btn btn-primary">
                                <i class="fas fa-clock me-2"></i>Authorize Now, Pay After Work
                            </button>
                        </div>
                        {% elif booking.business.defaultPaymentMethod == 'paypal' %}
                        <div id="paypal-button-container">

                        </div>
                        
                        {% if not invoice.payments.exists %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Partial Payments:</strong> You can make a partial payment now and pay the remaining amount later. Select the payment type above before proceeding with PayPal checkout.
                        </div>
                        {% endif %}
                        {% else %}
                        <!-- Default payment options if none set -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This business has not set up online payment processing yet. Please contact them directly for payment options.
                        </div>
                        {% endif %}

                        <p class="text-muted small text-center mt-3">
                            <i class="fas fa-info-circle me-1"></i>
                            "Pay Now" processes the payment immediately. "Authorize Now" reserves the funds but only charges after service completion.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<!-- Tip Calculation JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tip-related elements
        const enableTipToggle = document.getElementById('enableTipToggle');
        const tipOptionsContainer = document.getElementById('tipOptionsContainer');
        const tipPercentButtons = document.querySelectorAll('.tip-percent-btn');
        const tipAmountButtons = document.querySelectorAll('.tip-amount-btn');
        const customTipAmount = document.getElementById('customTipAmount');
        const tipAmountDisplay = document.getElementById('tipAmountDisplay');
        const totalWithTipContainer = document.getElementById('totalWithTipContainer');
        const totalWithTipDisplay = document.getElementById('totalWithTipDisplay');
        const baseInvoiceAmountElement = document.getElementById('base-invoice-amount');
        
        // Get base invoice amount
        let baseInvoiceAmount = parseFloat(baseInvoiceAmountElement.innerText.replace(/[^0-9.-]+/g, '')) || 0;
        let tipAmount = 0;
        
        // Toggle tip options visibility
        if (enableTipToggle) {
            enableTipToggle.addEventListener('change', function() {
                if (this.checked) {
                    tipOptionsContainer.style.display = 'block';
                    updateTipDisplay();
                } else {
                    tipOptionsContainer.style.display = 'none';
                    totalWithTipContainer.style.display = 'none';
                    customTipAmount.value = '0.00';
                    tipAmount = 0;
                    clearSelectedTipButtons();
                }
            });
        }
        
        // Handle percentage-based tip buttons
        tipPercentButtons.forEach(button => {
            button.addEventListener('click', function() {
                const percent = parseFloat(this.getAttribute('data-percent'));
                tipAmount = (baseInvoiceAmount * percent / 100).toFixed(2);
                customTipAmount.value = tipAmount;
                updateTipDisplay();
                highlightSelectedButton(this);
            });
        });
        
        // Handle fixed amount tip buttons
        tipAmountButtons.forEach(button => {
            button.addEventListener('click', function() {
                tipAmount = parseFloat(this.getAttribute('data-amount')).toFixed(2);
                customTipAmount.value = tipAmount;
                updateTipDisplay();
                highlightSelectedButton(this);
            });
        });
        
        // Handle custom tip amount input
        if (customTipAmount) {
            customTipAmount.addEventListener('input', function() {
                tipAmount = parseFloat(this.value) || 0;
                updateTipDisplay();
                clearSelectedTipButtons();
            });
        }
        
        // Update tip display and total
        function updateTipDisplay() {
            if (tipAmount > 0) {
                tipAmountDisplay.textContent = '$' + parseFloat(tipAmount).toFixed(2);
                const totalWithTip = baseInvoiceAmount + parseFloat(tipAmount);
                totalWithTipDisplay.textContent = '$' + totalWithTip.toFixed(2);
                totalWithTipContainer.style.display = 'block';
                
                // Update payment amount display in payment type section
                updatePaymentAmountDisplay(totalWithTip);
                
                // Update pay button text
                updatePayButtonText(totalWithTip);
                
                // Update partial payment amount inputs if they exist
                if (window.updatePartialPaymentAmount) {
                    window.updatePartialPaymentAmount(totalWithTip.toFixed(2));
                }
                
                if (window.updateManualPartialPaymentAmount) {
                    window.updateManualPartialPaymentAmount(totalWithTip.toFixed(2));
                }
                
                // Add hidden input for form submission
                addOrUpdateHiddenTipInput();
            } else {
                tipAmountDisplay.textContent = '$0.00';
                totalWithTipContainer.style.display = 'none';
                
                // Reset payment amount display to original amount
                updatePaymentAmountDisplay(baseInvoiceAmount);
                
                // Reset pay button text
                updatePayButtonText(baseInvoiceAmount);
                
                // Reset partial payment amount inputs if they exist
                if (window.updatePartialPaymentAmount) {
                    window.updatePartialPaymentAmount(baseInvoiceAmount.toFixed(2));
                }
                
                if (window.updateManualPartialPaymentAmount) {
                    window.updateManualPartialPaymentAmount(baseInvoiceAmount.toFixed(2));
                }
                
                removeHiddenTipInput();
            }
        }
        
        // Update payment amount display in payment type section
        function updatePaymentAmountDisplay(amount) {
            // Update main payment modal amount display
            const paymentAmountDisplay = document.getElementById('payment-amount-display');
            if (paymentAmountDisplay) {
                paymentAmountDisplay.textContent = '$' + parseFloat(amount).toFixed(2);
            }
            
            // Update manual payment modal amount display
            const manualPaymentAmountDisplay = document.getElementById('manual-payment-amount-display');
            if (manualPaymentAmountDisplay) {
                manualPaymentAmountDisplay.textContent = '$' + parseFloat(amount).toFixed(2);
            }
        }
        
        // Update pay button text
        function updatePayButtonText(amount) {
            // Update all payment buttons including regular pay and bank transfer buttons
            const payButtons = document.querySelectorAll('[data-bs-target="#paymentModal"], [data-bs-target="#manualPaymentModal"]');
            payButtons.forEach(button => {
                // Extract the button text and update only the amount part
                const buttonText = button.innerHTML;
                const newText = buttonText.replace(/\$[\d,\.]+/g, '$' + parseFloat(amount).toFixed(2));
                button.innerHTML = newText;
            });
            
            // Also update mobile pay button if it exists
            const mobilePayBtn = document.getElementById('mobilePayBtn');
            if (mobilePayBtn) {
                const buttonText = mobilePayBtn.innerHTML;
                const newText = buttonText.replace(/\$[\d,\.]+/g, '$' + parseFloat(amount).toFixed(2));
                mobilePayBtn.innerHTML = newText;
            }
        }
        
        // Highlight selected button and clear others
        function highlightSelectedButton(selectedButton) {
            tipPercentButtons.forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            });
            tipAmountButtons.forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            });
            
            selectedButton.classList.remove('btn-outline-success');
            selectedButton.classList.add('btn-success');
        }
        
        // Clear button selection
        function clearSelectedTipButtons() {
            tipPercentButtons.forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            });
            tipAmountButtons.forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            });
        }
        
        // Add or update hidden tip input for form submission
        function addOrUpdateHiddenTipInput() {
            // Update the manual payment form hidden tip field
            const manualTipInput = document.getElementById('manual-hidden-tip-amount');
            if (manualTipInput) {
                manualTipInput.value = tipAmount;
            }
            
            // Handle other payment forms
            let tipInput = document.getElementById('hidden-tip-amount');
            if (!tipInput) {
                tipInput = document.createElement('input');
                tipInput.type = 'hidden';
                tipInput.id = 'hidden-tip-amount';
                tipInput.name = 'tip_amount';
                
                // Add to all payment forms except the manual payment form
                const paymentForms = document.querySelectorAll('form:not(#manualPaymentForm)');
                paymentForms.forEach(form => {
                    const clonedInput = tipInput.cloneNode();
                    form.appendChild(clonedInput);
                });
            }
            
            // Update all tip inputs
            document.querySelectorAll('#hidden-tip-amount').forEach(input => {
                input.value = tipAmount;
            });
            
            // Log for debugging
            console.log('Tip amount set to:', tipAmount);
        }
        
        // Remove hidden tip input
        function removeHiddenTipInput() {
            // Set manual payment form tip to 0
            const manualTipInput = document.getElementById('manual-hidden-tip-amount');
            if (manualTipInput) {
                manualTipInput.value = 0;
            }
            
            // Remove other hidden tip inputs
            document.querySelectorAll('#hidden-tip-amount').forEach(input => {
                input.parentNode.removeChild(input);
            });
            
            console.log('Tip inputs reset to 0');
        }
    });
</script>

<!-- Payment History Panel JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const showPaymentHistoryBtn = document.getElementById('showPaymentHistoryBtn');
        const closePaymentHistoryBtn = document.getElementById('closePaymentHistoryBtn');
        const paymentHistoryPanel = document.getElementById('paymentHistoryPanel');
        const overlay = document.getElementById('overlay');
        
        if (showPaymentHistoryBtn && closePaymentHistoryBtn && paymentHistoryPanel && overlay) {

            console.log("All Elements Present");
            
            // Show payment history panel
            showPaymentHistoryBtn.addEventListener('click', function() {
                console.log("Button Clicked")
                paymentHistoryPanel.classList.add('show');
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
            });
            
            // Close payment history panel
            closePaymentHistoryBtn.addEventListener('click', function() {
                closePaymentHistory();
            });
            
            // Close when clicking on overlay
            overlay.addEventListener('click', function() {
                closePaymentHistory();
            });
            
            // Close function
            function closePaymentHistory() {
                paymentHistoryPanel.classList.remove('show');
                overlay.style.display = 'none';
                document.body.style.overflow = ''; // Restore scrolling
            }
            
            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePaymentHistory();
                }
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate subtotal
        const sub_total_display = document.getElementById('sub_total_display');
        const tax_display = document.getElementById('tax_display');
        const total_display = document.getElementById('total_display');
        const amount_display = document.getElementById('amount_display');

        // Get the text content and clean it properly to handle currency formatting
        const totalText = total_display.innerText.replace(/[^0-9.-]+/g, '');
        const taxText = tax_display.innerText.replace(/[^0-9.-]+/g, '');

        const total = parseFloat(totalText) || 0;
        const tax = parseFloat(taxText) || 0;

        const sub_total = total - tax;

        // Format with currency symbol
        sub_total_display.textContent = `$${sub_total.toFixed(2)}`;
        amount_display.textContent = `$${sub_total.toFixed(2)}`;

        // Handle payment type selection
        const fullPaymentRadio = document.getElementById('fullPayment');
        const partialPaymentRadio = document.getElementById('partialPayment');
        const partialAmountContainer = document.getElementById('partialAmountContainer');
        const partialAmountInput = document.getElementById('partialAmount');
        
        if (fullPaymentRadio && partialPaymentRadio) {
            // Set max value for partial payment
            if (partialAmountInput) {
                {% if invoice.is_partially_paid %}
                const remainingAmount = {{ invoice.get_remaining_amount }};
                partialAmountInput.max = remainingAmount;
                partialAmountInput.value = remainingAmount;
                {% else %}
                const invoiceAmount = {{ invoice.amount }};
                partialAmountInput.max = invoiceAmount;
                partialAmountInput.value = invoiceAmount;
                {% endif %}
            }
            
            // Toggle partial amount input visibility
            fullPaymentRadio.addEventListener('change', function() {
                if (this.checked) {
                    partialAmountContainer.style.display = 'none';
                }
            });
            
            partialPaymentRadio.addEventListener('change', function() {
                if (this.checked) {
                    partialAmountContainer.style.display = 'block';
                }
            });
        }
        
        // Function to get current payment amount based on selection
        window.getPaymentAmount = function() {
            if (!partialPaymentRadio || !partialAmountInput) {
                {% if invoice.is_partially_paid %}
                return {{ invoice.get_remaining_amount }};
                {% else %}
                return {{ invoice.amount }};
                {% endif %}
            }
            
            if (partialPaymentRadio.checked) {
                return parseFloat(partialAmountInput.value) || 0;
            } else {
                {% if invoice.is_partially_paid %}
                return {{ invoice.get_remaining_amount }};
                {% else %}
                return {{ invoice.amount }};
                {% endif %}
            }
        };
        
        // Function to get payment type
        window.getPaymentType = function() {
            if (!partialPaymentRadio) {
                {% if invoice.is_partially_paid %}
                return 'partial';
                {% else %}
                return 'full';
                {% endif %}
            }
            
            return partialPaymentRadio.checked ? 'partial' : 'full';
        };

        // Adjust position of payment button on small screens
        function adjustPayButton() {
            const payBtn = document.getElementById('payButtonContainer');
            const mobileBtn = document.getElementById('mobilePayBtn');

            if (payBtn && mobileBtn) {
                if (window.innerWidth < 768) {
                    // Hide the regular button container on mobile
                    payBtn.style.display = 'none';
                    // Show the floating button
                    mobileBtn.style.display = 'inline-block';
                } else {
                    // Show regular button container on desktop
                    payBtn.style.display = 'block';
                    // Hide the floating button
                    mobileBtn.style.display = 'none';
                }
            }
        }

        // Run on load and resize
        adjustPayButton();
        window.addEventListener('resize', adjustPayButton);
    });
</script>

{% if booking.business.defaultPaymentMethod == 'square' %}
    {% if settings.SQUARE_ENVIRONMENT == 'sandbox' %}
    <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
    {% else %}

    <script src="https://js.squareup.com/v2/paymentform"></script>
    {% endif %}
    <script>
        // Square Payment JS
        document.addEventListener('DOMContentLoaded', function() {
            // Calculate subtotal
            const sub_total_display = document.getElementById('sub_total_display');
            const tax_display = document.getElementById('tax_display');
            const total_display = document.getElementById('total_display');
            const amount_display = document.getElementById('amount_display');

            // Get the text content and clean it properly to handle currency formatting
            const totalText = total_display.innerText.replace(/[^0-9.-]+/g, '');
            const taxText = tax_display.innerText.replace(/[^0-9.-]+/g, '');

            const total = parseFloat(totalText) || 0;
            const tax = parseFloat(taxText) || 0;

            const sub_total = total - tax;

            // Format with currency symbol
            sub_total_display.textContent = `$${sub_total.toFixed(2)}`;
            amount_display.textContent = `$${sub_total.toFixed(2)}`;

            // Adjust position of payment button on small screens
            function adjustPayButton() {
                const payBtn = document.getElementById('payButtonContainer');
                const mobileBtn = document.getElementById('mobilePayBtn');

                if (payBtn && mobileBtn) {
                    if (window.innerWidth < 768) {
                        // Hide the regular button container on mobile
                        payBtn.style.display = 'none';
                        // Show the floating button
                        mobileBtn.style.display = 'inline-block';
                    } else {
                        // Show regular button container on desktop
                        payBtn.style.display = 'block';
                        // Hide the floating button
                        mobileBtn.style.display = 'none';
                    }
                }
            }

            // Run on load and resize
            adjustPayButton();
            window.addEventListener('resize', adjustPayButton);
        });

        const appId = '{{ settings.SQUARE_APP_ID }}';
        const square_env = '{{ settings.SQUARE_ENVIRONMENT }}';
        const square_location_id = '{{ settings.SQUARE_LOCATION_ID }}';
        let payments;

        async function initializeCard(payments) {
            const card = await payments.card();
            await card.attach('#card-container');
            return card;
        }

        async function createPayment(token, autoComplete = true) {
            // Get payment amount and type
            const paymentAmount = window.getPaymentAmount();
            const paymentType = window.getPaymentType();
            
            // Get tip amount if available
            let tipAmount = 0;
            const tipInput = document.getElementById('hidden-tip-amount') || document.getElementById('manual-hidden-tip-amount');
            if (tipInput && tipInput.value) {
                tipAmount = parseFloat(tipInput.value) || 0;
            }
            
            // Prepare payment data
            const bodyData = {
                sourceId: token,
                invoiceId: '{{ invoice.invoiceId }}',
                amount: paymentAmount,
                paymentType: paymentType,
                tipAmount: tipAmount
            };

            const paymentResponse = await fetch('{% url "invoice:process_payment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(bodyData)
            });

            if (paymentResponse.ok) {
                return paymentResponse.json();
            }
            const errorBody = await paymentResponse.text();
            throw new Error(errorBody);
        }

        function displayPaymentResults(status) {
            const statusContainer = document.getElementById('payment-status-container');
            const buttons = document.querySelectorAll('#pay-now-button, #authorize-button');

            // Disable buttons during processing
            buttons.forEach(btn => btn.disabled = true);

            if (status.error) {
                statusContainer.classList.remove('text-success', 'text-info');
                statusContainer.classList.add('text-danger');
                statusContainer.innerHTML = `<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>${status.error}</div>`;
                // Re-enable buttons on error
                buttons.forEach(btn => btn.disabled = false);
            } else {
                statusContainer.classList.remove('text-danger');
                statusContainer.classList.add(status.isAuthorized ? 'text-info' : 'text-success');
                statusContainer.innerHTML = `<div class="alert alert-${status.isAuthorized ? 'info' : 'success'} mb-0">
                    <i class="fas fa-${status.isAuthorized ? 'clock' : 'check-circle'} me-2"></i>${status.message}</div>`;

                // Reload page after success
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

        window.addEventListener('load', async function () {
            payments = window.Square.payments(appId);
            let card;
            try {
                card = await initializeCard(payments);
            } catch (e) {
                console.error('Failed to initialize card:', e);
                displayPaymentResults({ error: 'Failed to initialize payment form. Please try again.' });
                return;
            }

            // Pay Now button handler
            document.getElementById('pay-now-button').addEventListener('click', async function (event) {
                event.preventDefault();
                try {
                    const result = await card.tokenize();
                    if (result.status === 'OK') {
                        displayPaymentResults({ message: 'Processing payment...' });
                        try {
                            const payment = await createPayment(result.token, true);
                            displayPaymentResults({
                                message: 'Payment successful! Redirecting...',
                                isAuthorized: false
                            });
                        } catch (e) {
                            displayPaymentResults({ error: e.message });
                        }
                    }
                } catch (e) {
                    displayPaymentResults({ error: e.message });
                }
            });

            // Authorize button handler
            document.getElementById('authorize-button').addEventListener('click', async function (event) {
                event.preventDefault();
                try {
                    const result = await card.tokenize();
                    if (result.status === 'OK') {
                        displayPaymentResults({ message: 'Processing authorization...' });
                        try {
                            const payment = await createPayment(result.token, false);
                            displayPaymentResults({
                                message: 'Authorization successful! Payment will be completed after work.',
                                isAuthorized: true
                            });
                        } catch (e) {
                            displayPaymentResults({ error: e.message });
                        }
                    }
                } catch (e) {
                    displayPaymentResults({ error: e.message });
                }
            });
        });
    </script>
{% elif booking.business.defaultPaymentMethod == 'stripe' %}
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Stripe
            const stripePublishableKey = '{{ booking.business.stripe_credentials.stripe_publishable_key }}';

        
            if (!stripePublishableKey) {
                console.error('Stripe publishable key not found');
                return;
            }

            const stripe = Stripe(stripePublishableKey);
            const elements = stripe.elements();

            // Create and mount the Stripe card element
            const card = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                        fontSmoothing: 'antialiased',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                }
            });

            // Mount the card element
            card.mount('#stripe-card-element');

            // Handle real-time validation errors
            card.on('change', function(event) {
                const displayError = document.getElementById('stripe-payment-status');
                if (displayError) {
                    if (event.error) {
                        displayError.innerHTML = `<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>${event.error.message}</div>`;
                    } else {
                        displayError.innerHTML = '';
                    }
                }
            });

            // Display payment result
            function displayStripePaymentResult(result) {
                const statusContainer = document.getElementById('stripe-payment-status');
                const buttons = document.querySelectorAll('#stripe-pay-button, #stripe-authorize-button');

                if (!statusContainer) return;

                // Disable buttons during processing
                buttons.forEach(btn => btn.disabled = true);

                if (result.error) {
                    statusContainer.innerHTML = `<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>${result.error}</div>`;
                    // Re-enable buttons on error
                    buttons.forEach(btn => btn.disabled = false);
                } else {
                    statusContainer.innerHTML = `<div class="alert alert-${result.isAuthorized ? 'info' : 'success'} mb-0">
                        <i class="fas fa-${result.isAuthorized ? 'clock' : 'check-circle'} me-2"></i>${result.message}</div>`;

                    // Reload page after success
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }

            // Process the payment
            async function processStripePayment(autoComplete = true) {
                const statusContainer = document.getElementById('stripe-payment-status');

                if (!statusContainer) return;

                // Show processing message
                statusContainer.innerHTML = `<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Processing payment...</div>`;

                try {
                    // Get tip amount if available
                    let tipAmount = 0;
                    const tipInput = document.getElementById('hidden-tip-amount') || document.getElementById('manual-hidden-tip-amount');
                    if (tipInput && tipInput.value) {
                        tipAmount = parseFloat(tipInput.value) || 0;
                    }
                    
                    // Create a payment method with card element
                    const { paymentMethod, error } = await stripe.createPaymentMethod({
                        type: 'card',
                        card: card
                    });
                    
                    if (error) {
                        displayStripePaymentResult({ error: error.message });
                        return;
                    }
                    
                    // Now send the payment method ID to the server
                    const response = await fetch('{% url "invoice:process_stripe_payment" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            payment_method_id: paymentMethod.id,
                            invoice_id: '{{ invoice.invoiceId }}',
                            amount: window.getPaymentAmount(),
                            auto_complete: autoComplete,
                            payment_type: window.getPaymentType(),
                            tip_amount: tipAmount
                        })
                    });
                    
                    const result = await response.json();

                    if (result.success) {
                        displayStripePaymentResult({
                            message: autoComplete ? 'Payment successful! Redirecting...' : 'Authorization successful! Payment will be completed after work.',
                            isAuthorized: !autoComplete
                        });
                    } else {
                        displayStripePaymentResult({ error: result.error || 'Payment failed. Please try again.' });
                    }
                } catch (err) {
                    displayStripePaymentResult({ error: 'An unexpected error occurred. Please try again.' });
                    console.error('Stripe payment error:', err);
                }
            }

            // Set up event listeners
            const payButton = document.getElementById('stripe-pay-button');
            if (payButton) {
                payButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    processStripePayment(true);
                });
            }

            // Authorize button handler
            const authorizeButton = document.getElementById('stripe-authorize-button');
            if (authorizeButton) {
                authorizeButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    processStripePayment(false);
                });
            }
        });
    </script>

{% elif booking.business.defaultPaymentMethod == 'paypal' %}


<!-- Load the PayPal SDK with specific parameters for Sandbox environment -->
<script src="https://www.paypal.com/sdk/js?client-id={{ booking.business.paypal_credentials.paypal_client_id }}&currency=USD&intent=capture"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the invoice amount from the page
        const totalText = document.getElementById('total_display').innerText.replace(/[^0-9.-]+/g, '');
        const invoiceAmount = parseFloat(totalText) || 0;

        // Format for PayPal (2 decimal places)
        const formattedAmount = invoiceAmount.toFixed(2);

        // Function to manually process PayPal payment when capture fails or times out
        function processPayPalPaymentManually(orderID) {
            console.log('Manually processing PayPal payment for order:', orderID);
            const paypalContainer = document.getElementById('paypal-button-container');
            
            // Get tip amount if available
            let tipAmount = 0;
            const tipInput = document.getElementById('hidden-tip-amount') || document.getElementById('manual-hidden-tip-amount');
            if (tipInput && tipInput.value) {
                tipAmount = parseFloat(tipInput.value) || 0;
            }
            
            // Send the payment details directly to our server
            return fetch('{% url "invoice:process_paypal_payment" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    orderID: orderID,
                    invoiceId: '{{ invoice.invoiceId }}',
                    amount: window.getPaymentAmount(),
                    paymentType: window.getPaymentType(),
                    tipAmount: tipAmount
                })
            })
            .then(response => {
                console.log('Manual verification server response received', response);
                if (!response.ok) {
                    console.error('Manual verification server response not OK', response.status, response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Manual verification server response parsed', data);
                if (data.success) {
                    console.log('Manual verification successful, preparing to redirect');
                    // Show success message
                    paypalContainer.innerHTML = '<div class="alert alert-success text-center"><i class="fas fa-check-circle me-2"></i>Payment successful! Redirecting...</div>';

                    // Reload the page after a short delay
                    setTimeout(() => {
                        console.log('Reloading page after manual verification...');
                        window.location.reload();
                    }, 2000);
                } else {
                    console.error('Manual verification failed', data.error);
                    // Show error message
                    paypalContainer.innerHTML = `<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>${data.error || 'Payment processing failed. Please try again.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error during manual verification:', error);
                paypalContainer.innerHTML = `<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>Payment verification failed. Please contact support.</div>`;
            });
        }
        
        // Initialize PayPal buttons if SDK is loaded
        if (typeof paypal !== 'undefined') {
            console.log('PayPal SDK is available, initializing buttons');
            
            // Initialize PayPal buttons with enhanced configuration for Sandbox
            paypal.Buttons({
                // Enable the PayPal buttons
                env: 'sandbox', // Force sandbox mode for testing
                style: {
                    layout: 'vertical',
                    color: 'gold',  // Using gold for better visibility
                    shape: 'rect',
                    label: 'pay'
                },

            // Set up the transaction
            createOrder: function(data, actions) {
                const paymentAmount = window.getPaymentAmount();
                const formattedPaymentAmount = paymentAmount.toFixed(2);
                
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: formattedPaymentAmount,
                            currency_code: 'USD'
                        },
                        description: 'Payment for Invoice #{{ invoice.invoiceId }}',
                        payment_amount: paymentAmount,
                        payment_type: window.getPaymentType()
                    }]
                });
            },

            // Handle approved transactions
            onApprove: function(data, actions) {
                console.log('PayPal onApprove triggered', data);
                // Show processing message
                const paypalContainer = document.getElementById('paypal-button-container');
                paypalContainer.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-spinner fa-spin me-2"></i>Processing your payment...</div>';

                // Set a timeout to handle cases where the capture process hangs
                const captureTimeout = setTimeout(function() {
                    console.log('PayPal capture timeout - proceeding with manual verification');
                    // If capture is taking too long, try to process with just the order ID
                    processPayPalPaymentManually(data.orderID);
                }, 10000); // 10 second timeout
                
                // Capture the funds
                console.log('Starting PayPal order capture...');
                try {
                    return actions.order.capture().then(function(orderData) {
                        // Clear the timeout since capture succeeded
                        clearTimeout(captureTimeout);
                        console.log('PayPal order captured successfully', orderData);
                        // Send the payment details to our server
                        // Get tip amount if available
                        let tipAmount = 0;
                        const tipInput = document.getElementById('hidden-tip-amount') || document.getElementById('manual-hidden-tip-amount');
                        if (tipInput && tipInput.value) {
                            tipAmount = parseFloat(tipInput.value) || 0;
                        }
                        
                        console.log('Sending payment details to server...', {
                            orderID: orderData.id,
                            invoiceId: '{{ invoice.invoiceId }}',
                            paymentAmount: window.getPaymentAmount(),
                            paymentType: window.getPaymentType(),
                            tipAmount: tipAmount
                        });
                        return fetch('{% url "invoice:process_paypal_payment" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                orderID: orderData.id,
                                invoiceId: '{{ invoice.invoiceId }}',
                                amount: window.getPaymentAmount(),
                                paymentType: window.getPaymentType(),
                                tipAmount: tipAmount
                            })
                        })
                    .then(response => {
                        console.log('Server response received', response);
                        if (!response.ok) {
                            console.error('Server response not OK', response.status, response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Server response parsed', data);
                        if (data.success) {
                            console.log('Payment successful, preparing to redirect');
                            // Show success message
                            paypalContainer.innerHTML = '<div class="alert alert-success text-center"><i class="fas fa-check-circle me-2"></i>Payment successful! Redirecting...</div>';

                            // Reload the page after a short delay
                            setTimeout(() => {
                                console.log('Reloading page...');
                                window.location.reload();
                            }, 2000);
                        } else {
                            console.error('Payment failed', data.error);
                            // Show error message
                            paypalContainer.innerHTML = `<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>${data.error || 'Payment processing failed. Please try again.'}</div>`;
                            // Log detailed error information
                            console.error('Payment failed with error:', data.error);
                            console.error('Payment failed with error details:', {
                                message: data.error.message,
                                stack: data.error.stack,
                                name: data.error.name
                            });
                            // Re-render the PayPal buttons after a delay
                            setTimeout(() => {
                                console.log('Initializing new PayPal buttons');
                                paypal.Buttons({
                                    // Re-initialize with the same options
                                    // This is a simplified version - in production you'd want to reuse the full configuration
                                }).render('#paypal-button-container');
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Payment processing error:', error);
                        paypalContainer.innerHTML = '<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>An error occurred while processing your payment. Please try again.</div>';

                        // Re-render the PayPal buttons after a delay
                        setTimeout(() => {
                            paypal.Buttons({
                                // Re-initialize with the same options
                            }).render('#paypal-button-container');
                        }, 3000);
                    });
                }).catch(function(error) {
                    // Clear the timeout since we got a response (even if it's an error)
                    clearTimeout(captureTimeout);
                    
                    console.error('Error during PayPal payment processing:', error);
                    
                    // Check if this is the specific 'Target window is closed' error
                    if (error && error.message && error.message.includes('Target window is closed')) {
                        console.log('Detected PayPal window closed error - attempting manual verification');
                        // This is a common error when the PayPal popup is closed but payment might have been processed
                        // Try to process with just the order ID
                        processPayPalPaymentManually(data.orderID);
                        return;
                    }
                    
                    // For other errors, show error message
                    paypalContainer.innerHTML = `<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>Payment processing failed. Please try again.</div>`;
                    // Log detailed error information
                    console.error('PayPal payment error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                });
                } catch (e) {
                    // Clear the timeout since we caught an exception
                    clearTimeout(captureTimeout);
                    
                    console.error('Exception during PayPal capture:', e);
                    // Try to process with just the order ID
                    processPayPalPaymentManually(data.orderID);
                }
            },

            // Handle errors
            onError: function(err) {
                console.error('PayPal error:', err);
                const paypalContainer = document.getElementById('paypal-button-container');
                paypalContainer.innerHTML = '<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>An error occurred with PayPal. Please try again.</div>';

                // Re-render the PayPal buttons after a delay
                setTimeout(() => {
                    paypal.Buttons({
                        // Re-initialize with the same options
                    }).render('#paypal-button-container');
                }, 3000);
            }
        }).render('#paypal-button-container');
        } else {
            console.error('PayPal SDK not loaded properly');
            // Display error message to user
            const paypalContainer = document.getElementById('paypal-button-container');
            if (paypalContainer) {
                paypalContainer.innerHTML = '<div class="alert alert-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>Unable to load PayPal checkout. Please refresh the page or try again later.</div>';
            }
        }
    });
</script>

{% endif %}


{% endblock %}
