{% extends 'customer/base.html' %}
{% load timezone_tags %}

{% block title %}Booking Details{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <!-- Header Card -->
        <div class="card border border-1 mb-4">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                    <div>
                        <h4 class="mb-1 text-primary">Booking #{{ booking.bookingId }}</h4>
                        <p class="text-muted mb-0">Created on <span data-utc-datetime="{{ booking.createdAt|date:'c' }}">{% convert_and_format booking.createdAt booking.business.timezone "F d, Y" %}</span></p>
                    </div>
                    {% if booking.cancelled_at %}
                    <div class="d-flex gap-2 mt-2 mt-sm-0">
                        <span class="badge bg-danger rounded-pill px-3 py-2">
                            <i class="fas fa-times me-1"></i>
                            Cancelled
                        </span>
                    </div>
                    {% else %}
                    <div class="d-flex gap-2 mt-2 mt-sm-0">
                        <span class="badge {% if booking.isCompleted %}bg-success{% else %}bg-warning text-dark{% endif %} rounded-pill px-3 py-2">
                            <i class="fas {% if booking.isCompleted %}fa-check{% else %}fa-clock{% endif %} me-1"></i>
                            {% if booking.isCompleted %}Completed{% else %}Pending{% endif %}
                        </span>
                        {% if booking.recurring %}
                        <span class="badge bg-info rounded-pill px-3 py-2">
                            <i class="fas fa-sync-alt me-1"></i>
                            {{ booking.get_recurring_display }}
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row g-3">
            <!-- Customer Info -->
            <div class="col-12 col-md-6 mb-md-4">
                <div class="card border border-1 h-100">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3 mb-md-4">
                            <div class="icon-circle bg-primary text-white me-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <h5 class="card-title mb-0">Customer Details</h5>
                        </div>
                        <div class="customer-info">
                            <p class="mb-2">
                                <i class="fas fa-user-circle text-muted me-2"></i>
                                {{ booking.customer.get_full_name }}
                            </p>
                            {% if booking.customer.company_name %}
                            <p class="mb-2">
                                <i class="fas fa-building text-muted me-2"></i>
                                {{ booking.customer.company_name }}
                            </p>
                            {% endif %}
                            <p class="mb-2">
                                <i class="fas fa-envelope text-muted me-2"></i>
                                <span class="text-break">{{ booking.customer.email }}</span>
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                {{ booking.customer.phone_number }}
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                <span class="text-break">{{ booking.customer.get_address }}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Info -->
            <div class="col-12 col-md-6 mb-md-4">
                <div class="card border border-1 h-100">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3 mb-md-4">
                            <div class="icon-circle bg-success text-white me-3">
                                <i class="fas fa-broom"></i>
                            </div>
                            <h5 class="card-title mb-0">Service Details</h5>
                        </div>
                        <div class="service-info">
                            <p class="mb-2">
                                <i class="fas fa-tag text-muted me-2"></i>
                                <span class="text-capitalize">{{ booking.get_serviceType_display }}</span>
                            </p>
                          
                                <p class="mb-2">
                                    <i class="fas fa-sync-alt text-muted me-2"></i>
                                    <span class="text-capitalize">{{ booking.get_recurring_display }} Service</span>
                                    {% if booking.next_recurring_date %}
                                    <span class="badge bg-info ms-2">Next: {{ booking.next_recurring_date|date:"M d, Y" }}</span>
                                    {% endif %}
                                </p>
                                {% if booking.parent_booking %}
                                <p class="mb-2">
                                    <i class="fas fa-project-diagram text-muted me-2"></i>
                                    <span>Part of recurring series</span>
                                    <a href="{% url 'customer:booking_detail' booking.parent_booking.bookingId %}" class="ms-2 small">View original booking</a>
                                </p>
                                {% endif %}
                                {% if booking.recurring_bookings.exists %}
                                <p class="mb-2">
                                    <i class="fas fa-calendar-alt text-muted me-2"></i>
                                    <span>Has {{ booking.recurring_bookings.count }} recurring booking(s)</span>
                                    <button class="btn btn-sm btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#recurringBookingsList">View</button>
                                </p>
                                <div class="collapse mt-2" id="recurringBookingsList">
                                    <div class="card card-body bg-light">
                                        <h6 class="mb-2">Recurring Bookings:</h6>
                                        <ul class="list-group list-group-flush">
                                            {% for rec_booking in booking.recurring_bookings.all %}
                                            <li class="list-group-item bg-transparent px-0 py-1">
                                                <a href="{% url 'customer:booking_detail' rec_booking.bookingId %}">
                                                    {{ rec_booking.bookingId }} - {{ rec_booking.cleaningDate|date:"M d, Y" }}
                                                </a>
                                                <span class="badge {% if rec_booking.isCompleted %}bg-success{% elif rec_booking.cancelled_at %}bg-danger{% else %}bg-warning text-dark{% endif %} ms-2">
                                                    {% if rec_booking.isCompleted %}Completed{% elif rec_booking.cancelled_at %}Cancelled{% else %}Pending{% endif %}
                                                </span>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                            <p class="mb-2">
                                <i class="fas fa-calendar text-muted me-2"></i>
                                <span>{{ booking.cleaningDate|date:"F d, Y" }}</span>
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-clock text-muted me-2"></i>
                                <span>{{ booking.startTime|to_timezone:user_timezone|date:"h:i A" }}</span> to 
                                <span>{{ booking.endTime|to_timezone:user_timezone|date:"h:i A" }}</span>
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-credit-card text-muted me-2"></i>
                                {{ booking.get_paymentMethod_display|default:"Payment method not specified" }}
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-dollar-sign text-muted me-2"></i>
                                <span class="h5 text-success mb-0">${{ booking.totalPrice }}</span>
                                {% if booking.tax %}
                                <small class="text-muted">(+${{ booking.tax }} tax)</small>
                                {% endif %}
                            </p>
                            {% if booking.tip and booking.tip > 0 %}
                            <p class="mb-2">
                                <i class="fas fa-hand-holding-usd text-muted me-2"></i>
                                <span class="h6 text-info mb-0">Tip: ${{ booking.tip }}</span>
                            </p>
                            {% endif %}
                            {% if booking.cleaner %}
                            <p class="mb-0">
                                <i class="fas fa-hand-holding-usd text-muted me-2"></i>
                                <span class="h6 text-primary mb-0">Cleaner Payout: ${{ booking.get_cleaner_payout|floatformat:2 }}</span>
                                <small class="text-muted">({{ booking.business.cleaner_payout_percentage }}% of total)</small>
                            </p>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

       

        <div class="row g-3">
            <!-- Property Info -->
            <div class="col-12 col-md-6 mb-md-4">
                <div class="card border border-1 h-100">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3 mb-md-4">
                            <div class="icon-circle bg-info text-white me-3">
                                <i class="fas fa-home"></i>
                            </div>
                            <h5 class="card-title mb-0">Property Details</h5>
                        </div>
                        <div class="row g-2 g-md-3">
                            <div class="col-4">
                                <div class="p-2 p-md-3 bg-light rounded text-center">
                                    <h3 class="mb-1 fs-4 fs-md-3">{{ booking.bedrooms }}</h3>
                                    <small class="text-muted d-block">Bedrooms</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 p-md-3 bg-light rounded text-center">
                                    <h3 class="mb-1 fs-4 fs-md-3">{{ booking.bathrooms }}</h3>
                                    <small class="text-muted d-block">Bathrooms</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 p-md-3 bg-light rounded text-center">
                                    <h3 class="mb-1 fs-4 fs-md-3">{{ booking.squareFeet }}</h3>
                                    <small class="text-muted d-block">Sq. Ft</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add-ons -->
            <div class="col-12 col-md-6 mb-md-4">
                <div class="card border border-1 h-100">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3 mb-md-4">
                            <div class="icon-circle bg-warning text-white me-3">
                                <i class="fas fa-plus"></i>
                            </div>
                            <h5 class="card-title mb-0">Add-on Services</h5>
                        </div>
                        <div class="row g-2 g-md-3">
                            {% if booking.addonDishes %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-utensils text-success me-2"></i>
                                    <span>Dishes {{booking.addonDishes}}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonLaundryLoads %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-tshirt text-success me-2"></i>
                                    <span>Laundry {{ booking.addonLaundryLoads }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonWindowCleaning %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-window-maximize text-success me-2"></i>
                                    <span>Windows - {{ booking.addonWindowCleaning }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonPetsCleaning %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-paw text-success me-2"></i>
                                    <span>Pets - {{ booking.addonPetsCleaning }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonFridgeCleaning %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-temperature-low text-success me-2"></i>
                                    <span>Fridge - {{ booking.addonFridgeCleaning }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonOvenCleaning %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-fire text-success me-2"></i>
                                    <span>Oven - {{ booking.addonOvenCleaning }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonBaseboard %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-border-style text-success me-2"></i>
                                    <span>Baseboards - {{ booking.addonBaseboard }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonBlinds %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-blinds text-success me-2"></i>
                                    <span>Blinds - {{ booking.addonBlinds }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonGreenCleaning %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-leaf text-success me-2"></i>
                                    <span>Green Cleaning - {{ booking.addonGreenCleaning }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonCabinetsCleaning %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-cabinet-filing text-success me-2"></i>
                                    <span>Cabinets - {{ booking.addonCabinetsCleaning }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonPatioSweeping %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-umbrella-beach text-success me-2"></i>
                                    <span>Patio - {{ booking.addonPatioSweeping }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if booking.addonGarageSweeping %}
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-warehouse text-success me-2"></i>
                                    <span>Garage - {{ booking.addonGarageSweeping }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        {% if booking.customAddons.exists %}
                        <div class="mt-3 mt-md-4">
                            <h6 class="mb-2 mb-md-3">Custom Add-ons:</h6>
                            <div class="row g-2 g-md-3">
                                {% for addon in booking.customAddons.all %}
                                <div class="col-12 col-sm-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-plus-circle text-success me-2"></i>
                                        <span>{{ addon.addon.addonName }} - {{ addon.qty }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        

        <!-- Special Requests -->
        <div class="card border border-1 mb-4">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex align-items-center mb-3 mb-md-4">
                    <div class="icon-circle bg-purple text-white me-3">
                        <i class="fas fa-comment-alt"></i>
                    </div>
                    <h5 class="card-title mb-0">Notes & Special Requests</h5>
                </div>
                {% if booking.otherRequests %}
                <p class="mb-0">{{ booking.otherRequests|linebreaks }}</p>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-sticky-note fa-2x mb-3"></i>
                    <p class="mb-0">No special requests or notes have been added for this booking.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Cleaner Info -->
        <div class="row g-3">
            <div class="col-12 mb-md-4">
                <div class="card border border-1">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3 mb-md-4">
                            <div class="icon-circle bg-info text-white me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <i class="fas fa-user-tie fa-lg"></i>
                            </div>
                            <h5 class="card-title mb-0">Assigned Cleaner</h5>
                        </div>
                        
                        {% if booking.cleaner %}
                        <div class="cleaner-info">
                            <div class="row g-3"> <!-- Added gutter spacing between cards -->
                                <!-- Name Card -->
                                <div class="col-12 col-sm-6 col-md-4">
                                    <div class="card bg-light border-0 border border-1 h-100">
                                        <div class="card-body text-center p-3 p-md-4">
                                            <i class="fas fa-user text-info fa-2x mb-3"></i>
                                            <h6 class="card-title mb-2"><strong>Name</strong></h6>
                                            <p class="card-text text-muted">{{ booking.cleaner.name }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Email Card -->
                                <div class="col-12 col-sm-6 col-md-4">
                                    <div class="card bg-light border-0 border border-1 h-100">
                                        <div class="card-body text-center p-3 p-md-4">
                                            <i class="fas fa-envelope text-info fa-2x mb-3"></i>
                                            <h6 class="card-title mb-2"><strong>Email</strong></h6>
                                            <p class="card-text text-muted text-break">{{ booking.cleaner.email }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Phone Number Card -->
                                {% if booking.cleaner.phoneNumber %}
                                <div class="col-12 col-sm-6 col-md-4">
                                    <div class="card bg-light border-0 border border-1 h-100">
                                        <div class="card-body text-center p-3 p-md-4">
                                            <i class="fas fa-phone text-info fa-2x mb-3"></i>
                                            <h6 class="card-title mb-2"><strong>Phone</strong></h6>
                                            <p class="card-text text-muted" id="cleanerPhoneNumber">{{ booking.cleaner.phoneNumber }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3 py-md-4">
                            <i class="fas fa-user-clock fa-3x mb-3 text-info"></i>
                            <p class="mb-0">No cleaner has been assigned to this booking yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Jobs Status and Timeline-->
         <div class="row g-3">
            <div class="col-6 mb-md-4">
                <div class="card border border-1 mb-4">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center justify-content-between mb-3 mb-md-4">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle bg-primary text-white me-3">
                                    <i class="fas fa-briefcase"></i>
                                </div>
                                <h5 class="card-title mb-0">Open Jobs Status</h5>
                            </div>
                         
                        </div>
                        {% with open_jobs=booking.openjob_set.all %}
                        {% if open_jobs %}
                        <ul class="list-group list-group-flush">
                            {% for job in open_jobs %}
                            <li class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-user-tag text-muted me-2"></i>
                                        <span>{{ job.cleaner.cleaner.name }}</span>
                                    </div>
                                    <span class="badge 
                                        {% if job.status == 'accepted' %}bg-success
                                        {% elif job.status == 'rejected' %}bg-danger
                                        {% elif job.status == 'pending' %}bg-warning text-dark
                                        {% else %}bg-secondary{% endif %} rounded-pill px-3 py-2">
                                        {{ job.get_status_display }}
                                    </span>
                                </div>
                                <div class="mt-2 text-muted small">
                                    <p class="mb-0">Sent: {{ job.createdAt|date:"F d, Y, h:i A" }}</p>
                                    {% if job.status != 'pending' %}
                                    <p class="mb-0">{{ job.get_status_display }} on: {{ job.updatedAt|date:"F d, Y, h:i A" }}</p>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p class="mb-0">No job offers have been sent out for this booking yet.</p>
                        </div>
                    {% endif %}
                    {% endwith %}
                    </div>

                </div>
            </div>
            <div class="col-6 mb-md-4">
                <!-- Timeline -->
                <div class="card border border-1 mb-4">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex align-items-center mb-3 mb-md-4">
                            <div class="icon-circle bg-secondary text-white me-3">
                                <i class="fas fa-history"></i>
                            </div>
                            <h5 class="card-title mb-0">Booking Timeline</h5>
                        </div>
                        <ul class="timeline">
                            {% if booking.createdAt %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-primary"><i class="fas fa-plus"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Booking Created</h6>
                                    <p class="mb-0 text-muted">{{ booking.createdAt|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.dayBeforeReminderSentAt %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-info"><i class="fas fa-bell"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Day-Before Reminder</h6>
                                    <p class="mb-0 text-muted">{{ booking.dayBeforeReminderSentAt|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.hourBeforeReminderSentAt %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-info"><i class="fas fa-bell"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Hour-Before Reminder</h6>
                                    <p class="mb-0 text-muted">{{ booking.hourBeforeReminderSentAt|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.arrival_confirmed_at %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-success"><i class="fas fa-check-circle"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Arrival Confirmed</h6>
                                    <p class="mb-0 text-muted">{{ booking.arrival_confirmed_at|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.arrived_at %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-success"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Cleaner Arrived</h6>
                                    <p class="mb-0 text-muted">{{ booking.arrived_at|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.completed_at %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-success"><i class="fas fa-check-double"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Booking Completed</h6>
                                    <p class="mb-0 text-muted">{{ booking.completed_at|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.postServiceFollowupSentAt %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-success"><i class="fas fa-bell"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Post Service Followup Sent</h6>
                                    <p class="mb-0 text-muted">{{ booking.postServiceFollowupSentAt|date:"F d, Y, h:i A" }}</p>
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.recurring != 'one-time' and booking.last_recurring_created_at %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-info"><i class="fas fa-sync-alt"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Recurring Booking Created</h6>
                                    <p class="mb-0 text-muted">{{ booking.last_recurring_created_at|date:"F d, Y, h:i A" }}</p>
                                    {% if booking.next_recurring_date %}
                                    <p class="mb-0 text-info">Next scheduled for: {{ booking.next_recurring_date|date:"F d, Y" }}</p>
                                    {% endif %}
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.rescheduled_at %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-warning"><i class="fas fa-calendar-alt"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Booking Rescheduled</h6>
                                    <p class="mb-0 text-muted">{{ booking.rescheduled_at|date:"F d, Y, h:i A" }}</p>
                                    {% if booking.rescheduled_reason %}
                                    <p class="mb-0 text-muted"><small>Reason: {{ booking.rescheduled_reason }}</small></p>
                                    {% endif %}
                                </div>
                            </li>
                            {% endif %}
                            
                            {% if booking.cancelled_at %}
                            <li class="timeline-item">
                                <div class="timeline-icon bg-danger"><i class="fas fa-times-circle"></i></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Booking Cancelled</h6>
                                    <p class="mb-0 text-muted">{{ booking.cancelled_at|date:"F d, Y, h:i A" }}</p>
                                    {% if booking.cancelled_reason %}
                                    <p class="mb-0 text-muted"><small>Reason: {{ booking.cancelled_reason }}</small></p>
                                    {% endif %}
                                </div>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reviews -->
        {% if booking.isCompleted %}
        <div class="card border border-1 mb-4">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex align-items-center mb-3 mb-md-4">
                    <div class="icon-circle bg-success text-white me-3">
                        <i class="fas fa-star"></i>
                    </div>
                    <h5 class="card-title mb-0">Customer Review</h5>
                </div>
                
                {% if booking.reviews.exists %}
                    {% for review in booking.reviews.all %}
                    <div class="review-card mb-3 p-3 bg-light rounded">
                        <div class="review-stars mb-2">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= review.rating %}
                                <i class="fas fa-star text-warning"></i>
                                {% else %}
                                <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="mb-2">{{ review.review }}</p>
                        <div class="d-flex justify-content-between">
                            <p class="review-date mb-0 text-muted"><small>Reviewed on {{ review.created_at|date:"F d, Y" }}</small></p>
                            <p class="review-author mb-0 text-muted"><small>By {{ review.user.get_full_name|default:review.user.username }}</small></p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-comment-alt fa-2x mb-3"></i>
                        <p class="mb-0">No reviews have been added for this booking yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Invoice -->
        <div class="card border border-1 mb-4">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex align-items-center mb-3 mb-md-4">
                    <div class="icon-circle bg-warning text-white me-3">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <h5 class="card-title mb-0">Related Invoice</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Invoice ID</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        {% if booking.invoice %}
                        <tbody>
                            <tr>
                                <td>
                                    <i class="fas fa-file-invoice text-muted me-2"></i>
                                    {{ booking.invoice.invoiceId }}
                                </td>
                                <td>
                                    <span class="fw-bold">${{ booking.invoice.amount }}</span>
                                </td>
                                <td>
                                    {% if booking.invoice.isPaid %}
                                    <span class="badge bg-success rounded-pill px-3">
                                        <i class="fas fa-check me-1"></i> Paid
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark rounded-pill px-3">
                                        <i class="fas fa-clock me-1"></i> Pending
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'invoice:invoice_detail' booking.invoice.invoiceId %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i> View Details
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                        {% else %}
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-file-invoice fa-2x mb-3"></i>
                                        <h6 class="mb-0">No invoice generated yet</h6>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card border border-1">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    {% if not booking.cancelled_at and not booking.isCompleted %}
                    <a href="{% url 'customer:edit_booking' booking.bookingId %}" 
                       class="btn btn-primary px-3 px-md-4">
                        <i class="fas fa-edit me-2"></i>Edit Booking
                    </a>
                    {% endif %}
                    {% if not booking.isCompleted and not booking.cancelled_at %}
                    <button type="button" class="btn btn-warning px-3 px-md-4" data-bs-toggle="modal" data-bs-target="#rescheduleBookingModal">
                        <i class="fas fa-calendar-alt me-2"></i>Reschedule
                    </button>
           
                    {% endif %}
          
                    {% if not booking.cancelled_at and not booking.isCompleted %}
                    <button type="button" class="btn btn-danger px-3 px-md-4" data-bs-toggle="modal" data-bs-target="#cancelBookingModal">
                        <i class="fas fa-ban me-2"></i>Cancel Booking
                    </button>
                    {% endif %}
                   
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Booking Modal -->
<div class="modal fade" id="rescheduleBookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>Reschedule Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rescheduleForm">
                    <!-- Current Booking Time -->
                    <div class="card mb-4 bg-light">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Current Schedule</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Current Date</label>
                                        <div class="form-control-plaintext">
                                            <i class="fas fa-calendar text-muted me-2"></i>
                                            <strong>{{ booking.cleaningDate|date:"F d, Y" }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Current Time</label>
                                        <div class="form-control-plaintext">
                                            <i class="fas fa-clock text-muted me-2"></i>
                                            <strong>{{ booking.startTime|to_timezone:user_timezone|date:"h:i A" }} to {{ booking.endTime|to_timezone:user_timezone|date:"h:i A" }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Booking Time -->
                    <h6 class="mb-3">New Schedule</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newCleaningDate" class="form-label">New Date</label>
                                <input type="date" class="form-control" id="newCleaningDate" name="newCleaningDate" required>
                            </div>
                        </div>
                        <div class="col-md-6" id="newTimeSlots">
                            <div class="mb-3">
                                <label class="form-label">New Time</label>
                                <div class="time-slots-container">
                                    <div class="time-slots-grid">
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-06-00" value="06:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-06-00">6:00 AM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-07-00" value="07:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-07-00">7:00 AM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-08-00" value="08:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-08-00">8:00 AM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-09-00" value="09:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-09-00">9:00 AM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-10-00" value="10:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-10-00">10:00 AM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-11-00" value="11:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-11-00">11:00 AM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-12-00" value="12:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-12-00">12:00 PM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-13-00" value="13:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-13-00">1:00 PM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-14-00" value="14:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-14-00">2:00 PM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-15-00" value="15:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-15-00">3:00 PM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-16-00" value="16:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-16-00">4:00 PM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-17-00" value="17:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-17-00">5:00 PM</label>
                                        </div>
                                        <div class="time-slot-item">
                                            <input type="radio" class="btn-check" name="newStartTime" id="time-18-00" value="18:00" autocomplete="off" required>
                                            <label class="btn btn-outline-primary" for="time-18-00">6:00 PM</label>
                                        </div>
                                    </div>
                                    <input type="hidden" id="newStartTimeValue" name="newStartTimeValue">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                   <!-- Availability Checking UI -->
                   <div class="col-12">
                        <div id="availability-alert" style="display: none;" class="alert mt-2">
                            <div id="availability-message"></div>
                        </div>
                        
                        <!-- Alternative slots suggestion -->
                        <div id="alternative-slots" style="display: none;" class="mt-3">
                            <h6 class="mb-2">Alternative Available Slots:</h6>
                            <div id="alt-slots-list" class="d-flex flex-wrap gap-2 mb-3"></div>
                        </div>
                        
                    </div>
                    
                    <div class="mb-3">
                        <label for="rescheduleReason" class="form-label">Reason for Rescheduling (Optional)</label>
                        <textarea class="form-control" id="rescheduleReason" name="rescheduleReason" rows="2" placeholder="Provide a reason for rescheduling"></textarea>
                    </div>
                    
                    <input type="hidden" id="bookingId" name="bookingId" value="{{ booking.bookingId }}">
                    <input type="hidden" id="businessTimezone" value="{{ booking.business.timezone }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              
                <button type="button" class="btn btn-warning" id="rescheduleBtn">
                    <i class="fas fa-calendar-check me-2"></i>Confirm Reschedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Booking Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-ban me-2"></i>Cancel Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cancelForm">

                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Cancellation <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reason" name="reason" rows="2" placeholder="Any additional information about this cancellation"></textarea>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Cancelling this booking may affect your business metrics and customer satisfaction. The customer will be notified of this cancellation.
                    </div>
                    
                    <input type="hidden" id="bookingIdCancel" name="bookingIdCancel" value="{{ booking.bookingId }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                    <i class="fas fa-ban me-2"></i>Confirm Cancellation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById("newCleaningDate");
        const today = new Date();
        today.setDate(today.getDate() + 1); // add 1 day (tomorrow)
        const tomorrow = today.toISOString().split("T")[0]; // format as YYYY-MM-DD
        dateInput.min = tomorrow;

        const newTimeSlots = document.getElementById("newTimeSlots");

        if (!dateInput.value) {
            newTimeSlots.style.display = "none";
        } else {
            newTimeSlots.style.display = "block";
        }
        
        // Function to handle reschedule form submission
        document.getElementById('rescheduleBtn').addEventListener('click', function() {
            const date = document.getElementById('newCleaningDate').value;
            // Get the selected time from the radio buttons
            const selectedTimeRadio = document.querySelector('input[name="newStartTime"]:checked');
            const time = selectedTimeRadio ? selectedTimeRadio.value : '';
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            if (!time) {
                alert('Please select a time slot');
                return;
            }
            
            // Proceed with the reschedule
            const bookingId = document.getElementById('bookingId').value;
            const reason = document.getElementById('rescheduleReason').value;
            const businessTimezone = document.getElementById('businessTimezone').value || 'UTC';
            
            // Show loading state
            const rescheduleBtn = document.getElementById('rescheduleBtn');
            const originalBtnText = rescheduleBtn.innerHTML;
            rescheduleBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
            rescheduleBtn.disabled = true;
            
            // Make API request to reschedule
            const url = '/booking/api/reschedule-booking/';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    booking_id: bookingId,
                    new_date_time: date + ' ' + time,
                    reason: reason,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message and reload page
                    alert('Booking rescheduled successfully!');
                    window.location.reload();
                } else {
                    // Show error message
                    alert(`Error: ${data.error || 'Failed to reschedule booking'}`); 
                    rescheduleBtn.innerHTML = originalBtnText;
                    rescheduleBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error rescheduling booking:', error);
                alert('Failed to reschedule booking. Please try again.');
                rescheduleBtn.innerHTML = originalBtnText;
                rescheduleBtn.disabled = false;
            });
        });
        
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Helper function to format date nicely
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        // Helper function to convert 12-hour time format to 24-hour format
        function convert12to24(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            
            if (hours === '12') {
                hours = '00';
            }
            
            if (modifier === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }
            
            // Convert hours to string before using padStart
            hours = String(hours).padStart(2, '0');
            
            return `${hours}:${minutes}`;
        }
        
        // Date input event listener
        document.getElementById('newCleaningDate').addEventListener('change', function() {
            const selectedDate = this.value;
            newTimeSlots.style.display = "block";
            if (selectedDate) {
                fetchAvailableTimeSlots(selectedDate);
            }
        });
        
        // Function to fetch available time slots for a selected date
        function fetchAvailableTimeSlots(date) {
            const businessId = "{{ booking.business.businessId }}";
            const url = `/api/fetch-available-slots/?date=${date}&businessId=${businessId}`;
            
            // Show loading state
            const timeSlotButtons = document.querySelectorAll('.time-slot-item label');
            timeSlotButtons.forEach(button => {
                button.classList.remove('btn-outline-primary', 'btn-success', 'btn-secondary');
                button.classList.add('btn-outline-secondary');
                button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${button.textContent}`;
            });
            
            // Disable all radio buttons during loading
            const timeSlotRadios = document.querySelectorAll('input[name="newStartTime"]');
            timeSlotRadios.forEach(radio => {
                radio.disabled = true;
                radio.checked = false;
            });
            
            // Clear any previous availability message and alternative slots
            const availabilityAlert = document.getElementById('availability-alert');
            const alternativeSlots = document.getElementById('alternative-slots');
            availabilityAlert.style.display = 'none';
            alternativeSlots.style.display = 'none';
            document.getElementById('alt-slots-list').innerHTML = '';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Update the UI with available time slots
                    data.time_slots.forEach(slot => {
                        const radioId = `time-${slot.value.replace(':', '-')}`;
                        const radio = document.getElementById(radioId);
                        const label = document.querySelector(`label[for="${radioId}"]`);
                        
                        if (radio && label) {
                            // Enable the radio button
                            radio.disabled = false;
                            
                            // Update the label styling based on availability
                            label.innerHTML = slot.label; // Remove spinner
                            
                            if (slot.available) {
                                label.classList.remove('btn-outline-secondary');
                                label.classList.add('btn-outline-primary');
                            } else {
                                label.classList.remove('btn-outline-secondary', 'btn-outline-primary');
                                label.classList.add('btn-secondary');
                                radio.disabled = true; // Disable unavailable slots
                                radio.style.display = "none";
                            }
                        }
                    });
                    
                    // Check if there are any available slots
                    const hasAvailableSlots = data.time_slots.some(slot => slot.available);
                    
                    if (!hasAvailableSlots) {
                        // Show message that no slots are available on this date
                        availabilityAlert.style.display = 'block';
                        availabilityAlert.className = 'alert alert-warning mt-2';
                        document.getElementById('availability-message').innerHTML = 
                            `<i class="fas fa-exclamation-triangle me-2"></i> No available time slots on this date. Please try another date.`;
                        
                        // Check if we have alternative dates
                        if (data.alternative_dates && data.alternative_dates.length > 0) {
                            // Show alternative dates
                            alternativeSlots.style.display = 'block';
                            const altSlotsList = document.getElementById('alt-slots-list');
                            altSlotsList.innerHTML = '';
                            
                            data.alternative_dates.forEach(altDate => {
                                // Create a button for each alternative date
                                const dateButton = document.createElement('button');
                                dateButton.className = 'btn btn-outline-success btn-sm';
                                dateButton.innerHTML = `<i class="fas fa-calendar-alt me-1"></i> ${formatDate(altDate)}`;
                                dateButton.type = 'button';
                                dateButton.addEventListener('click', () => {
                                    // Set the date input to this alternative date
                                    document.getElementById('newCleaningDate').value = altDate;
                                    // Fetch available slots for this date
                                    fetchAvailableTimeSlots(altDate);
                                });
                                
                                altSlotsList.appendChild(dateButton);
                            });
                        }
                    } else {
                        // Hide alternative slots if we have available slots
                        alternativeSlots.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching available time slots:', error);
                    
                    // Reset all buttons to default state
                    timeSlotButtons.forEach(button => {
                        const originalText = button.textContent.replace('Loading...', '');
                        button.innerHTML = originalText;
                        button.classList.remove('btn-outline-secondary');
                        button.classList.add('btn-outline-primary');
                    });
                    
                    // Enable all radio buttons
                    timeSlotRadios.forEach(radio => {
                        radio.disabled = false;
                    });
                    
                    // Show error message
                    availabilityAlert.style.display = 'block';
                    availabilityAlert.className = 'alert alert-danger mt-2';
                    document.getElementById('availability-message').innerHTML = 
                        `<i class="fas fa-exclamation-triangle me-2"></i> Error loading available time slots: ${error.message}`;
                });
        }
        
        // Add event listeners to all time slot radio buttons
        const timeSlotRadios = document.querySelectorAll('input[name="newStartTime"]');
        timeSlotRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Update the hidden input with the selected value
                document.getElementById('newStartTimeValue').value = this.value;
                
                // Show success message when a time slot is selected
                const availabilityAlert = document.getElementById('availability-alert');
                availabilityAlert.style.display = 'block';
                availabilityAlert.className = 'alert alert-success mt-2';
                document.getElementById('availability-message').innerHTML = 
                    `<i class="fas fa-check-circle me-2"></i> Time slot selected: ${document.querySelector(`label[for="${this.id}"]`).textContent}`;
                
                setTimeout(() => {
                    availabilityAlert.style.display = 'none';
                }, 3000);
            });
        });





        // Format customer phone numbers
        const customerPhoneNumbers = document.querySelectorAll('.customer-info p:has(.fa-phone)');
        customerPhoneNumbers.forEach(function(element) {
            const phoneNumber = element.textContent.trim();
            if (phoneNumber) {
                // Remove any existing formatting and +1 if present
                let cleanNumber = phoneNumber.replace(/\D/g, '');
                if (cleanNumber.startsWith('1')) {
                    cleanNumber = cleanNumber.substring(1);
                }
                // Format as +1 (555) 555-5555
                const formattedNumber = '+1 (' + cleanNumber.substring(0, 3) + ') ' + 
                                    cleanNumber.substring(3, 6) + '-' + 
                                    cleanNumber.substring(6, 10);
                element.innerHTML = '<i class="fas fa-phone text-muted me-2"></i>' + formattedNumber;
            }
        });

        // Format cleaner phone number using ID
        const cleanerPhoneElement = document.getElementById('cleanerPhoneNumber');
        if (cleanerPhoneElement) {
            const phoneNumber = cleanerPhoneElement.textContent.trim();
            if (phoneNumber) {
                // Remove any existing formatting and +1 if present
                let cleanNumber = phoneNumber.replace(/\D/g, '');
                if (cleanNumber.startsWith('1')) {
                    cleanNumber = cleanNumber.substring(1);
                }
                // Format as +1 (555) 555-5555
                const formattedNumber = '+1 (' + cleanNumber.substring(0, 3) + ') ' + 
                                    cleanNumber.substring(3, 6) + '-' + 
                                    cleanNumber.substring(6, 10);
                cleanerPhoneElement.textContent = formattedNumber;
            }
        }
        
        // Handle cancel reason dropdown change
        const cancelReason = document.getElementById('reason');
        
        
        // Handle cancel booking form submission
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        
        if (confirmCancelBtn) {
            confirmCancelBtn.addEventListener('click', function() {
                const bookingId = document.getElementById('bookingIdCancel').value;
                const cancelReason = document.getElementById('reason').value;
                
                // Validate form
                if (!cancelReason) {
                    alert('Please select a cancellation reason');
                    return;
                }
      
                
                // Show loading state
                const originalBtnText = confirmCancelBtn.innerHTML;
                confirmCancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
                confirmCancelBtn.disabled = true;
                
                // Prepare reason text
                let reasonText = cancelReason;
                
                // Make API request to cancel booking
                const url = '/booking/api/cancel-booking/';
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        booking_id: bookingId,
                        reason: reasonText,
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message and reload page
                        alert('Booking cancelled successfully!');
                        window.location.reload();
                    } else {
                        // Show error message
                        alert(`Error: ${data.message || 'Failed to cancel booking'}`);
                        confirmCancelBtn.innerHTML = originalBtnText;
                        confirmCancelBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error cancelling booking:', error);
                    alert('Failed to cancel booking. Please try again.');
                    confirmCancelBtn.innerHTML = originalBtnText;
                    confirmCancelBtn.disabled = false;
                });
            });
        }
    });
</script>
{% endblock %}

{% block styles %}
<style>
    /* Time slots styling */
    .time-slots-container {
        width: 100%;
        overflow-x: auto;
    }
    
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .time-slot-item {
        text-align: center;
    }
    
    .time-slot-item .btn {
        width: 100%;
        border-radius: 8px;
        font-size: 0.9rem;
        padding: 8px 0;
        transition: all 0.2s ease;
        position: relative;
    }
    
    /* Available time slot */
    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd;
        color: white;
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
        transform: translateY(-2px);
    }
    
    /* Unavailable time slot */
    .btn-secondary {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .btn-secondary:hover {
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* Loading state */
    .btn-outline-secondary {
        color: #6c757d;
        border-color: #6c757d;
    }
    
    /* Hover effect for available slots */
    .time-slot-item .btn-outline-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Availability indicator */
    .btn-outline-primary::after {
        content: '';
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #28a745;
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.9;
    }
    
    @media (max-width: 767.98px) {
        .time-slots-grid {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
        }
        
        .time-slot-item .btn {
            font-size: 0.8rem;
            padding: 6px 0;
        }
    }
    
    /* Timeline styling */
    .timeline {
        list-style: none;
        padding: 0;
        position: relative;
    }
    .timeline:before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 20px;
        width: 2px;
        background: #e9ecef;
    }
    .timeline-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        position: relative;
    }
    .timeline-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 1;
        flex-shrink: 0;
    }
    .timeline-content {
        margin-left: 20px;
        padding-top: 5px;
    }
</style>
<style>
    .icon-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .bg-purple {
        background-color: #6f42c1;
    }
    
    .customer-info p,
    .service-info p {
        font-size: 0.95rem;
    }
    
    .table th {
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    @media (max-width: 767.98px) {
        .icon-circle {
            width: 36px;
            height: 36px;
            font-size: 1rem;
        }
        
        .customer-info p,
        .service-info p {
            font-size: 0.9rem;
        }
        
        .table th,
        .table td {
            font-size: 0.85rem;
            padding: 0.5rem;
        }
        
        .fa-3x {
            font-size: 2em;
        }
        
        .fa-2x {
            font-size: 1.5em;
        }
        
        .badge {
            font-size: 0.7rem;
            padding: 0.35em 0.65em;
        }
        
        h5.card-title {
            font-size: 1.1rem;
        }
        
        .text-break {
            word-break: break-word;
        }
    }
</style>
{% endblock %}

