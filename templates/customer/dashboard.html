{% extends 'customer/base.html' %}
{% load timezone_tags %}
{% block title %}Dashboard{% endblock %}

{% block header_title %}Customer Dashboard{% endblock %}

{% block styles %}
<style>
    /* Dashboard specific styles */
    .dashboard-welcome {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        border-radius: 16px;
        padding: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
        box-shadow: 0 10px 20px rgba(37, 99, 235, 0.15);
    }
    
    .dashboard-welcome::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 100%;
        background-image: url('https://cdn.jsdelivr.net/gh/heroicons/heroicons@2.0.18/24/outline/sparkles.svg');
        background-repeat: space;
        background-size: 50px;
        opacity: 0.1;
    }
    
    .dashboard-welcome h2 {
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
    }
    
    .dashboard-welcome p {
        opacity: 0.9;
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .quick-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .quick-action-btn {
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        font-weight: 500;
        backdrop-filter: blur(5px);
    }
    
    .quick-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        color: white;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background-color: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .stat-primary {
        background-color: var(--primary-light);
        color: var(--primary-color);
    }
    
    .stat-success {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }
    
    .stat-warning {
        background-color: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }
    
    .stat-danger {
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }
    
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        color: var(--gray-color);
        font-size: 0.875rem;
    }
    
    .stat-change {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    .stat-change.positive {
        color: var(--success-color);
    }
    
    .stat-change.negative {
        color: var(--danger-color);
    }
    
    .booking-card {
        border-radius: 12px;
        border-left: 4px solid transparent;
        padding: 1.25rem;
        margin-bottom: 1rem;
        background-color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .booking-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .booking-card.confirmed {
        border-left-color: var(--success-color);
    }
    
    .booking-card.pending {
        border-left-color: var(--warning-color);
    }
    
    .booking-card.completed {
        border-left-color: var(--info-color);
    }
    
    .booking-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .booking-date {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .calendar-day {
        width: 50px;
        height: 50px;
        background-color: var(--primary-light);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
    }
    
    .calendar-month {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .calendar-number {
        font-size: 1.25rem;
        font-weight: 700;
    }
    
    .booking-info {
        display: flex;
        flex-direction: column;
    }
    
    .booking-time {
        font-size: 0.875rem;
        color: var(--gray-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .booking-service {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }
    
    .booking-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .booking-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .status-confirmed {
        background-color: var(--success-color);
    }
    
    .status-pending {
        background-color: var(--warning-color);
    }
    
    .status-completed {
        background-color: var(--info-color);
    }
    
    .invoice-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        border-radius: 12px;
        background-color: white;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .invoice-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    
    .invoice-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .invoice-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background-color: var(--primary-light);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .invoice-details {
        display: flex;
        flex-direction: column;
    }
    
    .invoice-id {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .invoice-date {
        font-size: 0.875rem;
        color: var(--gray-color);
    }
    
    .invoice-right {
        text-align: right;
    }
    
    .invoice-amount {
        font-weight: 700;
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }
    
    .invoice-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-paid {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }
    
    .status-pending {
        background-color: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }
    
    .status-overdue {
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .section-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background-color: var(--primary-light);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .empty-icon {
        font-size: 3rem;
        color: var(--gray-light);
        margin-bottom: 1rem;
    }
    
    .empty-title {
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--dark-color);
    }
    
    .empty-description {
        color: var(--gray-color);
        margin-bottom: 1.5rem;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: repeat(auto-fit, minmax(100%, 1fr));
        }
        
        .booking-header {
            flex-direction: column;
            gap: 1rem;
        }
        
        .booking-status {
            margin-top: 0.5rem;
        }
        
        .invoice-card {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .invoice-right {
            text-align: left;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    }
    
    /* Additional responsive styles can be added here */
</style>
{% endblock %}

{% block content %}
<!-- Welcome Section with Quick Actions -->
<div class="dashboard-welcome">
    <h2>Welcome back, {{ user.get_full_name }}!</h2>
    <p>Here's an overview of your cleaning services and account information.</p>
    <div class="quick-actions">
        <a href="{% url 'customer:businesses_list' %}" class="quick-action-btn">
            <i class="fas fa-broom"></i>
            <span>Book Cleaning</span>
        </a>
        <a href="{% url 'customer:bookings' %}" class="quick-action-btn">
            <i class="fas fa-calendar-check"></i>
            <span>View Bookings</span>
        </a>
        <a href="{% url 'invoice:all_invoices' %}" class="quick-action-btn">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Manage Invoices</span>
        </a>
        <a href="{% url 'customer:profile' %}" class="quick-action-btn">
            <i class="fas fa-user-cog"></i>
            <span>Update Profile</span>
        </a>
    </div>
</div>

<!-- Stats Overview -->
<div class="stats-container mt-5">
    <!-- Total Bookings Stat -->
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-primary">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-value">{{ upcoming_bookings|length }}</div>
        </div>
        
        <div class="stat-label">Upcoming Bookings</div>
        {% if upcoming_bookings %}
        <div class="stat-change positive">
            <i class="fas fa-arrow-up me-1"></i> Next: {{ upcoming_bookings.0.cleaningDate|date:"M d" }}
        </div>
        {% endif %}
    </div>
    
    <!-- Recent Invoices Stat -->
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-success">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="stat-value">{{ recent_invoices|length }}</div>
        </div>
        
        <div class="stat-label">Recent Invoices</div>
        {% if recent_invoices %}
        <div class="stat-change">
            <i class="fas fa-clock me-1"></i> Last: {{ recent_invoices.0.paidDate|date:"M d" }}
        </div>
        {% endif %}
    </div>
    
    <!-- Next Service Countdown -->
    {% if upcoming_bookings %}
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-warning">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="stat-value countdown-days" data-date="{{ upcoming_bookings.0.cleaningDate|date:'Y-m-d' }}">-</div>
        </div>
        
        <div class="stat-label">Days Until Next Service</div>
        <div class="stat-change">
            <i class="fas fa-calendar me-1"></i> {{ upcoming_bookings.0.cleaningDate|date:"l, F d" }}
        </div>
    </div>
    {% else %}
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-warning">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="stat-value">-</div>
        </div>
        
        <div class="stat-label">Days Until Next Service</div>
        <div class="stat-change">
            <i class="fas fa-calendar-plus me-1"></i> No upcoming services
        </div>
    </div>
    {% endif %}
</div>


<!-- Main Content Sections -->
<div class="row mt-5">
    <!-- Upcoming Bookings Section -->
    <div class="col-lg-8 mb-4">
        <div class="section-header">
            <div class="section-title">
                <div class="section-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <span>Upcoming Bookings</span>
            </div>
            <a href="{% url 'customer:bookings' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-external-link-alt me-1"></i> View All
            </a>
        </div>
        
        {% if upcoming_bookings %}
            <div class="booking-list">
                {% for booking in upcoming_bookings %}
                    {% with status=booking.isConfirmed|yesno:"confirmed,pending" %}
                    <div class="booking-card {{ status }}">
                        <div class="booking-header">
                            <div class="booking-date">
                                <div class="calendar-day">
                                    <span class="calendar-month">{{ booking.cleaningDate|date:"M" }}</span>
                                    <span class="calendar-number">{{ booking.cleaningDate|date:"d" }}</span>
                                </div>
                                <div class="booking-info">
                                    <div class="booking-service">{{ booking.get_serviceType_display }}</div>
                                    <div class="booking-time">
                                        <i class="fas fa-clock"></i>
                                        {% convert_and_format booking.startTime booking.cleaningDate booking.customer.timezone %} - 
                                        {% convert_and_format booking.endTime booking.cleaningDate booking.customer.timezone %}
                                    </div>
                                </div>
                          
                            </div>
                            <div class="booking-status">
                                <div class="status-indicator status-{{ status }}"></div>
                                <span>{{ booking.isConfirmed|yesno:"Confirmed,Pending" }}</span>
                            </div>
                        </div>
                        <div class="booking-actions">
                            <a href="{% url 'customer:booking_detail' booking.bookingId %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i> View Details
                            </a>
                          
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-alt empty-icon"></i>
                <h5 class="empty-title">No Upcoming Bookings</h5>
                <p class="empty-description">You don't have any upcoming cleaning services scheduled.</p>
                <a href="{% url 'customer:businesses_list' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> Book a Cleaning
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Recent Invoices Section -->    
    <div class="col-lg-4 mb-4">
        <div class="section-header">
            <div class="section-title">
                <div class="section-icon">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <span>Recent Invoices</span>
            </div>
            <a href="{% url 'invoice:all_invoices' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-external-link-alt me-1"></i> View All
            </a>
        </div>
        
        {% if recent_invoices %}
            <div class="invoice-list">
                {% for invoice in recent_invoices %}
                    {% with status=invoice.payment_details.status|default:"pending"|lower %}
                    <div class="invoice-card">
                        <div class="invoice-left">
                            <div class="invoice-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="invoice-details">
                                <div class="invoice-id">
                                    <a href="{% url 'invoice:invoice_preview' invoice.invoiceId %}">Invoice #{{ invoice.invoiceId }}</a>
                                </div>
                                <div class="invoice-date">{{ invoice.paidDate|date:"M d, Y" }}</div>
                            </div>
                        </div>
                        <div class="invoice-right">
                            <div class="invoice-amount">${{ invoice.amount }}</div>
                            <div class="invoice-status status-{{ status }}">
                                <i class="fas {% if status == 'paid' %}fa-check-circle{% elif status == 'overdue' %}fa-exclamation-circle{% else %}fa-clock{% endif %}"></i>
                                <span>{{ invoice.payment_details.status|default:"Pending"|title }}</span>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-file-invoice-dollar empty-icon"></i>
                <h5 class="empty-title">No Recent Invoices</h5>
                <p class="empty-description">You don't have any recent invoices.</p>
            </div>
        {% endif %}
    </div>


</div>

    <!-- Booking History Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="section-header">
            <div class="section-title">
                <div class="section-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Booking History</span>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div id="bookingHistoryChart" style="height: 250px;"></div>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate days until next service
        const countdownElements = document.querySelectorAll('.countdown-days');
        countdownElements.forEach(element => {
            const targetDate = element.getAttribute('data-date');
            if (targetDate) {
                const today = new Date();
                const serviceDate = new Date(targetDate);
                
                // Reset hours to compare just the dates
                today.setHours(0, 0, 0, 0);
                serviceDate.setHours(0, 0, 0, 0);
                
                const diffTime = serviceDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    element.textContent = 'Overdue';
                    element.style.color = 'var(--danger-color)';
                } else if (diffDays === 0) {
                    element.textContent = 'Today';
                    element.style.color = 'var(--success-color)';
                } else {
                    element.textContent = diffDays;
                }
            }
        });
        
        // Booking History Chart
        const bookingHistoryChartEl = document.getElementById('bookingHistoryChart');
        if (bookingHistoryChartEl) {
            // Show loading state
            bookingHistoryChartEl.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 250px"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            // Fetch booking history data from API
            fetch('/booking/api/booking-history-data/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Clear loading state
                    bookingHistoryChartEl.innerHTML = '';
                    
                    const options = {
                        series: [{
                            name: 'Bookings',
                            data: data.bookingCounts
                        }, {
                            name: 'Amount Paid',
                            data: data.paymentAmounts
                        }],
                        chart: {
                            height: 250,
                            type: 'line',
                            toolbar: {
                                show: false
                            },
                            fontFamily: 'Inter, sans-serif'
                        },
                        colors: ['var(--primary-color)', 'var(--success-color)'],
                        dataLabels: {
                            enabled: false
                        },
                        stroke: {
                            curve: 'smooth',
                            width: [3, 3]
                        },
                        grid: {
                            borderColor: 'var(--gray-light)',
                            row: {
                                colors: ['transparent']
                            }
                        },
                        markers: {
                            size: 4
                        },
                        xaxis: {
                            categories: data.months,
                            labels: {
                                style: {
                                    colors: 'var(--gray-color)',
                                    fontSize: '12px',
                                    fontFamily: 'Inter, sans-serif'
                                }
                            }
                        },
                        yaxis: [{
                            title: {
                                text: 'Bookings',
                                style: {
                                    color: 'var(--primary-color)',
                                    fontSize: '12px',
                                    fontFamily: 'Inter, sans-serif'
                                }
                            },
                            labels: {
                                style: {
                                    colors: 'var(--gray-color)',
                                    fontSize: '12px',
                                    fontFamily: 'Inter, sans-serif'
                                }
                            }
                        }, {
                            opposite: true,
                            title: {
                                text: 'Amount ($)',
                                style: {
                                    color: 'var(--success-color)',
                                    fontSize: '12px',
                                    fontFamily: 'Inter, sans-serif'
                                }
                            },
                            labels: {
                                style: {
                                    colors: 'var(--gray-color)',
                                    fontSize: '12px',
                                    fontFamily: 'Inter, sans-serif'
                                },
                                formatter: function(val) {
                                    return '$' + val;
                                }
                            }
                        }],
                        tooltip: {
                            theme: 'light',
                            y: [{
                                formatter: function(val) {
                                    return val + ' bookings';
                                }
                            }, {
                                formatter: function(val) {
                                    return '$' + val;
                                }
                            }]
                        },
                        legend: {
                            position: 'top',
                            horizontalAlign: 'right',
                            fontSize: '12px',
                            fontFamily: 'Inter, sans-serif',
                            offsetY: -10
                        },
                        noData: {
                            text: 'No booking history available',
                            align: 'center',
                            verticalAlign: 'middle',
                            style: {
                                color: 'var(--gray-color)',
                                fontSize: '16px',
                                fontFamily: 'Inter, sans-serif'
                            }
                        }
                    };
                    
                    const chart = new ApexCharts(bookingHistoryChartEl, options);
                    chart.render();
                })
                .catch(error => {
                    console.error('Error fetching booking history data:', error);
                    bookingHistoryChartEl.innerHTML = '<div class="text-center py-5"><i class="fas fa-exclamation-circle text-danger mb-3" style="font-size: 2rem;"></i><p>Failed to load booking history data</p></div>';
                });
        }
        
        // Function to handle reschedule modal
        window.showRescheduleModal = function(bookingId) {
            // In a real implementation, this would open a modal with a date/time picker
            // For now, we'll just show a toast notification
            window.showToast('Reschedule feature will be available soon!', 'info');
        }
        
        // Dark mode functionality has been removed
    });
</script>
{% endblock %}
