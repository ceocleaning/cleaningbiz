{% extends 'customer/base.html' %}
{% load timezone_tags %}

{% block title %}Edit Booking{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'customer:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'customer:bookings' %}">Bookings</a></li>
                <li class="breadcrumb-item active">Edit Booking</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Left Column - Booking Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="px-3 py-3"><i class="fas fa-edit me-2"></i>Update Booking</h2>
                
                <!-- Progress Bar -->
                <div class="px-3">
                    <div class="progress">
                        <div id="form-progress" class="progress-bar" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">20%</div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="step-indicator active" id="step1-indicator">Customer</span>
                        <span class="step-indicator" id="step2-indicator">Address</span>
                        <span class="step-indicator" id="step3-indicator">Service</span>
                        <span class="step-indicator" id="step4-indicator">Add-ons</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body px-4 py-4">
                <form id="booking-form" method="post" action="{% url 'customer:edit_booking' booking.bookingId %}" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <input type="hidden" id="subtotal" name="subtotal" value="{{ booking.subtotal|default:'0' }}" />
                    <input type="hidden" id="tax" name="tax" value="{{ booking.tax|default:'0' }}" />
                    <input type="hidden" id="totalAmount" name="totalAmount" value="{{ booking.totalAmount|default:'0' }}" />
                    <input type="hidden" id="appliedDiscountPercent" name="appliedDiscountPercent" value="{{ booking.appliedDiscountPercent|default:'0' }}" />
                    <input type="hidden" id="discountAmount" name="discountAmount" value="{{ booking.discountAmount|default:'0' }}" />
                   
                    <!-- Step 1: Customer Information -->
                    <div class="form-step" id="step1">
                        <h5 class="mb-4"><i class="fas fa-user me-2"></i>Customer Information</h5>
                        
                        <!-- Customer Information Fields -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" value="{{ booking.customer.first_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" value="{{ booking.customer.last_name }}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="john.doe@example.com" value="{{ booking.customer.email }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phoneNumber" class="form-label">Phone Number</label>
                                <div class="d-flex">
                                    <div class="input-group me-2" style="width: 150px;">
                                        <span class="input-group-text">+</span>
                                        <select class="form-select" id="countryCode" name="countryCode">
                                            <option value="1" selected>1</option>
                                        </select>
                                    </div>
                                    <input type="tel" 
                                        class="form-control" 
                                        id="phoneNumber" 
                                        name="phoneNumber" 
                                        placeholder="555 123 4567"
                                        pattern="^\d{3}[\s-]?\d{3}[\s-]?\d{4}$"
                                        title="Format: Area code and phone number (e.g., 555 123 4567)"
                                        value="{{ booking.customer.phone_number }}"
                                        required>
                                </div>
                            </div>
                            <small class="form-text text-muted">Select country code and enter your phone number</small>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 2: Address Information -->
                    <div class="form-step" id="step2" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-map-marker-alt me-2"></i>Address Information</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="address1" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address1" name="address1" placeholder="123 Main Street" value="{{ booking.customer.address }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="New York" value="{{ booking.customer.city }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="stateOrProvince" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="stateOrProvince" name="stateOrProvince" placeholder="NY" value="{{ booking.customer.state_or_province }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="zipCode" class="form-label">ZIP Code</label>
                                <input type="text" class="form-control" id="zipCode" name="zipCode" placeholder="10001" value="{{ booking.customer.zip_code }}" required>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 3: Service Details -->
                    <div class="form-step" id="step3" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-broom me-2"></i>Service Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="serviceType" class="form-label">Service Type</label>
                                <select class="form-control form-select" name="serviceType" id="serviceType" required>
                                    <option value="" disabled>Select a service type</option>
                                    <option {% if booking.serviceType == 'standard' %}selected{% endif %} value="standard">Standard Cleaning</option>
                                    <option {% if booking.serviceType == 'deep' %}selected{% endif %} value="deep">Deep Cleaning</option>
                                    <option {% if booking.serviceType == 'moveinmoveout' %}selected{% endif %} value="moveinmoveout">Move In/Move Out</option>
                                    <option {% if booking.serviceType == 'airbnb' %}selected{% endif %} value="airbnb">Airbnb Cleaning</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="recurring" class="form-label">Recurring Service</label>
                                <select class="form-control form-select" name="recurring" id="recurring">
                                    <option value="" disabled>Select frequency</option>
                                    <option {% if booking.recurring == 'one-time' %}selected{% endif %} value="one-time">One Time</option>
                                    <option {% if booking.recurring == 'weekly' %}selected{% endif %} value="weekly">Weekly</option>
                                    <option {% if booking.recurring == 'biweekly' %}selected{% endif %} value="biweekly">Bi-weekly</option>
                                    <option {% if booking.recurring == 'monthly' %}selected{% endif %} value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="bedrooms" class="form-label">Number of Bedrooms</label>
                                <input type="number" class="form-control property-input" id="bedrooms" name="bedrooms" min="0" placeholder="2" value="{{ booking.bedrooms }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="bathrooms" class="form-label">Number of Bathrooms</label>
                                <input type="number" class="form-control property-input" id="bathrooms" name="bathrooms" min="0" placeholder="1" value="{{ booking.bathrooms }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="squareFeet" class="form-label">Square Footage</label>
                                <input type="number" class="form-control property-input" id="squareFeet" name="squareFeet" min="100" placeholder="1000" value="{{ booking.squareFeet }}" required>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

   
                    <!-- Step 5: Add-on Services -->
                    <div class="form-step" id="step4" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-plus me-2"></i>Add-on Services</h5>
                        
                        <!-- Standard Add-ons -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="addonDishes" class="form-label">Dishes</label>
                                <input type="number" class="form-control addon-input" id="addonDishes" name="addonDishes" min="0" value="{{ booking.addonDishes|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonLaundryLoads" class="form-label">Laundry Loads</label>
                                <input type="number" class="form-control addon-input" id="addonLaundryLoads" name="addonLaundryLoads" min="0" value="{{ booking.addonLaundryLoads|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonWindowCleaning" class="form-label">Window Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonWindowCleaning" name="addonWindowCleaning" min="0" value="{{ booking.addonWindowCleaning|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonPetsCleaning" class="form-label">Pet Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonPetsCleaning" name="addonPetsCleaning" min="0" value="{{ booking.addonPetsCleaning|default:0 }}">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="addonFridgeCleaning" class="form-label">Fridge Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonFridgeCleaning" name="addonFridgeCleaning" min="0" value="{{ booking.addonFridgeCleaning|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonOvenCleaning" class="form-label">Oven Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonOvenCleaning" name="addonOvenCleaning" min="0" value="{{ booking.addonOvenCleaning|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonBaseboard" class="form-label">Baseboard</label>
                                <input type="number" class="form-control addon-input" id="addonBaseboard" name="addonBaseboard" min="0" value="{{ booking.addonBaseboard|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonBlinds" class="form-label">Blinds</label>
                                <input type="number" class="form-control addon-input" id="addonBlinds" name="addonBlinds" min="0" value="{{ booking.addonBlinds|default:0 }}">
                            </div>
                        </div>

                        <!-- Custom Add-ons -->
                        {% if customAddons %}
                        <h6 class="mb-3 mt-4"><i class="fas fa-star me-2"></i>Custom Add-ons</h6>
                        <div class="row">
                            {% for addon in customAddons %}
                            <div class="col-md-3 mb-3">
                                <label for="custom_addon_{{ addon.id }}" class="form-label">{{ addon.addonName }}</label>
                                <input type="number" class="form-control custom-addon-input" 
                                    id="custom_addon_{{ addon.id }}" 
                                    name="custom_addon_qty_{{ addon.id }}" 
                                    min="0" value="{{ addon.qty|default:0 }}"
                                    data-price="{{ addon.addonPrice }}">
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Access Information -->
                        <h6 class="mb-3 mt-4"><i class="fas fa-key me-2"></i>Access Information</h6>
                        <div class="mb-3">
                            <label class="form-label">Will someone be home during the cleaning?</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="someoneHomeYes" name="willSomeoneBeHome" value="yes" {% if booking.will_someone_be_home %}checked{% endif %}>
                                <label class="form-check-label" for="someoneHomeYes">
                                    Yes, someone will be home
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="someoneHomeNo" name="willSomeoneBeHome" value="no" {% if not booking.will_someone_be_home %}checked{% endif %}>
                                <label class="form-check-label" for="someoneHomeNo">
                                    I will hide the keys
                                </label>
                            </div>
                        </div>
                        <div class="mb-3" id="keyLocationContainer" style="display: {% if not booking.will_someone_be_home %}block{% else %}none{% endif %};">
                            <label for="keyLocation" class="form-label">Where will the keys be hidden? <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="keyLocation" name="keyLocation" value="{{ booking.key_location }}" placeholder="e.g., Under the mat, Code: 1234, etc.">
                            <small class="text-muted">Please provide the key code or location where the key is hidden</small>
                        </div>

                        <!-- Additional Information -->
                        <h6 class="mb-3 mt-4"><i class="fas fa-info-circle me-2"></i>Special Requests</h6>
                        <div class="mb-3">
                            <textarea class="form-control" id="otherRequests" name="otherRequests" rows="3" placeholder="Any special requests or notes?">{{ booking.otherRequests }}</textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="submit" class="btn btn-primary" id="submitBookingBtn">
                                <i class="fas fa-check me-2"></i>Update Booking
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column - Booking Summary -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Service Overview</h5>
            </div>
            <div class="card-body">

                <!-- Service Details -->
                <div class="mb-4">
                    <h6 class="text-muted mb-3">Service Details</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Service Type:</span>
                            <span class="fw-medium" id="overview-service">-</span>
                        </div>
                    </div>
                   
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Bedrooms:</span>
                            <span class="fw-medium" id="overview-bedrooms">-</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Bathrooms:</span>
                            <span class="fw-medium" id="overview-bathrooms">-</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Square Feet:</span>
                            <span class="fw-medium" id="overview-squarefeet">-</span>
                        </div>
                    </div>
                </div>

                <!-- Add-ons Summary -->
                <div class="mb-4">
                    <h6 class="text-muted mb-3">Add-ons</h6>
                    <div id="overview-addons-list">
                        <p class="text-muted small">No add-ons selected</p>
                    </div>
                </div>

                <!-- Pricing Summary -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="mb-3">Price Summary</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Base Price:</span>
                            <span class="fw-medium">$<span id="overview-base-price">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Add-ons:</span>
                            <span class="fw-medium">$<span id="overview-addons-price">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-medium">$<span id="overview-subtotal">0.00</span></span>
                        </div>
                        <div id="discount-row" class="d-flex justify-content-between mb-2" style="display: none;">
                            <span>Discount (<span id="overview-discount-percent">0</span>%):</span>
                            <span class="fw-medium text-success">-$<span id="overview-discount">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax ({{ business.settings.taxPercent }}%):</span>
                            <span class="fw-medium">$<span id="overview-tax">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between pt-2 border-top mt-2">
                            <span class="fw-bold">Total:</span>
                            <span class="fw-bold text-primary">$<span id="overview-total">0.00</span></span>
                        </div>
                    </div>
                    
                    <!-- Submit Button for Booking -->                
                    <div class="mt-4">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="rightColumnTermsCheck" required checked>
                            <label class="form-check-label small" for="rightColumnTermsCheck">
                                I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="rightColumnSubmitBtn" form="booking-form">
                            <i class="fas fa-check me-2"></i>Update Booking
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle access information toggle
        const someoneHomeYes = document.getElementById('someoneHomeYes');
        const someoneHomeNo = document.getElementById('someoneHomeNo');
        const keyLocationContainer = document.getElementById('keyLocationContainer');
        const keyLocationInput = document.getElementById('keyLocation');
        
        function toggleKeyLocation() {
            if (someoneHomeNo.checked) {
                keyLocationContainer.style.display = 'block';
                keyLocationInput.required = true;
            } else {
                keyLocationContainer.style.display = 'none';
                keyLocationInput.required = false;
            }
        }
        
        someoneHomeYes.addEventListener('change', toggleKeyLocation);
        someoneHomeNo.addEventListener('change', toggleKeyLocation);
        
        // Format phone number on page load
        const phoneInput = document.getElementById('phoneNumber');

        // Phone number formatting
        if (phoneInput) {
           
                let value = phoneInput.value.replace(/\D/g, '');
                
                // Format with spaces (North American format: XXX XXX XXXX)
                if (value.length > 0) {
                    // Area code (first 3 digits)
                    let formattedNumber = value.substring(0, 3);
                    
                    // First part of local number (next 3 digits)
                    if (value.length > 3) {
                        formattedNumber += ' ' + value.substring(3, 6);
                    }
                    
                    // Second part of local number (next 4 digits)
                    if (value.length > 6) {
                        formattedNumber += ' ' + value.substring(6, 10);
                    }
                    
                    phoneInput.value = formattedNumber;
                }
       
        }
      
        // Phone number formatting
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                // Remove all non-digit characters
                let value = this.value.replace(/\D/g, '');
                
                // Format with spaces (North American format: XXX XXX XXXX)
                if (value.length > 0) {
                    // Area code (first 3 digits)
                    let formattedNumber = value.substring(0, 3);
                    
                    // First part of local number (next 3 digits)
                    if (value.length > 3) {
                        formattedNumber += ' ' + value.substring(3, 6);
                    }
                    
                    // Second part of local number (next 4 digits)
                    if (value.length > 6) {
                        formattedNumber += ' ' + value.substring(6, 10);
                    }
                    
                    this.value = formattedNumber;
                }
            });
        }
        
        // Get pricing data from server
        const pricingData = JSON.parse('{{ prices|safe }}');
        
        // Base price from business settings
        const BASE_PRICE = pricingData.base_price || 0;
        
        // Pricing constants from business settings
        const BEDROOM_PRICE = pricingData.bedrooms || 0;
        const BATHROOM_PRICE = pricingData.bathrooms || 0;
        const SQUARE_FOOT_MULTIPLIERS = {
            'standard': pricingData.sqftMultiplierStandard || 0,
            'deep': pricingData.sqftMultiplierDeep || 0,
            'moveinout': pricingData.sqftMultiplierMoveinout || 0,
            'airbnb': pricingData.sqftMultiplierAirbnb || 0
        };
        
        const ADDON_PRICES = {
            'addonDishes': pricingData.addonPriceDishes || 0,
            'addonLaundryLoads': pricingData.addonPriceLaundry || 0,
            'addonWindowCleaning': pricingData.addonPriceWindow || 0,
            'addonPetsCleaning': pricingData.addonPricePets || 0,
            'addonFridgeCleaning': pricingData.addonPriceFridge || 0,
            'addonOvenCleaning': pricingData.addonPriceOven || 0,
            'addonBaseboard': pricingData.addonPriceBaseboard || 0,
            'addonBlinds': pricingData.addonPriceBlinds || 0
        };

        const RECURRING_DISCOUNTS = {
            'one-time': 0,
            'weekly': pricingData.weeklyDiscount || 0,
            'biweekly': pricingData.biweeklyDiscount || 0,
            'monthly': pricingData.monthlyDiscount || 0
        };
        
        const TAX_RATE = pricingData.tax ? (pricingData.tax / 100) : 0;


        // Form steps navigation
        const formSteps = document.querySelectorAll('.form-step');
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');
        const progressBar = document.getElementById('form-progress');
        const stepIndicators = document.querySelectorAll('.step-indicator');

        let currentStep = 0;
        
        // Initialize the form
        updateProgressBar();
        
        // Next button click handler
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    formSteps[currentStep].style.display = 'none';
                    currentStep++;
                    formSteps[currentStep].style.display = 'block';
                    updateProgressBar();
                    
                    // Scroll to top of the form
                    document.querySelector('.card-body').scrollTop = 0;
                }
            });
        });
        
        // Previous button click handler
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                formSteps[currentStep].style.display = 'none';
                currentStep--;
                formSteps[currentStep].style.display = 'block';
                updateProgressBar();
            });
        });
        
        // Update progress bar and step indicators
        function updateProgressBar() {
            // Calculate progress percentage
            const progress = ((currentStep + 1) / formSteps.length) * 100;
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = Math.round(progress) + '%';
            
            // Update step indicators
            stepIndicators.forEach((indicator, index) => {
                if (index === currentStep) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else if (index < currentStep) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            });
        }
    
        // Validate current step
        function validateStep(step) {
            const currentStepEl = formSteps[step];
            let isValid = true;
            
            // Normal validation for all steps
            const requiredFields = currentStepEl.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }
        
        // Real-time price calculation
        function calculatePrices() {
            // Get service type
            const serviceType = document.getElementById('serviceType').value;
            
            // Calculate base price with service type multiplier
            let basePrice = BASE_PRICE
            
            // Get property details
            const bedrooms = parseInt(document.getElementById('bedrooms').value) || 0;
            const bathrooms = parseInt(document.getElementById('bathrooms').value) || 0;
            const squareFeet = parseInt(document.getElementById('squareFeet').value) || 0;
            
            // Calculate property price
            const bedroomCost = bedrooms * BEDROOM_PRICE;
            const bathroomCost = bathrooms * BATHROOM_PRICE;
            const squareFeetCost = squareFeet * (SQUARE_FOOT_MULTIPLIERS[serviceType] || 0);
            const propertyPrice = bedroomCost + bathroomCost + squareFeetCost;
            
            // Calculate add-ons price
            let addonsPrice = 0;
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput) {
                    const quantity = parseInt(addonInput.value) || 0;
                    addonsPrice += quantity * ADDON_PRICES[addon];
                }
            });
            
            // Calculate custom add-ons price
            const customAddonInputs = document.querySelectorAll('.custom-addon-input');
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                addonsPrice += quantity * price;
            });
            
            // Calculate subtotal before discount
            const subtotalBeforeDiscount = basePrice + propertyPrice + addonsPrice;
            
            // Calculate discount based on recurring option
            const recurringType = document.getElementById('recurring').value;
            const discountPercent = RECURRING_DISCOUNTS[recurringType] || 0;
            const discountAmount = subtotalBeforeDiscount * (discountPercent / 100);
            
            // Apply discount to get final subtotal
            const subtotal = subtotalBeforeDiscount - discountAmount;
            
            // Calculate tax and total
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;
            
            // Update hidden inputs
            document.getElementById('subtotal').value = subtotal.toFixed(2);
            document.getElementById('tax').value = tax.toFixed(2);
            document.getElementById('totalAmount').value = total.toFixed(2);
            document.getElementById('appliedDiscountPercent').value = discountPercent.toFixed(2);
            document.getElementById('discountAmount').value = discountAmount.toFixed(2);
            
            // Update overview section
            document.getElementById('overview-service').textContent = document.getElementById('serviceType').options[document.getElementById('serviceType').selectedIndex].text;
            
         
            
            document.getElementById('overview-bedrooms').textContent = bedrooms;
            document.getElementById('overview-bathrooms').textContent = bathrooms;
            document.getElementById('overview-squarefeet').textContent = squareFeet + ' sq ft';
            
            // Update add-ons list
            const addonsList = document.getElementById('overview-addons-list');
            addonsList.innerHTML = '';
            
            let hasAddons = false;
            
            // Standard add-ons
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput && parseInt(addonInput.value) > 0) {
                    hasAddons = true;
                    const quantity = parseInt(addonInput.value);
                    const price = ADDON_PRICES[addon] * quantity;
                    const addonName = addonInput.previousElementSibling.textContent;
                    
                    const addonItem = document.createElement('div');
                    addonItem.className = 'd-flex justify-content-between mb-1';
                    addonItem.innerHTML = `
                        <span class="small">${addonName} (${quantity})</span>
                        <span class="small">$${price.toFixed(2)}</span>
                    `;
                    addonsList.appendChild(addonItem);
                }
            });
            
            // Custom add-ons
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    hasAddons = true;
                    const price = parseFloat(input.dataset.price) * quantity;
                    const addonName = input.previousElementSibling.textContent;
                    
                    const addonItem = document.createElement('div');
                    addonItem.className = 'd-flex justify-content-between mb-1';
                    addonItem.innerHTML = `
                        <span class="small">${addonName} (${quantity})</span>
                        <span class="small">$${price.toFixed(2)}</span>
                    `;
                    addonsList.appendChild(addonItem);
                }
            });
            
            if (!hasAddons) {
                addonsList.innerHTML = '<p class="text-muted small">No add-ons selected</p>';
            }
            
            // Update price overview
            document.getElementById('overview-base-price').textContent = (basePrice + propertyPrice).toFixed(2);
            document.getElementById('overview-addons-price').textContent = addonsPrice.toFixed(2);
            document.getElementById('overview-subtotal').textContent = subtotalBeforeDiscount.toFixed(2);
            
            // Show/hide discount row based on whether a discount is applied
            const discountRow = document.getElementById('discount-row');
            if (discountPercent > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('overview-discount-percent').textContent = discountPercent;
                document.getElementById('overview-discount').textContent = discountAmount.toFixed(2);
            } else {
                discountRow.style.display = 'none';
            }
            
            document.getElementById('overview-tax').textContent = tax.toFixed(2);
            document.getElementById('overview-total').textContent = total.toFixed(2);
            
            // Hidden inputs still needed for form submission
            // No need to update summary section elements as they've been removed
        }
        
        // Attach event listeners for real-time calculation
        document.getElementById('recurring').addEventListener('change', calculatePrices);
        document.getElementById('serviceType').addEventListener('change', calculatePrices);
        document.getElementById('bedrooms').addEventListener('input', calculatePrices);
        document.getElementById('bathrooms').addEventListener('input', calculatePrices);
        document.getElementById('squareFeet').addEventListener('input', calculatePrices);
        
        // Add-on inputs
        const addonInputs = document.querySelectorAll('.addon-input');
        addonInputs.forEach(input => {
            input.addEventListener('input', calculatePrices);
        });
        
        // Custom add-on inputs
        const customAddonInputs = document.querySelectorAll('.custom-addon-input');
        customAddonInputs.forEach(input => {
            input.addEventListener('input', calculatePrices);
        });
        

        // Initialize calculation
        calculatePrices();
        
        
        
        // Function to get user's timezone
        function getUserTimezone() {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                console.error('Error getting timezone:', e);
                return 'UTC';
            }
        }
        


    });
</script>

<style>
/* Step indicator styles */
.step-indicator {
    font-size: 0.85rem;
    color: #6c757d;
    position: relative;
    flex: 1;
    text-align: center;
}

.step-indicator.active {
    color: #0d6efd;
    font-weight: bold;
}

.step-indicator.completed {
    color: #198754;
}

/* Animation for step transitions */
.form-step {
    transition: all 0.3s ease;
}

/* Validation styling */
.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}
</style>

{% endblock %}