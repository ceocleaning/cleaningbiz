{% extends 'customer/base.html' %}
{% load timezone_tags %}

{% block title %}Edit Booking{% endblock %}
{% block header_title %}Edit Booking{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'customer:bookings' %}">My Bookings</a></li>
                <li class="breadcrumb-item active">Edit Booking</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Left Column - Booking Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="px-3 py-3"><i class="fas fa-edit me-2"></i>Edit Booking</h2>
                
                <!-- Progress Bar -->
                <div class="px-3">
                    <div class="progress">
                        <div id="form-progress" class="progress-bar" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">20%</div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="step-indicator active" id="step1-indicator">Customer</span>
                        <span class="step-indicator" id="step2-indicator">Address</span>
                        <span class="step-indicator" id="step3-indicator">Service</span>
                        <span class="step-indicator" id="step4-indicator">Property</span>
                        <span class="step-indicator" id="step5-indicator">Add-ons</span>
                        <span class="step-indicator" id="step6-indicator">Review</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body px-4 py-4">
                <form id="booking-form" method="post" class="needs-validation" novalidate action="{% url 'customer:edit_booking' booking.bookingId %}">
                {% csrf_token %}
                <input type="hidden" id="businessTimezone" name="businessTimezone" value="{{ business.timezone }}" />
                   
                  
                    <!-- Step 1: Customer Information -->
                    <div class="form-step" id="step1">
                        <h5 class="mb-4"><i class="fas fa-user me-2"></i>Customer Information</h5>
                        
                        {% if user.is_authenticated and user.customer %}
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="useMyInfo" name="useMyInfo">
                                <label class="form-check-label" for="useMyInfo">
                                    Use my information
                                </label>
                            </div>
                            <small class="text-muted">Check this box to use your profile information</small>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" value="{{ booking.customer.first_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" value="{{ booking.customer.last_name }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="john.doe@example.com" value="{{ booking.customer.email }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phoneNumber" class="form-label">Phone Number</label>
                                <div class="d-flex">
                                    <div class="input-group me-2" style="width: 150px;">
                                        <span class="input-group-text">+</span>
                                        <select class="form-select" id="countryCode" name="countryCode">
                                            <option value="1" selected>1 (US/CA)</option>
                                            <option value="44">44 (UK)</option>
                                            <option value="49">49 (DE)</option>
                                            <option value="61">61 (AU)</option>
                                            <option value="86">86 (CN)</option>
                                            <option value="91">91 (IN)</option>
                                            <option value="92">92 (PK)</option>
                                        </select>
                                    </div>
                                    <input type="tel" 
                                           class="form-control" 
                                           id="phoneNumber" 
                                           name="phoneNumber" 
                                           placeholder="555 123 4567"
                                           pattern="^\d{3}[\s-]?\d{3}[\s-]?\d{4}$"
                                           value="{{ booking.customer.phone_number|slice:"1:" }}"
                                           title="Format: Area code and phone number (e.g., 555 123 4567)"
                                           required>
                                </div>
                                <small class="form-text text-muted">Select country code and enter your phone number</small>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 2: Address Information -->
                    <div class="form-step" id="step2" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-map-marker-alt me-2"></i>Address Information</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="address1" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address1" name="address1" placeholder="123 Main Street" value="{{ booking.customer.address }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="New York" value="{{ booking.customer.city }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="stateOrProvince" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="stateOrProvince" name="stateOrProvince" placeholder="NY" value="{{ booking.customer.state_or_province }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="zipCode" class="form-label">ZIP Code</label>
                                <input type="text" class="form-control" id="zipCode" name="zipCode" placeholder="10001" value="{{ booking.customer.zip_code }}" required>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 3: Service Details -->
                    <div class="form-step" id="step3" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-broom me-2"></i>Service Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cleaningDate" class="form-label">Cleaning Date <small class="text-muted">({{ business.timezone }})</small></label>
                                <input type="date" class="form-control" id="cleaningDate" name="cleaningDate" required min="{{ today|date:'Y-m-d' }}" value="{{ booking.cleaningDate|date:'Y-m-d' }}">
                                <input type="hidden" id="businessTimezone" value="{{ business.timezone }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="startTime" class="form-label">Start Time <small class="text-muted">({{ business.timezone }})</small></label>
                                <input type="time" class="form-control" id="startTime" name="startTime" required value="{{ booking.startTime|time:'H:i' }}">
                                <small class="form-text text-muted">Select a time between 6:00 AM and 6:00 PM</small>
                            </div>
                            
                            <!-- Availability Checking UI -->
                            <div class="col-12">
                                <div id="availability-alert" style="display: none;" class="alert mt-2">
                                    <div id="availability-message"></div>
                                </div>
                                
                                <!-- Alternative slots suggestion -->
                                <div id="alternative-slots" style="display: none;" class="mt-3">
                                    <h6 class="mb-2">Alternative Available Slots:</h6>
                                    <div id="alt-slots-list" class="d-flex flex-wrap gap-2 mb-3"></div>
                                </div>
                                
                                <!-- Available cleaners selection -->
                                <div id="available-cleaners-container" style="display: none;" class="mt-3">
                                    <h6 class="mb-2">Select a Cleaner:</h6>
                                    <select id="selectedCleaner" name="selectedCleaner" class="form-select">
                                        <option value="">Select a cleaner</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="serviceType" class="form-label">Service Type</label>
                                <select class="form-control form-select" name="serviceType" id="serviceType" required>
                                    <option value="" disabled>Select a service type</option>
                                    <option value="standard" {% if booking.serviceType == 'standard' %}selected{% endif %}>Standard Cleaning</option>
                                    <option value="deep" {% if booking.serviceType == 'deep' %}selected{% endif %}>Deep Cleaning</option>
                                    <option value="moveinmoveout" {% if booking.serviceType == 'moveinmoveout' %}selected{% endif %}>Move In/Move Out</option>
                                    <option value="airbnb" {% if booking.serviceType == 'airbnb' %}selected{% endif %}>Airbnb Cleaning</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="recurring" class="form-label">Recurring Service</label>
                                <select class="form-control form-select" name="recurring" id="recurring">
                                    <option value="" disabled>Select frequency</option>
                                    <option value="one-time" {% if booking.recurring == 'one-time' %}selected{% endif %}>One Time</option>
                                    <option value="weekly" {% if booking.recurring == 'weekly' %}selected{% endif %}>Weekly</option>
                                    <option value="biweekly" {% if booking.recurring == 'biweekly' %}selected{% endif %}>Bi-weekly</option>
                                    <option value="monthly" {% if booking.recurring == 'monthly' %}selected{% endif %}>Monthly</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 4: Property Details -->
                    <div class="form-step" id="step4" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-home me-2"></i>Property Details</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="bedrooms" class="form-label">Number of Bedrooms</label>
                                <input type="number" class="form-control property-input" id="bedrooms" name="bedrooms" min="0" placeholder="2" value="{{ booking.bedrooms }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="bathrooms" class="form-label">Number of Bathrooms</label>
                                <input type="number" class="form-control property-input" id="bathrooms" name="bathrooms" min="0" placeholder="1" value="{{ booking.bathrooms }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="squareFeet" class="form-label">Square Footage</label>
                                <input type="number" class="form-control property-input" id="squareFeet" name="squareFeet" min="100" placeholder="1000" value="{{ booking.squareFeet }}" required>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 5: Add-on Services -->
                    <div class="form-step" id="step5" style="display: none;">
                        <h5 class="mb-4"><i class="fas fa-plus me-2"></i>Add-on Services</h5>
                        
                        <!-- Standard Add-ons -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="addonDishes" class="form-label">Dishes</label>
                                <input type="number" class="form-control addon-input" id="addonDishes" name="addonDishes" min="0" value="{{ booking.addonDishes|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonLaundryLoads" class="form-label">Laundry Loads</label>
                                <input type="number" class="form-control addon-input" id="addonLaundryLoads" name="addonLaundryLoads" min="0" value="{{ booking.addonLaundryLoads|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonWindowCleaning" class="form-label">Window Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonWindowCleaning" name="addonWindowCleaning" min="0" value="{{ booking.addonWindowCleaning|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonPetsCleaning" class="form-label">Pet Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonPetsCleaning" name="addonPetsCleaning" min="0" value="{{ booking.addonPetsCleaning|default:0 }}">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="addonFridgeCleaning" class="form-label">Fridge Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonFridgeCleaning" name="addonFridgeCleaning" min="0" value="{{ booking.addonFridgeCleaning|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonOvenCleaning" class="form-label">Oven Cleaning</label>
                                <input type="number" class="form-control addon-input" id="addonOvenCleaning" name="addonOvenCleaning" min="0" value="{{ booking.addonOvenCleaning|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonBaseboard" class="form-label">Baseboard</label>
                                <input type="number" class="form-control addon-input" id="addonBaseboard" name="addonBaseboard" min="0" value="{{ booking.addonBaseboard|default:0 }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="addonBlinds" class="form-label">Blinds</label>
                                <input type="number" class="form-control addon-input" id="addonBlinds" name="addonBlinds" min="0" value="{{ booking.addonBlinds|default:0 }}">
                            </div>
                        </div>

                        <!-- Custom Add-ons -->
                        {% if customAddons %}
                        <h6 class="mb-3 mt-4"><i class="fas fa-star me-2"></i>Custom Add-ons</h6>
                        <div class="row">
                            {% for addon in customAddons %}
                            <div class="col-md-3 mb-3">
                                <label for="custom_addon_{{ addon.id }}" class="form-label">{{ addon.addonName }}</label>
                                <input type="number" class="form-control custom-addon-input" 
                                    id="custom_addon_{{ addon.id }}" 
                                    name="custom_addon_qty_{{ addon.id }}" 
                                    min="0" value="0"
                                    data-price="{{ addon.addonPrice }}">
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Additional Information -->
                        <h6 class="mb-3 mt-4"><i class="fas fa-info-circle me-2"></i>Special Requests</h6>
                        <div class="mb-3">
                            <textarea class="form-control" id="otherRequests" name="otherRequests" rows="3" placeholder="Any special requests or notes?">{{ booking.otherRequests }}</textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left me-2"></i> Previous</button>
                            <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>

                    <!-- Step 6: Review and Submit -->
                    <div class="form-step" id="step6" style="display: none;">
                        <h4 class="mb-4 text-primary"><i class="fas fa-check-circle me-2"></i>Review Your Booking</h4>
                        
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0 fw-bold">Booking Summary</h5>
                            </div>
                            <div class="card-body p-4">
                                <!-- Customer Information Section -->
                                <div class="mb-4">
                                    <h6 class="text-muted text-uppercase small mb-3 border-bottom pb-2">Customer Information</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-user"></i></div>
                                                <div>
                                                    <div class="text-muted small">Customer Name</div>
                                                    <div class="fw-medium" id="summary-customer">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-envelope"></i></div>
                                                <div>
                                                    <div class="text-muted small">Email Address</div>
                                                    <div class="fw-medium" id="summary-email">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-phone"></i></div>
                                                <div>
                                                    <div class="text-muted small">Phone Number</div>
                                                    <div class="fw-medium" id="summary-phone">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-map-marker-alt"></i></div>
                                                <div>
                                                    <div class="text-muted small">Service Address</div>
                                                    <div class="fw-medium" id="summary-address">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Service Details Section -->
                                <div class="mb-4">
                                    <h6 class="text-muted text-uppercase small mb-3 border-bottom pb-2">Service Details</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-tools"></i></div>
                                                <div>
                                                    <div class="text-muted small">Service Type</div>
                                                    <div class="fw-medium" id="summary-service">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-calendar-alt"></i></div>
                                                <div>
                                                    <div class="text-muted small">Appointment</div>
                                                    <div class="fw-medium" id="summary-datetime">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-home"></i></div>
                                                <div>
                                                    <div class="text-muted small">Property Type</div>
                                                    <div class="fw-medium" id="summary-property">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-redo"></i></div>
                                                <div>
                                                    <div class="text-muted small">Recurring Schedule</div>
                                                    <div class="fw-medium" id="summary-recurring">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex">
                                                <div class="text-muted me-2"><i class="fas fa-plus-circle"></i></div>
                                                <div>
                                                    <div class="text-muted small">Selected Add-ons</div>
                                                    <div class="fw-medium" id="summary-addons">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pricing Section -->
                                <div>
                                    <h6 class="text-muted text-uppercase small mb-3 border-bottom pb-2">Pricing Details</h6>
                                    <div class="bg-light p-3 rounded">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Subtotal:</span>
                                            <input type="hidden" name="subtotal" step="1" id="subtotal">
                                            <span class="fw-bold text-primary">$<span id="summary-subtotal">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Tax:</span>
                                            <input type="hidden" name="tax" step="0.01" id="tax">
                                            <span class="fw-bold text-primary">$<span id="summary-tax">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between pt-2 border-top mt-2">
                                            <span class="fw-bold">Total:</span>
                                            <input type="hidden" name="totalAmount" id="totalAmount">
                                            <span class="fw-bold text-primary">$<span id="summary-total">0.00</span></span>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" checked type="checkbox" id="termsCheck" required>
                                        <label class="form-check-label small" for="termsCheck">
                                            I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary prev-step">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="submit" class="btn btn-primary px-4" id="confirmBookingBtn">
                                <i class="fas fa-check me-2"></i>Update Booking
                            </button>
                        </div>
                    </div>

<!-- Right Column - Booking Summary -->
</form>
</div>
</div>
</div>

<!-- Right Column - Booking Summary -->
<div class="col-lg-4">
    <div class="card sticky-top" style="top: 20px;">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Service Overview</h5>
        </div>
        <div class="card-body">
            <!-- Business Info -->
            <div class="mb-4">
                <h6 class="text-muted mb-3">Selected Business</h6>
                <div class="d-flex align-items-center mb-2">
                    <div class="flex-shrink-0">
                        <div class="bg-light rounded-circle p-2">
                            <i class="fas fa-building text-primary"></i>
                        </div>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">{{ business.businessName }}</h6>
                        <p class="text-muted small mb-0">{{ business.address }}</p>
                    </div>
                </div>
            </div>

            <!-- Service Details -->
            <div class="mb-4">
                <h6 class="text-muted mb-3">Service Details</h6>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Service Type:</span>
                        <span class="fw-medium" id="overview-service">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Date & Time:</span>
                        <span class="fw-medium" id="overview-datetime">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Bedrooms:</span>
                        <span class="fw-medium" id="overview-bedrooms">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Bathrooms:</span>
                        <span class="fw-medium" id="overview-bathrooms">-</span>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Square Feet:</span>
                        <span class="fw-medium" id="overview-squarefeet">-</span>
                    </div>
                </div>
            </div>

            <!-- Add-ons Summary -->
            <div class="mb-4">
                <h6 class="text-muted mb-3">Add-ons</h6>
                <div id="overview-addons-list">
                    <p class="text-muted small">No add-ons selected</p>
                </div>
            </div>

            <!-- Pricing Summary -->
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="mb-3">Price Summary</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Base Price:</span>
                        <span class="fw-medium">$<span id="overview-base-price">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Add-ons:</span>
                        <span class="fw-medium">$<span id="overview-addons-price">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-medium">$<span id="overview-subtotal">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax ({{ business.settings.taxPercent }}%):</span>
                        <span class="fw-medium">$<span id="overview-tax">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between pt-2 border-top mt-2">
                        <span class="fw-bold">Total:</span>
                        <span class="fw-bold text-primary">$<span id="overview-total">0.00</span></span>
                    </div>
                </div>
                
                <!-- Submit Button for Booking -->                
                <div class="mt-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rightColumnTermsCheck" required>
                        <label class="form-check-label small" for="rightColumnTermsCheck">
                            I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="submitBookingBtn" form="booking-form">
                        <i class="fas fa-check me-2"></i>Update Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Pre-select the start time from the existing booking
        const localTime = "{{ local_time }}";
        if (localTime) {
            $("#startTime").val(localTime);
        }
        
        // Get pricing data from server
        const pricingData = JSON.parse('{{ prices|safe }}');
        
        // Base price from business settings
        const BASE_PRICE = pricingData.base_price || 0;
        
        // Service type multipliers
        const SERVICE_MULTIPLIERS = {
            'standard': 1,
            'deep': 1.5,
            'moveinout': 2,
            'airbnb': 1.2
        };
        
        // Pricing constants from business settings
        const BEDROOM_PRICE = pricingData.bedrooms || 0;
        const BATHROOM_PRICE = pricingData.bathrooms || 0;
        const SQUARE_FOOT_MULTIPLIERS = {
            'standard': pricingData.sqftMultiplierStandard || 0,
            'deep': pricingData.sqftMultiplierDeep || 0,
            'moveinout': pricingData.sqftMultiplierMoveinout || 0,
            'airbnb': pricingData.sqftMultiplierAirbnb || 0
        };
        
        const ADDON_PRICES = {
            'addonDishes': pricingData.addonPriceDishes || 0,
            'addonLaundryLoads': pricingData.addonPriceLaundry || 0,
            'addonWindowCleaning': pricingData.addonPriceWindow || 0,
            'addonPetsCleaning': pricingData.addonPricePets || 0,
            'addonFridgeCleaning': pricingData.addonPriceFridge || 0,
            'addonOvenCleaning': pricingData.addonPriceOven || 0,
            'addonBaseboard': pricingData.addonPriceBaseboard || 0,
            'addonBlinds': pricingData.addonPriceBlinds || 0
        };
        
        const TAX_RATE = pricingData.tax ? (pricingData.tax / 100);
        
        // Form steps navigation
        const formSteps = document.querySelectorAll('.form-step');
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');
        const progressBar = document.getElementById('form-progress');
        const stepIndicators = document.querySelectorAll('.step-indicator');
        
        let currentStep = 0;
        
        // Initialize the form
        updateProgressBar();
        
        // Use My Info checkbox
        const useMyInfoCheckbox = document.getElementById('useMyInfo');
        if (useMyInfoCheckbox) {
            useMyInfoCheckbox.addEventListener('change', function() {
                const customerFields = [
                    {field: 'firstName', value: '{{ user.customer.first_name }}'},
                    {field: 'lastName', value: '{{ user.customer.last_name }}'},
                    {field: 'email', value: '{{ user.customer.email }}'},
                    {field: 'address1', value: '{{ user.customer.address }}'},
                    {field: 'city', value: '{{ user.customer.city }}'},
                    {field: 'stateOrProvince', value: '{{ user.customer.state_or_province }}'},
                    {field: 'zipCode', value: '{{ user.customer.zip_code }}'}
                ];
                const isChecked = this.checked;
                
                // Handle regular fields
                customerFields.forEach(item => {
                    const input = document.getElementById(item.field);
                    if (input) {
                        if (isChecked) {
                            input.value = item.value;
                            input.readOnly = true;
                        } else {
                            input.value = '';
                            input.readOnly = false;
                        }
                    }
                });
                
                // Handle phone number specially
                if (isChecked) {
                    const fullPhoneNumber = '{{ user.customer.phone_number }}';
                    if (fullPhoneNumber && fullPhoneNumber.startsWith('+')) {
                        // Extract country code
                        const commonCodes = ['1', '44', '49', '61', '86', '91', '92'];
                        let countryCode = '1'; // Default
                        let phoneNumberOnly = fullPhoneNumber.substring(1); // Remove the '+'
                        
                        // Try to match the country code
                        for (const code of commonCodes.sort((a, b) => b.length - a.length)) {
                            if (phoneNumberOnly.startsWith(code)) {
                                countryCode = code;
                                phoneNumberOnly = phoneNumberOnly.substring(code.length).trim();
                                break;
                            }
                        }
                        
                        // Set the values
                        document.getElementById('countryCode').value = countryCode;
                        document.getElementById('phoneNumber').value = phoneNumberOnly;
                        document.getElementById('phoneNumber').readOnly = true;
                    } else {
                        // If phone number doesn't start with +, just use it as is
                        document.getElementById('phoneNumber').value = fullPhoneNumber;
                        document.getElementById('phoneNumber').readOnly = true;
                    }
                } else {
                    document.getElementById('countryCode').value = '1'; // Reset to default
                    document.getElementById('phoneNumber').value = '';
                    document.getElementById('phoneNumber').readOnly = false;
                }
            });
        }
        
        // Next button click handler
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    formSteps[currentStep].style.display = 'none';
                    currentStep++;
                    formSteps[currentStep].style.display = 'block';
                    updateProgressBar();
                    
                    // Update summary if moving to the review step
                    if (currentStep === 5) { // Review step
                        updateSummary();
                    }
                    
                    // Scroll to top of the form
                    document.querySelector('.card-body').scrollTop = 0;
                }
            });
        });
        
        // Previous button click handler
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                formSteps[currentStep].style.display = 'none';
                currentStep--;
                formSteps[currentStep].style.display = 'block';
                updateProgressBar();
            });
        });
        
        // Update progress bar and step indicators
        function updateProgressBar() {
            const progress = ((currentStep + 1) / formSteps.length) * 100;
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            
            // Update step indicators
            stepIndicators.forEach((indicator, index) => {
                if (index === currentStep) {
                    indicator.classList.add('active');
                } else if (index < currentStep) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            });
        }
        
        // Validate current step
        function validateStep(step) {
            const currentStepEl = formSteps[step];
            const requiredFields = currentStepEl.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }
        
        // Real-time price calculation
        function calculatePrices() {
            // Get service type
            const serviceType = document.getElementById('serviceType').value;
            
            // Calculate base price with service type multiplier
            let basePrice = BASE_PRICE * (SERVICE_MULTIPLIERS[serviceType] || 1);
            
            // Get property details
            const bedrooms = parseInt(document.getElementById('bedrooms').value) || 0;
            const bathrooms = parseInt(document.getElementById('bathrooms').value) || 0;
            const squareFeet = parseInt(document.getElementById('squareFeet').value) || 0;
            
            // Calculate property price
            const bedroomCost = bedrooms * BEDROOM_PRICE;
            const bathroomCost = bathrooms * BATHROOM_PRICE;
            const squareFeetCost = squareFeet * (SQUARE_FOOT_MULTIPLIERS[serviceType] || 0);
            const propertyPrice = bedroomCost + bathroomCost + squareFeetCost;
            
            // Calculate add-ons price
            let addonsPrice = 0;
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput) {
                    const quantity = parseInt(addonInput.value) || 0;
                    addonsPrice += quantity * ADDON_PRICES[addon];
                }
            });
            
            // Calculate custom add-ons price
            const customAddonInputs = document.querySelectorAll('.custom-addon-input');
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                addonsPrice += quantity * price;
            });
            
            // Calculate subtotal, tax and total
            const subtotal = basePrice + propertyPrice + addonsPrice;
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;
            
            // Update hidden inputs
            document.getElementById('subtotal').value = subtotal.toFixed(2);
            document.getElementById('tax').value = tax.toFixed(2);
            document.getElementById('totalAmount').value = total.toFixed(2);
            
            // Update overview section
            document.getElementById('overview-service').textContent = document.getElementById('serviceType').options[document.getElementById('serviceType').selectedIndex].text;
            
            const cleaningDate = document.getElementById('cleaningDate').value;
            const startTime = document.getElementById('startTime').value;
            if (cleaningDate && startTime) {
                const dateObj = new Date(cleaningDate + 'T' + startTime);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };
                document.getElementById('overview-datetime').textContent = dateObj.toLocaleDateString('en-US', options);
            }
            
            document.getElementById('overview-bedrooms').textContent = bedrooms;
            document.getElementById('overview-bathrooms').textContent = bathrooms;
            document.getElementById('overview-squarefeet').textContent = squareFeet + ' sq ft';
            
            // Update add-ons list
            const addonsList = document.getElementById('overview-addons-list');
            addonsList.innerHTML = '';
            
            let hasAddons = false;
            
            // Standard add-ons
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput && parseInt(addonInput.value) > 0) {
                    hasAddons = true;
                    const quantity = parseInt(addonInput.value);
                    const price = ADDON_PRICES[addon] * quantity;
                    const addonName = addonInput.previousElementSibling.textContent;
                    
                    const addonItem = document.createElement('div');
                    addonItem.className = 'd-flex justify-content-between mb-1';
                    addonItem.innerHTML = `
                        <span class="small">${addonName} (${quantity})</span>
                        <span class="small">$${price.toFixed(2)}</span>
                    `;
                    addonsList.appendChild(addonItem);
                }
            });
            
            // Custom add-ons
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    hasAddons = true;
                    const price = parseFloat(input.dataset.price) * quantity;
                    const addonName = input.previousElementSibling.textContent;
                    
                    const addonItem = document.createElement('div');
                    addonItem.className = 'd-flex justify-content-between mb-1';
                    addonItem.innerHTML = `
                        <span class="small">${addonName} (${quantity})</span>
                        <span class="small">$${price.toFixed(2)}</span>
                    `;
                    addonsList.appendChild(addonItem);
                }
            });
            
            if (!hasAddons) {
                addonsList.innerHTML = '<p class="text-muted small">No add-ons selected</p>';
            }
            
            // Update price overview
            document.getElementById('overview-base-price').textContent = (basePrice + propertyPrice).toFixed(2);
            document.getElementById('overview-addons-price').textContent = addonsPrice.toFixed(2);
            document.getElementById('overview-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('overview-tax').textContent = tax.toFixed(2);
            document.getElementById('overview-total').textContent = total.toFixed(2);
            
            // Update summary section
            document.getElementById('summary-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('summary-tax').textContent = tax.toFixed(2);
            document.getElementById('summary-total').textContent = total.toFixed(2);
        }
        
        // Update booking summary for review step
        function updateSummary() {
            // Customer info
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            document.getElementById('summary-customer').textContent = `${firstName} ${lastName}`;
            document.getElementById('summary-email').textContent = document.getElementById('email').value;
            document.getElementById('summary-phone').textContent = document.getElementById('phoneNumber').value;
            
            // Address
            const address1 = document.getElementById('address1').value;
            const address2 = document.getElementById('address2').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('stateOrProvince').value;
            const zip = document.getElementById('zipCode').value;
            
            let fullAddress = `${address1}`;
            if (address2) fullAddress += `, ${address2}`;
            fullAddress += `, ${city}, ${state} ${zip}`;
            document.getElementById('summary-address').textContent = fullAddress;
            
            // Service details
            const serviceType = document.getElementById('serviceType');
            document.getElementById('summary-service').textContent = serviceType.options[serviceType.selectedIndex].text;
            
            // Date and time
            const cleaningDate = document.getElementById('cleaningDate').value;
            const startTime = document.getElementById('startTime').value;
            if (cleaningDate && startTime) {
                const dateObj = new Date(cleaningDate + 'T' + startTime);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };
                document.getElementById('summary-datetime').textContent = dateObj.toLocaleDateString('en-US', options);
            }
            
            // Property details
            const bedrooms = document.getElementById('bedrooms').value;
            const bathrooms = document.getElementById('bathrooms').value;
            const squareFeet = document.getElementById('squareFeet').value;
            document.getElementById('summary-property').textContent = `${bedrooms} Bedroom(s), ${bathrooms} Bathroom(s), ${squareFeet} sq ft`;
            
            // Recurring
            const recurring = document.getElementById('recurring');
            document.getElementById('summary-recurring').textContent = recurring.options[recurring.selectedIndex].text;
            
            // Add-ons
            const addonsList = [];
            
            // Standard add-ons
            Object.keys(ADDON_PRICES).forEach(addon => {
                const addonInput = document.getElementById(addon);
                if (addonInput && parseInt(addonInput.value) > 0) {
                    const quantity = parseInt(addonInput.value);
                    const addonName = addonInput.previousElementSibling.textContent;
                    addonsList.push(`${addonName} (${quantity})`);
                }
            });
            
            // Custom add-ons
            const customAddonInputs = document.querySelectorAll('.custom-addon-input');
            customAddonInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    const addonName = input.previousElementSibling.textContent;
                    addonsList.push(`${addonName} (${quantity})`);
                }
            });
            
            if (addonsList.length > 0) {
                document.getElementById('summary-addons').innerHTML = addonsList.map(addon => `<div>${addon}</div>`).join('');
            } else {
                document.getElementById('summary-addons').textContent = 'None';
            }
        }
        
        // Attach event listeners for real-time calculation
        document.getElementById('serviceType').addEventListener('change', calculatePrices);
        document.getElementById('bedrooms').addEventListener('input', calculatePrices);
        document.getElementById('bathrooms').addEventListener('input', calculatePrices);
        document.getElementById('squareFeet').addEventListener('input', calculatePrices);
        
        // Add-on inputs
        const addonInputs = document.querySelectorAll('.addon-input');
        addonInputs.forEach(input => {
            input.addEventListener('input', calculatePrices);
        });
        
        // Custom add-on inputs
        const customAddonInputs = document.querySelectorAll('.custom-addon-input');
        customAddonInputs.forEach(input => {
            input.addEventListener('input', calculatePrices);
        });
        
        // Date and time inputs
        document.getElementById('cleaningDate').addEventListener('change', function() {
            calculatePrices();
            checkAvailability();
        });
        document.getElementById('startTime').addEventListener('change', function() {
            calculatePrices();
            checkAvailability();
        });
        
        // Initialize calculation
        calculatePrices();
        
        // Check availability function
        function checkAvailability() {
            const date = document.getElementById('cleaningDate').value;
            const time = document.getElementById('startTime').value;
            const businessTimezone = document.getElementById('businessTimezone').value || 'UTC';
            const businessId = "{{ business.businessId }}";
            
            // Only check if both date and time are selected
            if (!date || !time) {
                return;
            }
            
            // Show loading state
            const availabilityAlert = document.getElementById('availability-alert');
            const availabilityMessage = document.getElementById('availability-message');
            const alternativeSlots = document.getElementById('alternative-slots');
            const altSlotsList = document.getElementById('alt-slots-list');
            const availableCleanersContainer = document.getElementById('available-cleaners-container');
            const selectedCleaner = document.getElementById('selectedCleaner');
            
            availabilityAlert.style.display = 'block';
            availabilityAlert.className = 'alert alert-info mt-2';
            availabilityMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Checking availability...';
            
            // Make API request with timezone information
            const url = `/api/check-availability/?date=${date}&time=${time}&timezone=${businessTimezone}&businessId=${businessId}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        // Show success message
                        availabilityAlert.className = 'alert alert-success mt-2';
                        availabilityMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> This timeslot is available!';
                        setTimeout(() => {
                            availabilityAlert.style.display = 'none';
                        }, 3000);
                        alternativeSlots.style.display = 'none';
                        availableCleanersContainer.style.display = 'block';
                        selectedCleaner.innerHTML = '<option value="">Select a cleaner</option>';
                        data.cleaners.forEach(cleaner => {
                            const option = document.createElement('option');
                            option.value = cleaner.id;
                            option.textContent = cleaner.name;
                            selectedCleaner.appendChild(option);
                        });
                    } else {
                        // Show error message
                        availabilityAlert.className = 'alert alert-danger mt-2';
                        availabilityMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> This timeslot is not available.';
                        
                        // Show alternative slots if any
                        if (data.alternative_slots && data.alternative_slots.length > 0) {
                            alternativeSlots.style.display = 'block';
                            altSlotsList.innerHTML = '';
                            
                            data.alternative_slots.forEach(slot => {
                                // Parse the slot string to get date and time
                                const slotParts = slot.split(' ');
                                const slotDate = slotParts[0];
                                const slotTime = slotParts[1] + ' ' + slotParts[2]; // e.g., "09:00 AM"
                                
                                // Create a button for each alternative slot
                                const slotButton = document.createElement('button');
                                slotButton.className = 'btn btn-outline-primary btn-sm';
                                slotButton.innerHTML = `<i class="fas fa-calendar-check me-1"></i> ${slotTime} on ${formatDate(slotDate)}`;
                                slotButton.type = 'button';
                                slotButton.addEventListener('click', () => {
                                    // Set the form fields to this slot
                                    document.getElementById('cleaningDate').value = slotDate;
                                    
                                    // Convert 12-hour format to 24-hour format for the select
                                    const timeValue = convert12to24(slotTime);
                                    document.getElementById('startTime').value = timeValue;
                                    
                                    // Trigger availability check
                                    checkAvailability();
                                });
                                
                                altSlotsList.appendChild(slotButton);
                            });
                        } else {
                            alternativeSlots.style.display = 'none';
                        }
                        availableCleanersContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error checking availability:', error);
                    availabilityAlert.className = 'alert alert-warning mt-2';
                    availabilityMessage.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> Could not check availability. Please try again.';
                });
        }
        
        // Helper function to format date nicely
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        // Helper function to convert 12-hour time format to 24-hour format
        function convert12to24(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            
            if (hours === '12') {
                hours = '00';
            }
            
            if (modifier === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }
            
            // Convert hours to string before using padStart
            hours = String(hours).padStart(2, '0');
            
            return `${hours}:${minutes}`;
        }
        
        // Phone number formatting
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                // Remove all non-digit characters
                let value = this.value.replace(/\D/g, '');
                
                // Format with spaces (North American format: XXX XXX XXXX)
                if (value.length > 0) {
                    // Area code (first 3 digits)
                    let formattedNumber = value.substring(0, 3);
                    
                    // First part of local number (next 3 digits)
                    if (value.length > 3) {
                        formattedNumber += ' ' + value.substring(3, 6);
                    }
                    
                    // Second part of local number (next 4 digits)
                    if (value.length > 6) {
                        formattedNumber += ' ' + value.substring(6, 10);
                    }
                    
                    this.value = formattedNumber;
                }
            });
        }
    });
</script>
{% endblock %}

