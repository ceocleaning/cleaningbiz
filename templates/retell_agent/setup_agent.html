{% extends "base.html" %}

{% block title %}Setup AI Voice Agent{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Setup AI Voice Agent</h3>
                    <a href="{% url 'list_retell_agents' %}" class="btn btn-outline-primary btn-sm">View All Agents</a>
                </div>
                <div class="card-body">
                    <form method="POST" action="{% url 'setup_retell_agent' %}">
                        {% csrf_token %}

                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">Agent Settings</h5>

                            <div class="mb-3">
                                <label for="agent_name" class="form-label">Agent Name</label>
                                <input type="text" class="form-control" id="agent_name" name="agent_name" required placeholder="e.g., Jarvis">
                                <div class="form-text">Give your AI agent a name</div>
                            </div>

                            {% if llm_id %}
                            <div class="mb-3">
                                <label for="llm_id" class="form-label">LLM ID</label>
                                <input type="text" class="form-control" id="llm_id" name="llm_id" required value="{{ llm_id }}" readonly>
                                <div class="form-text">
                                    {% if existing_llm %}
                                    Using existing LLM ({{ existing_llm.model }})
                                    {% if existing_llm.general_prompt %}
                                    <button class="btn btn-link p-0 ms-2 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#llmDetails">
                                        <small>View details</small>
                                    </button>
                                    <div class="collapse mt-2" id="llmDetails">
                                        <div class="card card-body bg-light">
                                            <small class="text-muted">{{ existing_llm.general_prompt|truncatechars:200 }}</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    Using pre-configured LLM
                                    {% endif %}
                                </div>
                            </div>
                            {% elif existing_llm %}
                            <div class="mb-3">
                                <label for="llm_id" class="form-label">LLM ID</label>
                                <input type="text" class="form-control" id="llm_id" name="llm_id" required value="{{ existing_llm.llm_id }}" readonly>
                                <div class="form-text">
                                    Using existing LLM ({{ existing_llm.model }})
                                    {% if existing_llm.general_prompt %}
                                    <button class="btn btn-link p-0 ms-2 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#llmDetails">
                                        <small>View details</small>
                                    </button>
                                    <div class="collapse mt-2" id="llmDetails">
                                        <div class="card card-body bg-light">
                                            <small class="text-muted">{{ existing_llm.general_prompt|truncatechars:200 }}</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <div class="mb-3 text-center py-3">
                                <p>You need to create an LLM engine first</p>
                                <a href="{% url 'create_retell_llm' %}" class="btn btn-primary">Create LLM Engine</a>
                            </div>
                            {% endif %}
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="voice_model" class="form-label">Voice Model</label>
                                    <select class="form-select" id="voice_model" name="voice_model">
                                    </select>
                                    <div class="form-text" id="voice_model_help">Choose a voice model to filter compatible voices</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="voice_id" class="form-label">Voice</label>
                                    <div class="input-group mb-2">
                                        <select class="form-select" id="voice_id" name="voice_id">
                                            <option value="" disabled selected>Select a voice model first...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="loadVoicesBtn" title="Refresh voices">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    <div id="voicePreviewCard" class="card mt-2 d-none">
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <span id="selectedVoiceName" class="fw-bold"></span>
                                                    <small class="d-block text-muted" id="voiceDetails"></small>
                                                </div>
                                                <div class="ms-auto">
                                                    <audio id="voicePreview" controls style="height: 40px;"></audio>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text">Choose a voice for your agent</div>
                                </div>
                            </div>
                        </div>

                        {% if llm_id or existing_llm %}
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Create Agent</button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM Loaded. Initializing script...');

    // --- CONFIGURATION ---
    const voiceModelCompatibility = {
        "elevenlabs": {
            displayName: "ElevenLabs",
            models: [
                { value: "eleven_turbo_v2", displayName: "ElevenLabs Turbo v2" },
                { value: "eleven_multilingual_v2", displayName: "ElevenLabs Multilingual v2" }
            ]
        },
        "openai": {
            displayName: "OpenAI",
            models: [
                { value: "openai_tts", displayName: "OpenAI TTS" }
            ]
        },
      
        "cartesia": {
            displayName: "Cartesia",
            models: [
                { value: "cartesia", displayName: "Cartesia Sonic" }
            ]
        }
    };

    // --- DOM ELEMENTS ---
    const modelSelect = document.getElementById('voice_model');
    const voiceSelect = document.getElementById('voice_id');
    const loadVoicesBtn = document.getElementById('loadVoicesBtn');
    const voicePreviewCard = document.getElementById('voicePreviewCard');
    const voicePreviewAudio = document.getElementById('voicePreview');
    const voiceNameElement = document.getElementById('selectedVoiceName');
    const voiceDetailsElement = document.getElementById('voiceDetails');

    if (!modelSelect || !voiceSelect) {
        console.error('❌ Critical Error: Could not find model or voice select elements on the page.');
        return;
    }

    // --- STATE ---
    let allVoicesData = [];

    // --- INITIALIZATION ---
    populateInitialModels();
    loadVoices();

    // --- EVENT LISTENERS ---
    console.log('Attaching event listener to voice model dropdown...');
    modelSelect.addEventListener('change', loadVoices); // Changed from updateVoiceOptions to loadVoices
    voiceSelect.addEventListener('change', updateVoicePreview);
    loadVoicesBtn.addEventListener('click', loadVoices);

    function populateInitialModels() {
        modelSelect.innerHTML = '';
        for (const providerPrefix in voiceModelCompatibility) {
            const providerConfig = voiceModelCompatibility[providerPrefix];
            const optGroup = document.createElement('optgroup');
            optGroup.label = providerConfig.displayName;
            providerConfig.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.displayName;
                option.dataset.providerPrefix = providerPrefix; // Store provider prefix here
                optGroup.appendChild(option);
            });
            modelSelect.appendChild(optGroup);
        }
        console.log('🎙️ Voice models populated.');
    }
    
    function loadVoices() {
        console.log('⏳ Fetching voices from API...');
        loadVoicesBtn.disabled = true;
        voiceSelect.innerHTML = '<option disabled selected>Loading voices...</option>';

        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        const providerPrefix = selectedOption ? selectedOption.dataset.providerPrefix : null;
        
        let url = '/voice_agent/list-voices/';
        if (providerPrefix) {
            url += `?provider=${providerPrefix}`;
        }
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok (Status: ${response.status})`);
                return response.json();
            })
            .then(data => {
                allVoicesData = data;
               
                
                console.log(`✅ API call successful. ${allVoicesData.length} voices loaded into cache.`);
                updateVoiceOptions();
            })
            .catch(error => {
                console.error('❌ API call failed:', error);
                voiceSelect.innerHTML = '<option disabled selected>Error loading voices</option>';
            })
            .finally(() => {
                loadVoicesBtn.disabled = false;
            });
    }

    function updateVoiceOptions() {
        const selectedModel = modelSelect.value;
        console.log(`🔄 Model changed to: "${selectedModel}". Updating voice options...`);
        
        if (!selectedModel || allVoicesData.length === 0) {
            voiceSelect.innerHTML = '<option disabled selected>Select a voice model</option>';
            return;
        }

        const optionsHTML = allVoicesData
            .sort((a, b) => a.voice_name.localeCompare(b.voice_name))
            .map(voice => {
                const voiceName = voice.voice_name || 'Unnamed';
                const gender = voice.gender || 'N/A';
                
                return `<option value="${voice.voice_id}" 
                            data-preview-url="${voice.preview_audio_url || ''}"
                            data-accent="${voice.accent || ''}"
                            data-gender="${voice.gender || ''}"
                            data-age="${voice.age || ''}">
                            ${voiceName} (${gender})
                        </option>`;
            })
            .join('');

        voiceSelect.innerHTML = optionsHTML;
        console.log('✅ Dropdown updated using innerHTML method.');

        voiceSelect.dispatchEvent(new Event('change'));
    }

    function updateVoicePreview() {
        const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
        if (selectedOption && selectedOption.dataset.previewUrl) {
            voicePreviewCard.classList.remove('d-none');
            voicePreviewAudio.src = selectedOption.dataset.previewUrl;
            voiceNameElement.textContent = selectedOption.text;
            let detailsText = [selectedOption.dataset.accent, selectedOption.dataset.age].filter(Boolean).join(' • ');
            voiceDetailsElement.textContent = detailsText;
        } else {
            voicePreviewCard.classList.add('d-none');
            voicePreviewAudio.src = '';
        }
    }
});
</script>

{% endblock %}